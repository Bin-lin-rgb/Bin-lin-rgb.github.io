<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Zapæ—¥å¿—åº“ | Blaine&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="å‰è¨€ zap çš„ä½¿ç”¨ã€‚ å®‰è£… è¿è¡Œä¸‹é¢çš„å‘½ä»¤å®‰è£…zap go get -u go.uber.org/zap å®ç° logger.go æ–‡ä»¶ å…ˆåœ¨ logger ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶ å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š package Logger import ( &#34;github.com/gin-gonic/gin&#34; &#34;go.uber.org/zap&#34; &#34;go.uber.org/zap/zapcore&#34; &#34;gopkg.in/natefinch/lumberjack.v2&#34; &#34;net&#34; &#34;net/http&#34; &#34;net/http/httputil&#34; &#34;os&#34; &#34;runtime/debug&#34; &#34;server/Config&#34; &#34;strings&#34; &#34;time&#34; ) var lg *zap.Logger // InitLogger åˆå§‹åŒ–Logger func InitLogger(cfg *Config.LogConfig) (err error) { writeSyncer := getLogWriter(cfg.Filename, cfg.MaxSize, cfg.MaxBackups, cfg.MaxAge) encoder := getEncoder() var l = new(zapcore.Level) err = l.UnmarshalText([]byte(cfg.Level)) if err != nil { return } core := zapcore.NewCore(encoder, writeSyncer, l) lg = zap.New(core, zap.AddCaller()) zap.ReplaceGlobals(lg) // æ›¿æ¢zapåŒ…ä¸­å…¨å±€çš„loggerå®ä¾‹ï¼Œåç»­åœ¨">
<meta name="author" content="Blaine">
<link rel="canonical" href="https://Bin-lin-rgb.github.io/posts/go/zap%E6%97%A5%E5%BF%97%E5%BA%93/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://Bin-lin-rgb.github.io/img/icon.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://Bin-lin-rgb.github.io/img/icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://Bin-lin-rgb.github.io/img/icon.png">
<link rel="apple-touch-icon" href="https://Bin-lin-rgb.github.io/img/icon.png">
<link rel="mask-icon" href="https://Bin-lin-rgb.github.io/img/icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script defer src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="Zapæ—¥å¿—åº“" />
<meta property="og:description" content="å‰è¨€ zap çš„ä½¿ç”¨ã€‚ å®‰è£… è¿è¡Œä¸‹é¢çš„å‘½ä»¤å®‰è£…zap go get -u go.uber.org/zap å®ç° logger.go æ–‡ä»¶ å…ˆåœ¨ logger ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶ å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š package Logger import ( &#34;github.com/gin-gonic/gin&#34; &#34;go.uber.org/zap&#34; &#34;go.uber.org/zap/zapcore&#34; &#34;gopkg.in/natefinch/lumberjack.v2&#34; &#34;net&#34; &#34;net/http&#34; &#34;net/http/httputil&#34; &#34;os&#34; &#34;runtime/debug&#34; &#34;server/Config&#34; &#34;strings&#34; &#34;time&#34; ) var lg *zap.Logger // InitLogger åˆå§‹åŒ–Logger func InitLogger(cfg *Config.LogConfig) (err error) { writeSyncer := getLogWriter(cfg.Filename, cfg.MaxSize, cfg.MaxBackups, cfg.MaxAge) encoder := getEncoder() var l = new(zapcore.Level) err = l.UnmarshalText([]byte(cfg.Level)) if err != nil { return } core := zapcore.NewCore(encoder, writeSyncer, l) lg = zap.New(core, zap.AddCaller()) zap.ReplaceGlobals(lg) // æ›¿æ¢zapåŒ…ä¸­å…¨å±€çš„loggerå®ä¾‹ï¼Œåç»­åœ¨" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Bin-lin-rgb.github.io/posts/go/zap%E6%97%A5%E5%BF%97%E5%BA%93/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-30T10:39:16+08:00" />
<meta property="article:modified_time" content="2022-10-30T10:39:16+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Zapæ—¥å¿—åº“"/>
<meta name="twitter:description" content="å‰è¨€ zap çš„ä½¿ç”¨ã€‚ å®‰è£… è¿è¡Œä¸‹é¢çš„å‘½ä»¤å®‰è£…zap go get -u go.uber.org/zap å®ç° logger.go æ–‡ä»¶ å…ˆåœ¨ logger ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶ å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š package Logger import ( &#34;github.com/gin-gonic/gin&#34; &#34;go.uber.org/zap&#34; &#34;go.uber.org/zap/zapcore&#34; &#34;gopkg.in/natefinch/lumberjack.v2&#34; &#34;net&#34; &#34;net/http&#34; &#34;net/http/httputil&#34; &#34;os&#34; &#34;runtime/debug&#34; &#34;server/Config&#34; &#34;strings&#34; &#34;time&#34; ) var lg *zap.Logger // InitLogger åˆå§‹åŒ–Logger func InitLogger(cfg *Config.LogConfig) (err error) { writeSyncer := getLogWriter(cfg.Filename, cfg.MaxSize, cfg.MaxBackups, cfg.MaxAge) encoder := getEncoder() var l = new(zapcore.Level) err = l.UnmarshalText([]byte(cfg.Level)) if err != nil { return } core := zapcore.NewCore(encoder, writeSyncer, l) lg = zap.New(core, zap.AddCaller()) zap.ReplaceGlobals(lg) // æ›¿æ¢zapåŒ…ä¸­å…¨å±€çš„loggerå®ä¾‹ï¼Œåç»­åœ¨"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [

        {
          "@type": "ListItem",
          "position":  1 ,
          "name": "ğŸ“šæ–‡ç« ",
          "item": "https://Bin-lin-rgb.github.io/posts/"
        },

        {
          "@type": "ListItem",
          "position":  2 ,
          "name": "ğŸ¥‡ Golang",
          "item": "https://Bin-lin-rgb.github.io/posts/go/"
        }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Zapæ—¥å¿—åº“",
      "item": "https://Bin-lin-rgb.github.io/posts/go/zap%E6%97%A5%E5%BF%97%E5%BA%93/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Zapæ—¥å¿—åº“",
  "name": "Zapæ—¥å¿—åº“",
  "description": "å‰è¨€ zap çš„ä½¿ç”¨ã€‚ å®‰è£… è¿è¡Œä¸‹é¢çš„å‘½ä»¤å®‰è£…zap go get -u go.uber.org/zap å®ç° logger.go æ–‡ä»¶ å…ˆåœ¨ logger ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶ å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š package Logger import ( \u0026#34;github.com/gin-gonic/gin\u0026#34; \u0026#34;go.uber.org/zap\u0026#34; \u0026#34;go.uber.org/zap/zapcore\u0026#34; \u0026#34;gopkg.in/natefinch/lumberjack.v2\u0026#34; \u0026#34;net\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;net/http/httputil\u0026#34; \u0026#34;os\u0026#34; \u0026#34;runtime/debug\u0026#34; \u0026#34;server/Config\u0026#34; \u0026#34;strings\u0026#34; \u0026#34;time\u0026#34; ) var lg *zap.Logger // InitLogger åˆå§‹åŒ–Logger func InitLogger(cfg *Config.LogConfig) (err error) { writeSyncer := getLogWriter(cfg.Filename, cfg.MaxSize, cfg.MaxBackups, cfg.MaxAge) encoder := getEncoder() var l = new(zapcore.Level) err = l.UnmarshalText([]byte(cfg.Level)) if err != nil { return } core := zapcore.NewCore(encoder, writeSyncer, l) lg = zap.New(core, zap.AddCaller()) zap.ReplaceGlobals(lg) // æ›¿æ¢zapåŒ…ä¸­å…¨å±€çš„loggerå®ä¾‹ï¼Œåç»­åœ¨",
  "keywords": [
    ""
  ],
  "articleBody": "å‰è¨€ zap çš„ä½¿ç”¨ã€‚\nå®‰è£… è¿è¡Œä¸‹é¢çš„å‘½ä»¤å®‰è£…zap\ngo get -u go.uber.org/zap å®ç° logger.go æ–‡ä»¶ å…ˆåœ¨ logger ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶\nå…·ä½“å†…å®¹å¦‚ä¸‹ï¼š\npackage Logger import ( \"github.com/gin-gonic/gin\" \"go.uber.org/zap\" \"go.uber.org/zap/zapcore\" \"gopkg.in/natefinch/lumberjack.v2\" \"net\" \"net/http\" \"net/http/httputil\" \"os\" \"runtime/debug\" \"server/Config\" \"strings\" \"time\" ) var lg *zap.Logger // InitLogger åˆå§‹åŒ–Logger func InitLogger(cfg *Config.LogConfig) (err error) { writeSyncer := getLogWriter(cfg.Filename, cfg.MaxSize, cfg.MaxBackups, cfg.MaxAge) encoder := getEncoder() var l = new(zapcore.Level) err = l.UnmarshalText([]byte(cfg.Level)) if err != nil { return } core := zapcore.NewCore(encoder, writeSyncer, l) lg = zap.New(core, zap.AddCaller()) zap.ReplaceGlobals(lg) // æ›¿æ¢zapåŒ…ä¸­å…¨å±€çš„loggerå®ä¾‹ï¼Œåç»­åœ¨å…¶ä»–åŒ…ä¸­åªéœ€ä½¿ç”¨zap.L()è°ƒç”¨å³å¯ return } func getEncoder() zapcore.Encoder { encoderConfig := zap.NewProductionEncoderConfig() encoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder encoderConfig.TimeKey = \"time\" encoderConfig.EncodeLevel = zapcore.CapitalLevelEncoder encoderConfig.EncodeDuration = zapcore.SecondsDurationEncoder encoderConfig.EncodeCaller = zapcore.ShortCallerEncoder return zapcore.NewJSONEncoder(encoderConfig) } func getLogWriter(filename string, maxSize, maxBackup, maxAge int) zapcore.WriteSyncer { lumberJackLogger := \u0026lumberjack.Logger{ Filename: filename, MaxSize: maxSize, MaxBackups: maxBackup, MaxAge: maxAge, } return zapcore.AddSync(lumberJackLogger) } // GinLogger æ¥æ”¶ginæ¡†æ¶é»˜è®¤çš„æ—¥å¿— func GinLogger() gin.HandlerFunc { return func(c *gin.Context) { start := time.Now() path := c.Request.URL.Path query := c.Request.URL.RawQuery c.Next() cost := time.Since(start) lg.Info(path, zap.Int(\"status\", c.Writer.Status()), zap.String(\"method\", c.Request.Method), zap.String(\"path\", path), zap.String(\"query\", query), zap.String(\"ip\", c.ClientIP()), zap.String(\"user-agent\", c.Request.UserAgent()), zap.String(\"errors\", c.Errors.ByType(gin.ErrorTypePrivate).String()), zap.Duration(\"cost\", cost), ) } } // GinRecovery recoveræ‰é¡¹ç›®å¯èƒ½å‡ºç°çš„panicï¼Œå¹¶ä½¿ç”¨zapè®°å½•ç›¸å…³æ—¥å¿— func GinRecovery(stack bool) gin.HandlerFunc { return func(c *gin.Context) { defer func() { if err := recover(); err != nil { // Check for a broken connection, as it is not really a // condition that warrants a panic stack trace. var brokenPipe bool if ne, ok := err.(*net.OpError); ok { if se, ok := ne.Err.(*os.SyscallError); ok { if strings.Contains(strings.ToLower(se.Error()), \"broken pipe\") || strings.Contains(strings.ToLower(se.Error()), \"connection reset by peer\") { brokenPipe = true } } } httpRequest, _ := httputil.DumpRequest(c.Request, false) if brokenPipe { lg.Error(c.Request.URL.Path, zap.Any(\"error\", err), zap.String(\"request\", string(httpRequest)), ) // If the connection is dead, we can't write a status to it. c.Error(err.(error)) // nolint: errcheck c.Abort() return } if stack { lg.Error(\"[Recovery from panic]\", zap.Any(\"error\", err), zap.String(\"request\", string(httpRequest)), zap.String(\"stack\", string(debug.Stack())), ) } else { lg.Error(\"[Recovery from panic]\", zap.Any(\"error\", err), zap.String(\"request\", string(httpRequest)), ) } c.AbortWithStatus(http.StatusInternalServerError) } }() c.Next() } } é…ç½® æ–°å»ºä¸€ä¸ª config.go ç”¨æ¥ï¼Œ å®šä¹‰æ—¥å¿—ç›¸å…³çš„é…ç½®ï¼Œ å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š\npackage Config import ( \"encoding/json\" \"io/ioutil\" ) // Config æ•´ä¸ªé¡¹ç›®çš„é…ç½® type Config struct { Mode string `json:\"mode\"` Port int `json:\"port\"` *LogConfig `json:\"log\"` } // LogConfig æ—¥å¿—é…ç½® type LogConfig struct { Level string `json:\"level\"` Filename string `json:\"filename\"` MaxSize int `json:\"maxsize\"` MaxAge int `json:\"max_age\"` MaxBackups int `json:\"max_backups\"` } // Conf å…¨å±€é…ç½®å˜é‡ var Conf = new(Config) // Init åˆå§‹åŒ–é…ç½®ï¼›ä»æŒ‡å®šæ–‡ä»¶åŠ è½½é…ç½®æ–‡ä»¶ func Init(filePath string) error { b, err := ioutil.ReadFile(filePath) if err != nil { return err } return json.Unmarshal(b, Conf) } config.json\n{ \"mode\": \"debug\", \"port\": 8080, \"log\": { \"level\": \"debug\", \"filename\": \"app.log\", \"maxsize\": 200, \"max_age\": 7, \"max_backups\": 10 } } å¯ä»¥çœ‹åˆ° åœ¨ config.json ä¸­ çš„ filename ä¸º app.log ï¼Œæ˜¯log è¾“å‡ºæ–‡ä»¶ã€‚\nmain.go package main import ( \"fmt\" \"github.com/gin-gonic/gin\" \"log\" \"os\" \"server/Config\" \"server/Logger\" \"server/Router\" \"server/pkg/snowflake\" ) func main() { r := gin.Default() // load config from config.json if len(os.Args) \u003c 1 { return } if err := Config.Init(os.Args[1]); err != nil { panic(err) } // init logger if err := Logger.InitLogger(Config.Conf.LogConfig); err != nil { fmt.Printf(\"init logger failed, err:%v\\n\", err) return } gin.SetMode(Config.Conf.Mode) Router.Start(r) // æ³¨å†Œzapç›¸å…³ä¸­é—´ä»¶ r.Use(Logger.GinLogger(), Logger.GinRecovery(true)) err := r.Run() if err != nil { log.Println(\"r.Run() Failed!\") } } åœ¨é¡¹ç›®ä¸­å…ˆä»é…ç½®æ–‡ä»¶åŠ è½½é…ç½®ä¿¡æ¯ï¼Œå†è°ƒç”¨logger.InitLogger(config.Conf.LogConfig)å³å¯å®Œæˆloggerå®ä¾‹çš„åˆè¯†åŒ–ã€‚å…¶ä¸­ï¼Œé€šè¿‡r.Use(logger.GinLogger(), logger.GinRecovery(true))æ³¨å†Œæˆ‘ä»¬çš„ä¸­é—´ä»¶æ¥ä½¿ç”¨zapæ¥æ”¶ginæ¡†æ¶è‡ªèº«çš„æ—¥å¿—ï¼Œåœ¨é¡¹ç›®ä¸­éœ€è¦çš„åœ°æ–¹é€šè¿‡ä½¿ç”¨zap.L().Xxx()æ–¹æ³•æ¥è®°å½•è‡ªå®šä¹‰æ—¥å¿—ä¿¡æ¯ã€‚\nä½¿ç”¨ æ¯”å¦‚è¿™é‡Œï¼š\nä½¿ç”¨åˆ°äº† zap.Error() .\næŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œè¿˜æœ‰å…¶ä»–çš„å½¢å¼ã€‚ æ–‡æ¡£ï¼šhttps://pkg.go.dev/go.uber.org/zap\nå¸¸ç”¨çš„ï¼š\n[Debug] func (log *Logger) Debug(msg string, fields ...Field) Debug logs a message at DebugLevel. The message includes any fields passed at the log site, as well as any fields accumulated on the logger.\n[Error] func (log *Logger) Error(msg string, fields ...Field) Error logs a message at ErrorLevel. The message includes any fields passed at the log site, as well as any fields accumulated on the logger.\n[Fatal] func (log *Logger) Fatal(msg string, fields ...Field) Fatal logs a message at FatalLevel. The message includes any fields passed at the log site, as well as any fields accumulated on the logger.\nThe logger then calls os.Exit(1), even if logging at FatalLevel is disabled.\n[Info] func (log *Logger) Info(msg string, fields ...Field) Info logs a message at InfoLevel. The message includes any fields passed at the log site, as well as any fields accumulated on the logger.\næ€»ç»“ æ—¥å¿—æ˜¯ç”¨æ¥è®°å½•ï¼Œç”¨æˆ·æ“ä½œï¼Œç³»ç»ŸçŠ¶æ€ï¼Œé”™è¯¯ä¿¡æ¯ç­‰ç­‰å†…å®¹çš„æ–‡ä»¶ï¼Œæ˜¯ä¸€ä¸ªè½¯ä»¶ç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚ä¸€ä¸ªè‰¯å¥½çš„æ—¥å¿—è§„èŒƒï¼Œå¯¹äºç³»ç»Ÿè¿è¡ŒçŠ¶æ€çš„åˆ†æï¼Œä»¥åŠçº¿ä¸Šé—®é¢˜çš„è§£å†³å…·æœ‰é‡å¤§çš„æ„ä¹‰ã€‚\né‡è¦åŠŸèƒ½æ—¥å¿—å°½å¯èƒ½çš„å®Œå–„ã€‚ ä¸è¦éšæ„æ‰“å°æ— ç”¨çš„æ—¥å¿—ï¼Œè¿‡å¤šæ— ç”¨çš„æ—¥å¿—ä¼šå¢åŠ åˆ†ææ—¥å¿—çš„éš¾åº¦ã€‚ æ—¥å¿—è¦åŒºåˆ†ç­‰çº§ å¦‚ debugï¼Œwarnï¼Œinfoï¼Œerror ç­‰ã€‚ æ•è·åˆ°æœªå¤„ç†é”™è¯¯æ—¶æœ€å¥½æ‰“å°é”™è¯¯å †æ ˆä¿¡æ¯ ",
  "wordCount" : "1291",
  "inLanguage": "zh",
  "datePublished": "2022-10-30T10:39:16+08:00",
  "dateModified": "2022-10-30T10:39:16+08:00",
  "author":[{
    "@type": "Person",
    "name": "Blaine"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://Bin-lin-rgb.github.io/posts/go/zap%E6%97%A5%E5%BF%97%E5%BA%93/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Blaine's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://Bin-lin-rgb.github.io/img/icon.png"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    (function () {
        let  arr,reg = new RegExp("(^| )"+"change-themes"+"=([^;]*)(;|$)");
        if(arr = document.cookie.match(reg)) {
        } else {
            if (new Date().getHours() >= 19 || new Date().getHours() < 6) {
                document.body.classList.add('dark');
                localStorage.setItem("pref-theme", 'dark');
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem("pref-theme", 'light');
            }
        }
    })()

    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://Bin-lin-rgb.github.io/" accesskey="h" title="Blaine&#39;s Blog (Alt + H)">
            <img src="https://Bin-lin-rgb.github.io/img/icon.png" alt="logo" aria-label="logo"
                 height="35">Blaine&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://Bin-lin-rgb.github.io/" title="ğŸ  ä¸»é¡µ">
                <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://Bin-lin-rgb.github.io/posts" title="ğŸ“š æ–‡ç« ">
                <span>ğŸ“š æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://Bin-lin-rgb.github.io/search" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                <span>ğŸ” æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://Bin-lin-rgb.github.io/tags" title="ğŸ§© æ ‡ç­¾">
                <span>ğŸ§© æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://Bin-lin-rgb.github.io/archives/" title="â±ï¸ æ—¶é—´è½´">
                <span>â±ï¸ æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://Bin-lin-rgb.github.io/about" title="ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº">
                <span>ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº</span>
                </a>
            </li>
            <li>
                <a href="https://Bin-lin-rgb.github.io/links" title="ğŸ¤ å‹é“¾">
                <span>ğŸ¤ å‹é“¾</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }
</style>

<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="https://Bin-lin-rgb.github.io/">ğŸ  ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://Bin-lin-rgb.github.io/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://Bin-lin-rgb.github.io/posts/go/">ğŸ¥‡ Golang</a></div>
            <h1 class="post-title">
                Zapæ—¥å¿—åº“
            </h1>
            <div class="post-meta">

<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2022-10-30
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>1291å­—
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>3åˆ†é’Ÿ
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>Blaine
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
            </span>
        </span>
    </span>
</span>
<span style="opacity: 0.8;">
                    <span id="post_meta_style_7">
                        &nbsp;&nbsp;
                        <span class="fa fa-eye" ></span>
                        <span>
                            <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
                            &nbsp;&nbsp;
                        </span>
                    </span>
                    <span id="post_meta_style_8">
                        <span class="fa fa-commenting-o"></span>
                        <span>
                            <script src="https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js"></script>
                            <script>
                                let url = document.documentURI
                                
                                let dnsUrl = "https://Bin-lin-rgb.github.io/"
                                let urlSplit = url.split(dnsUrl)
                                let finalUrl = urlSplit[1]
                                if (finalUrl[0] !== '/') {
                                    finalUrl = '/'+finalUrl
                                }
                                twikoo.getCommentsCount({
                                    envId: "https://twikoo-api-nine-silk.vercel.app/", 
                                region: "ap-guangzhou", 
                                urls: [ 
                                    
                                    finalUrl,
                                ],
                                    includeReply: false 
                                }).then(function (res) {
                                    let count = res[0].count
                                    const obj = document.getElementById("comment_count");
                                    obj.innerText = count
                                    
                                    
                                    
                                }).catch(function (err) {
                                    
                                    console.error(err);
                                });
                            </script>
                            <span id="comment_count"></span>
                        </span>
                    </span>
                </span>

</div>
        </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%89%8d%e8%a8%80" aria-label="å‰è¨€">å‰è¨€</a></li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85" aria-label="å®‰è£…">å®‰è£…</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0-loggergo-%e6%96%87%e4%bb%b6" aria-label="å®ç° logger.go æ–‡ä»¶">å®ç° logger.go æ–‡ä»¶</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae" aria-label="é…ç½®">é…ç½®</a></li>
                <li>
                    <a href="#maingo" aria-label="main.go">main.go</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8" aria-label="ä½¿ç”¨">ä½¿ç”¨</a><ul>
                        
                <li>
                    <a href="#debug" aria-label="[Debug]">[Debug]</a></li>
                <li>
                    <a href="#error" aria-label="[Error]">[Error]</a></li>
                <li>
                    <a href="#fatal" aria-label="[Fatal]">[Fatal]</a></li>
                <li>
                    <a href="#info" aria-label="[Info]">[Info]</a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93" aria-label="æ€»ç»“">æ€»ç»“</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        if (elements) {
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                    (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                    return element;
                }
            }) || activeElement

            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                if (element === activeElement){
                    document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
                } else {
                    document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
                }
            })
        }
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        <div class="post-content"><h2 id="å‰è¨€">å‰è¨€<a hidden class="anchor" aria-hidden="true" href="#å‰è¨€">#</a></h2>
<p>zap çš„ä½¿ç”¨ã€‚</p>
<h2 id="å®‰è£…">å®‰è£…<a hidden class="anchor" aria-hidden="true" href="#å®‰è£…">#</a></h2>
<p>è¿è¡Œä¸‹é¢çš„å‘½ä»¤å®‰è£…zap</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>go get -u go.uber.org/zap
</span></span></code></pre></div><h2 id="å®ç°-loggergo-æ–‡ä»¶">å®ç° logger.go æ–‡ä»¶<a hidden class="anchor" aria-hidden="true" href="#å®ç°-loggergo-æ–‡ä»¶">#</a></h2>
<p>å…ˆåœ¨ logger ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶</p>
<p>å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> Logger
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;go.uber.org/zap&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;go.uber.org/zap/zapcore&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;gopkg.in/natefinch/lumberjack.v2&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;net/http/httputil&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;runtime/debug&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;server/Config&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">var</span> lg <span style="color:#ff6ac1">*</span>zap.Logger
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e">// InitLogger åˆå§‹åŒ–Logger
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">InitLogger</span>(cfg <span style="color:#ff6ac1">*</span>Config.LogConfig) (err <span style="color:#9aedfe">error</span>) {
</span></span><span style="display:flex;"><span>	writeSyncer <span style="color:#ff6ac1">:=</span> <span style="color:#57c7ff">getLogWriter</span>(cfg.Filename, cfg.MaxSize, cfg.MaxBackups, cfg.MaxAge)
</span></span><span style="display:flex;"><span>	encoder <span style="color:#ff6ac1">:=</span> <span style="color:#57c7ff">getEncoder</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">var</span> l = <span style="color:#ff5c57">new</span>(zapcore.Level)
</span></span><span style="display:flex;"><span>	err = l.<span style="color:#57c7ff">UnmarshalText</span>([]<span style="color:#ff5c57">byte</span>(cfg.Level))
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	core <span style="color:#ff6ac1">:=</span> zapcore.<span style="color:#57c7ff">NewCore</span>(encoder, writeSyncer, l)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	lg = zap.<span style="color:#57c7ff">New</span>(core, zap.<span style="color:#57c7ff">AddCaller</span>())
</span></span><span style="display:flex;"><span>	zap.<span style="color:#57c7ff">ReplaceGlobals</span>(lg) <span style="color:#78787e">// æ›¿æ¢zapåŒ…ä¸­å…¨å±€çš„loggerå®ä¾‹ï¼Œåç»­åœ¨å…¶ä»–åŒ…ä¸­åªéœ€ä½¿ç”¨zap.L()è°ƒç”¨å³å¯
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">getEncoder</span>() zapcore.Encoder {
</span></span><span style="display:flex;"><span>	encoderConfig <span style="color:#ff6ac1">:=</span> zap.<span style="color:#57c7ff">NewProductionEncoderConfig</span>()
</span></span><span style="display:flex;"><span>	encoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder
</span></span><span style="display:flex;"><span>	encoderConfig.TimeKey = <span style="color:#5af78e">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	encoderConfig.EncodeLevel = zapcore.CapitalLevelEncoder
</span></span><span style="display:flex;"><span>	encoderConfig.EncodeDuration = zapcore.SecondsDurationEncoder
</span></span><span style="display:flex;"><span>	encoderConfig.EncodeCaller = zapcore.ShortCallerEncoder
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">return</span> zapcore.<span style="color:#57c7ff">NewJSONEncoder</span>(encoderConfig)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">getLogWriter</span>(filename <span style="color:#9aedfe">string</span>, maxSize, maxBackup, maxAge <span style="color:#9aedfe">int</span>) zapcore.WriteSyncer {
</span></span><span style="display:flex;"><span>	lumberJackLogger <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">&amp;</span>lumberjack.Logger{
</span></span><span style="display:flex;"><span>		Filename:   filename,
</span></span><span style="display:flex;"><span>		MaxSize:    maxSize,
</span></span><span style="display:flex;"><span>		MaxBackups: maxBackup,
</span></span><span style="display:flex;"><span>		MaxAge:     maxAge,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">return</span> zapcore.<span style="color:#57c7ff">AddSync</span>(lumberJackLogger)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e">// GinLogger æ¥æ”¶ginæ¡†æ¶é»˜è®¤çš„æ—¥å¿—
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">GinLogger</span>() gin.HandlerFunc {
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">return</span> <span style="color:#ff5c57">func</span>(c <span style="color:#ff6ac1">*</span>gin.Context) {
</span></span><span style="display:flex;"><span>		start <span style="color:#ff6ac1">:=</span> time.<span style="color:#57c7ff">Now</span>()
</span></span><span style="display:flex;"><span>		path <span style="color:#ff6ac1">:=</span> c.Request.URL.Path
</span></span><span style="display:flex;"><span>		query <span style="color:#ff6ac1">:=</span> c.Request.URL.RawQuery
</span></span><span style="display:flex;"><span>		c.<span style="color:#57c7ff">Next</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		cost <span style="color:#ff6ac1">:=</span> time.<span style="color:#57c7ff">Since</span>(start)
</span></span><span style="display:flex;"><span>		lg.<span style="color:#57c7ff">Info</span>(path,
</span></span><span style="display:flex;"><span>			zap.<span style="color:#57c7ff">Int</span>(<span style="color:#5af78e">&#34;status&#34;</span>, c.Writer.<span style="color:#57c7ff">Status</span>()),
</span></span><span style="display:flex;"><span>			zap.<span style="color:#57c7ff">String</span>(<span style="color:#5af78e">&#34;method&#34;</span>, c.Request.Method),
</span></span><span style="display:flex;"><span>			zap.<span style="color:#57c7ff">String</span>(<span style="color:#5af78e">&#34;path&#34;</span>, path),
</span></span><span style="display:flex;"><span>			zap.<span style="color:#57c7ff">String</span>(<span style="color:#5af78e">&#34;query&#34;</span>, query),
</span></span><span style="display:flex;"><span>			zap.<span style="color:#57c7ff">String</span>(<span style="color:#5af78e">&#34;ip&#34;</span>, c.<span style="color:#57c7ff">ClientIP</span>()),
</span></span><span style="display:flex;"><span>			zap.<span style="color:#57c7ff">String</span>(<span style="color:#5af78e">&#34;user-agent&#34;</span>, c.Request.<span style="color:#57c7ff">UserAgent</span>()),
</span></span><span style="display:flex;"><span>			zap.<span style="color:#57c7ff">String</span>(<span style="color:#5af78e">&#34;errors&#34;</span>, c.Errors.<span style="color:#57c7ff">ByType</span>(gin.ErrorTypePrivate).<span style="color:#57c7ff">String</span>()),
</span></span><span style="display:flex;"><span>			zap.<span style="color:#57c7ff">Duration</span>(<span style="color:#5af78e">&#34;cost&#34;</span>, cost),
</span></span><span style="display:flex;"><span>		)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e">// GinRecovery recoveræ‰é¡¹ç›®å¯èƒ½å‡ºç°çš„panicï¼Œå¹¶ä½¿ç”¨zapè®°å½•ç›¸å…³æ—¥å¿—
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">GinRecovery</span>(stack <span style="color:#9aedfe">bool</span>) gin.HandlerFunc {
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">return</span> <span style="color:#ff5c57">func</span>(c <span style="color:#ff6ac1">*</span>gin.Context) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">defer</span> <span style="color:#ff5c57">func</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">:=</span> <span style="color:#ff5c57">recover</span>(); err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#78787e">// Check for a broken connection, as it is not really a
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>				<span style="color:#78787e">// condition that warrants a panic stack trace.
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>				<span style="color:#ff5c57">var</span> brokenPipe <span style="color:#9aedfe">bool</span>
</span></span><span style="display:flex;"><span>				<span style="color:#ff6ac1">if</span> ne, ok <span style="color:#ff6ac1">:=</span> err.(<span style="color:#ff6ac1">*</span>net.OpError); ok {
</span></span><span style="display:flex;"><span>					<span style="color:#ff6ac1">if</span> se, ok <span style="color:#ff6ac1">:=</span> ne.Err.(<span style="color:#ff6ac1">*</span>os.SyscallError); ok {
</span></span><span style="display:flex;"><span>						<span style="color:#ff6ac1">if</span> strings.<span style="color:#57c7ff">Contains</span>(strings.<span style="color:#57c7ff">ToLower</span>(se.<span style="color:#57c7ff">Error</span>()), <span style="color:#5af78e">&#34;broken pipe&#34;</span>) <span style="color:#ff6ac1">||</span> strings.<span style="color:#57c7ff">Contains</span>(strings.<span style="color:#57c7ff">ToLower</span>(se.<span style="color:#57c7ff">Error</span>()), <span style="color:#5af78e">&#34;connection reset by peer&#34;</span>) {
</span></span><span style="display:flex;"><span>							brokenPipe = <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				httpRequest, _ <span style="color:#ff6ac1">:=</span> httputil.<span style="color:#57c7ff">DumpRequest</span>(c.Request, <span style="color:#ff6ac1">false</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#ff6ac1">if</span> brokenPipe {
</span></span><span style="display:flex;"><span>					lg.<span style="color:#57c7ff">Error</span>(c.Request.URL.Path,
</span></span><span style="display:flex;"><span>						zap.<span style="color:#57c7ff">Any</span>(<span style="color:#5af78e">&#34;error&#34;</span>, err),
</span></span><span style="display:flex;"><span>						zap.<span style="color:#57c7ff">String</span>(<span style="color:#5af78e">&#34;request&#34;</span>, <span style="color:#ff5c57">string</span>(httpRequest)),
</span></span><span style="display:flex;"><span>					)
</span></span><span style="display:flex;"><span>					<span style="color:#78787e">// If the connection is dead, we can&#39;t write a status to it.
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>					c.<span style="color:#57c7ff">Error</span>(err.(<span style="color:#9aedfe">error</span>)) <span style="color:#78787e">// nolint: errcheck
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>					c.<span style="color:#57c7ff">Abort</span>()
</span></span><span style="display:flex;"><span>					<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#ff6ac1">if</span> stack {
</span></span><span style="display:flex;"><span>					lg.<span style="color:#57c7ff">Error</span>(<span style="color:#5af78e">&#34;[Recovery from panic]&#34;</span>,
</span></span><span style="display:flex;"><span>						zap.<span style="color:#57c7ff">Any</span>(<span style="color:#5af78e">&#34;error&#34;</span>, err),
</span></span><span style="display:flex;"><span>						zap.<span style="color:#57c7ff">String</span>(<span style="color:#5af78e">&#34;request&#34;</span>, <span style="color:#ff5c57">string</span>(httpRequest)),
</span></span><span style="display:flex;"><span>						zap.<span style="color:#57c7ff">String</span>(<span style="color:#5af78e">&#34;stack&#34;</span>, <span style="color:#ff5c57">string</span>(debug.<span style="color:#57c7ff">Stack</span>())),
</span></span><span style="display:flex;"><span>					)
</span></span><span style="display:flex;"><span>				} <span style="color:#ff6ac1">else</span> {
</span></span><span style="display:flex;"><span>					lg.<span style="color:#57c7ff">Error</span>(<span style="color:#5af78e">&#34;[Recovery from panic]&#34;</span>,
</span></span><span style="display:flex;"><span>						zap.<span style="color:#57c7ff">Any</span>(<span style="color:#5af78e">&#34;error&#34;</span>, err),
</span></span><span style="display:flex;"><span>						zap.<span style="color:#57c7ff">String</span>(<span style="color:#5af78e">&#34;request&#34;</span>, <span style="color:#ff5c57">string</span>(httpRequest)),
</span></span><span style="display:flex;"><span>					)
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				c.<span style="color:#57c7ff">AbortWithStatus</span>(http.StatusInternalServerError)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}()
</span></span><span style="display:flex;"><span>		c.<span style="color:#57c7ff">Next</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="é…ç½®">é…ç½®<a hidden class="anchor" aria-hidden="true" href="#é…ç½®">#</a></h2>
<p>æ–°å»ºä¸€ä¸ª config.go ç”¨æ¥ï¼Œ
å®šä¹‰æ—¥å¿—ç›¸å…³çš„é…ç½®ï¼Œ
å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> Config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;encoding/json&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;io/ioutil&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e">// Config æ•´ä¸ªé¡¹ç›®çš„é…ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span><span style="color:#ff5c57">type</span> Config <span style="color:#ff5c57">struct</span> {
</span></span><span style="display:flex;"><span>	Mode       <span style="color:#9aedfe">string</span> <span style="color:#5af78e">`json:&#34;mode&#34;`</span>
</span></span><span style="display:flex;"><span>	Port       <span style="color:#9aedfe">int</span>    <span style="color:#5af78e">`json:&#34;port&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">*</span>LogConfig <span style="color:#5af78e">`json:&#34;log&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e">// LogConfig æ—¥å¿—é…ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span><span style="color:#ff5c57">type</span> LogConfig <span style="color:#ff5c57">struct</span> {
</span></span><span style="display:flex;"><span>	Level      <span style="color:#9aedfe">string</span> <span style="color:#5af78e">`json:&#34;level&#34;`</span>
</span></span><span style="display:flex;"><span>	Filename   <span style="color:#9aedfe">string</span> <span style="color:#5af78e">`json:&#34;filename&#34;`</span>
</span></span><span style="display:flex;"><span>	MaxSize    <span style="color:#9aedfe">int</span>    <span style="color:#5af78e">`json:&#34;maxsize&#34;`</span>
</span></span><span style="display:flex;"><span>	MaxAge     <span style="color:#9aedfe">int</span>    <span style="color:#5af78e">`json:&#34;max_age&#34;`</span>
</span></span><span style="display:flex;"><span>	MaxBackups <span style="color:#9aedfe">int</span>    <span style="color:#5af78e">`json:&#34;max_backups&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e">// Conf å…¨å±€é…ç½®å˜é‡
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span><span style="color:#ff5c57">var</span> Conf = <span style="color:#ff5c57">new</span>(Config)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e">// Init åˆå§‹åŒ–é…ç½®ï¼›ä»æŒ‡å®šæ–‡ä»¶åŠ è½½é…ç½®æ–‡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Init</span>(filePath <span style="color:#9aedfe">string</span>) <span style="color:#9aedfe">error</span> {
</span></span><span style="display:flex;"><span>	b, err <span style="color:#ff6ac1">:=</span> ioutil.<span style="color:#57c7ff">ReadFile</span>(filePath)
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">return</span> json.<span style="color:#57c7ff">Unmarshal</span>(b, Conf)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>config.json</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#5af78e">&#34;mode&#34;</span>: <span style="color:#5af78e">&#34;debug&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#5af78e">&#34;port&#34;</span>: <span style="color:#ff9f43">8080</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#5af78e">&#34;log&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;level&#34;</span>: <span style="color:#5af78e">&#34;debug&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;filename&#34;</span>: <span style="color:#5af78e">&#34;app.log&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;maxsize&#34;</span>: <span style="color:#ff9f43">200</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;max_age&#34;</span>: <span style="color:#ff9f43">7</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;max_backups&#34;</span>: <span style="color:#ff9f43">10</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ° åœ¨ config.json ä¸­ çš„ filename ä¸º app.log ï¼Œæ˜¯log è¾“å‡ºæ–‡ä»¶ã€‚</p>
<h2 id="maingo">main.go<a hidden class="anchor" aria-hidden="true" href="#maingo">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;server/Config&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;server/Logger&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;server/Router&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;server/pkg/snowflake&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">main</span>() {
</span></span><span style="display:flex;"><span>	r <span style="color:#ff6ac1">:=</span> gin.<span style="color:#57c7ff">Default</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// load config from config.json
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff6ac1">if</span> <span style="color:#ff5c57">len</span>(os.Args) &lt; <span style="color:#ff9f43">1</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">:=</span> Config.<span style="color:#57c7ff">Init</span>(os.Args[<span style="color:#ff9f43">1</span>]); err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff5c57">panic</span>(err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// init logger
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">:=</span> Logger.<span style="color:#57c7ff">InitLogger</span>(Config.Conf.LogConfig); err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;init logger failed, err:%v\n&#34;</span>, err)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	gin.<span style="color:#57c7ff">SetMode</span>(Config.Conf.Mode)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Router.<span style="color:#57c7ff">Start</span>(r)
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// æ³¨å†Œzapç›¸å…³ä¸­é—´ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	r.<span style="color:#57c7ff">Use</span>(Logger.<span style="color:#57c7ff">GinLogger</span>(), Logger.<span style="color:#57c7ff">GinRecovery</span>(<span style="color:#ff6ac1">true</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	err <span style="color:#ff6ac1">:=</span> r.<span style="color:#57c7ff">Run</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;r.Run() Failed!&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>åœ¨é¡¹ç›®ä¸­å…ˆä»é…ç½®æ–‡ä»¶åŠ è½½é…ç½®ä¿¡æ¯ï¼Œå†è°ƒç”¨<code>logger.InitLogger(config.Conf.LogConfig)</code>å³å¯å®Œæˆloggerå®ä¾‹çš„åˆè¯†åŒ–ã€‚å…¶ä¸­ï¼Œé€šè¿‡<code>r.Use(logger.GinLogger(), logger.GinRecovery(true))</code>æ³¨å†Œæˆ‘ä»¬çš„ä¸­é—´ä»¶æ¥ä½¿ç”¨zapæ¥æ”¶ginæ¡†æ¶è‡ªèº«çš„æ—¥å¿—ï¼Œåœ¨é¡¹ç›®ä¸­éœ€è¦çš„åœ°æ–¹é€šè¿‡ä½¿ç”¨<code>zap.L().Xxx()</code>æ–¹æ³•æ¥è®°å½•è‡ªå®šä¹‰æ—¥å¿—ä¿¡æ¯ã€‚</p>
<h2 id="ä½¿ç”¨">ä½¿ç”¨<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨">#</a></h2>
<p>æ¯”å¦‚è¿™é‡Œï¼š</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/Bin-lin-rgb/blog-img@main/20231030104021.png" alt=""  />
</p>
<p>ä½¿ç”¨åˆ°äº† zap.Error() .</p>
<p>æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œè¿˜æœ‰å…¶ä»–çš„å½¢å¼ã€‚
æ–‡æ¡£ï¼šhttps://pkg.go.dev/go.uber.org/zap</p>
<p>å¸¸ç”¨çš„ï¼š</p>
<h3 id="debug">[Debug]<a hidden class="anchor" aria-hidden="true" href="#debug">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>func (log *Logger) Debug(msg string, fields ...Field)
</span></span></code></pre></div><p>Debug logs a message at DebugLevel. The message includes any fields passed at the log site, as well as any fields accumulated on the logger.</p>
<h3 id="error">[Error]<a hidden class="anchor" aria-hidden="true" href="#error">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>func (log *Logger) Error(msg string, fields ...Field)
</span></span></code></pre></div><p>Error logs a message at ErrorLevel. The message includes any fields passed at the log site, as well as any fields accumulated on the logger.</p>
<h3 id="fatal">[Fatal]<a hidden class="anchor" aria-hidden="true" href="#fatal">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>func (log *Logger) Fatal(msg string, fields ...Field)
</span></span></code></pre></div><p>Fatal logs a message at FatalLevel. The message includes any fields passed at the log site, as well as any fields accumulated on the logger.</p>
<p>The logger then calls os.Exit(1), even if logging at FatalLevel is disabled.</p>
<h3 id="info">[Info]<a hidden class="anchor" aria-hidden="true" href="#info">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>func (log *Logger) Info(msg string, fields ...Field)
</span></span></code></pre></div><p>Info logs a message at InfoLevel. The message includes any fields passed at the log site, as well as any fields accumulated on the logger.</p>
<h3 id="æ€»ç»“">æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“">#</a></h3>
<p>æ—¥å¿—æ˜¯ç”¨æ¥è®°å½•ï¼Œç”¨æˆ·æ“ä½œï¼Œç³»ç»ŸçŠ¶æ€ï¼Œé”™è¯¯ä¿¡æ¯ç­‰ç­‰å†…å®¹çš„æ–‡ä»¶ï¼Œæ˜¯ä¸€ä¸ªè½¯ä»¶ç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚ä¸€ä¸ªè‰¯å¥½çš„æ—¥å¿—è§„èŒƒï¼Œå¯¹äºç³»ç»Ÿè¿è¡ŒçŠ¶æ€çš„åˆ†æï¼Œä»¥åŠçº¿ä¸Šé—®é¢˜çš„è§£å†³å…·æœ‰é‡å¤§çš„æ„ä¹‰ã€‚</p>
<ul>
<li>é‡è¦åŠŸèƒ½æ—¥å¿—å°½å¯èƒ½çš„å®Œå–„ã€‚</li>
<li>ä¸è¦éšæ„æ‰“å°æ— ç”¨çš„æ—¥å¿—ï¼Œè¿‡å¤šæ— ç”¨çš„æ—¥å¿—ä¼šå¢åŠ åˆ†ææ—¥å¿—çš„éš¾åº¦ã€‚</li>
<li>æ—¥å¿—è¦åŒºåˆ†ç­‰çº§ å¦‚ debugï¼Œwarnï¼Œinfoï¼Œerror ç­‰ã€‚</li>
<li>æ•è·åˆ°æœªå¤„ç†é”™è¯¯æ—¶æœ€å¥½æ‰“å°é”™è¯¯å †æ ˆä¿¡æ¯</li>
</ul>


        </div>
        <div class="post-reward">
            <div style="padding: 0 0 0 0; margin: 0 0 0 0; width: 100%; font-size:16px; text-align: center;">
                <div id="QR" style="opacity: 0;">
                    <div id="wechat" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="wechat_qr" src="https://Bin-lin-rgb.github.io/img/wechat_pay.png" alt="wechat_pay"></a>
                        <p>å¾®ä¿¡</p>
                    </div>
                    <div id="alipay" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="alipay_qr" src="https://Bin-lin-rgb.github.io/img/alipay.png" alt="alipay"></a>
                        <p>æ”¯ä»˜å®</p>
                    </div>
                </div>
                <button id="rewardButton"
                        onclick="
                    var qr = document.getElementById('QR');
                    if (qr.style.opacity === '0') {
                        qr.style.opacity='1';
                    } else {
                        qr.style.opacity='0'
                    }"
                >
                    <span>ğŸ§§ é¼“åŠ±</span>
                </button>
            </div>
        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="https://Bin-lin-rgb.github.io/posts/tech/tech/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>Redis scanå‘½ä»¤å­¦ä¹ </span>
  </a>
  <a class="next" href="https://Bin-lin-rgb.github.io/posts/go/golang%E9%9B%86%E6%88%90gorm/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>Golangé›†æˆgorm</span>
  </a>
</nav>

        </footer>
    </div>

<style>
    .comments_details summary::marker {
        font-size: 20px;
        content: 'ğŸ‘‰å±•å¼€è¯„è®º';
        color: var(--content);
    }
    .comments_details[open] summary::marker{
        font-size: 20px;
        content: 'ğŸ‘‡å…³é—­è¯„è®º';
        color: var(--content);
    }
</style>


<div>
    <details class="comments_details">
        <summary style="cursor: pointer; margin: 50px 0 20px 0;width: 130px;">
            <span style="font-size: 20px;color: var(--content);">...</span>
        </summary>
        <div id="tcomment"></div>
    </details>
    <script src="https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js">
    </script>
    <script>
        twikoo.init({
            envId: 'https://twikoo-api-nine-silk.vercel.app/',
            el: "#tcomment",
            lang: 'zh-CN',
            region: 'ap-guangzhou',
            path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
        })
    
    
    
    
    
    
    
    </script>
</div>
</article>
</main>

<footer class="footer">
    <span>
        Copyright
        &copy;
        2021-2023
        <a href="https://Bin-lin-rgb.github.io/" style="color:#939393;">Blaine&#39;s Blog</a>
        All Rights Reserved
    </span>
    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;">å¤‡æ¡ˆå·</a>&nbsp;
    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"
           style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="%e5%85%ac%e5%ae%89%e5%9b%be%e6%a0%87%e9%93%be%e6%8e%a5" style="float:left;margin: 0px 5px 0px 0px;"/>
            å…¬ç½‘å®‰å¤‡
        </a>
    </span>
    <span id="busuanzi_container">
        <span class="fa fa-user"></span> <span id="busuanzi_value_site_uv"></span>
        <span class="fa fa-eye"></span> <span id="busuanzi_value_site_pv"></span>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
</script>
<script>
    let mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        (function() {
            document.cookie = "change-themes" + "="+ escape ("false");
        })()

        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    });
</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"Blaine's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"Blaine's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;
        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerText = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerText = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"Blaine's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {}
            selection.removeRange(range);
        });

        let language = codeblock.className.replaceAll("language-", "")
        let macTool = document.createElement("div")
        let macTool1 = document.createElement("div")
        let macTool2 = document.createElement("div")
        let macTool3 = document.createElement("div")
        let languageType = document.createElement("div")
        languageType.innerText = language
        macTool.setAttribute('class', 'mac-tool')
        macTool1.setAttribute('class', 'mac bb1')
        macTool2.setAttribute('class', 'mac bb2')
        macTool3.setAttribute('class', 'mac bb3')
        languageType.setAttribute('class', 'language-type')
        macTool.appendChild(macTool1)
        macTool.appendChild(macTool2)
        macTool.appendChild(macTool3)
        macTool.appendChild(languageType)

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
            container.appendChild(macTool)
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        }
    });
</script>
</body>

</html>
