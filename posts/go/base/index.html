<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Golang 基础语法 | Blaine&#39;s Blog</title>
<meta name="keywords" content="Golang 基础语法">
<meta name="description" content="Golang 基础语法">
<meta name="author" content="Blaine">
<link rel="canonical" href="https://Bin-lin-rgb.github.io/posts/go/base/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://Bin-lin-rgb.github.io/img/icon.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://Bin-lin-rgb.github.io/img/icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://Bin-lin-rgb.github.io/img/icon.png">
<link rel="apple-touch-icon" href="https://Bin-lin-rgb.github.io/img/icon.png">
<link rel="mask-icon" href="https://Bin-lin-rgb.github.io/img/icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="Golang 基础语法" />
<meta property="og:description" content="Golang 基础语法" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Bin-lin-rgb.github.io/posts/go/base/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-30T15:55:23+08:00" />
<meta property="article:modified_time" content="2021-11-30T15:55:23+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Golang 基础语法"/>
<meta name="twitter:description" content="Golang 基础语法"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [

        {
          "@type": "ListItem",
          "position":  1 ,
          "name": "📚文章",
          "item": "https://Bin-lin-rgb.github.io/posts/"
        },

        {
          "@type": "ListItem",
          "position":  2 ,
          "name": "🥇 Golang",
          "item": "https://Bin-lin-rgb.github.io/posts/go/"
        }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Golang 基础语法",
      "item": "https://Bin-lin-rgb.github.io/posts/go/base/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Golang 基础语法",
  "name": "Golang 基础语法",
  "description": "Golang 基础语法",
  "keywords": [
    "Golang 基础语法"
  ],
  "articleBody": "Base\ngo 常用命令 build: 编译包和依赖 clean: 移除对象文件 doc: 显示包或者符号的文档 env: 打印go的环境信息 bug: 启动错误报告 fix: 运行go tool fix fmt: 运行gofmt进行格式化 generate: 从processing source生成go文件 get: 下载并安装包和依赖 install: 编译并安装包和依赖 list: 列出包 run: 编译并运行go程序 test: 运行测试 tool: 运行go提供的工具 version: 显示go的版本 vet: 运行go tool vet 标识符的组成 1.标识符由数字、字母和下划线 (_) 组成。\n2.只能以字母和下划线 (_) 开头。\n3.标识符区分大小写。\nGo是一门区分大小写的语言 命名规则涉及变量、常量、全局函数、结构、接口、方法等的命名。\nGO语言从语法层面进行了以下限定：\n任何需要对外暴露的名字必须以大写字母开头，\n不需要对外暴露的则应该以小写字母开头。\n短变量声明只能在函数里使用。\n包名称 保持packāge的名字和目录保持一致，尽量采取有意义的包名，简短，有意义，尽量和标准库不要冲突。==包名应该为小写单词==，不要使用下线或者混合大小写。\npackage dao package service 文件命名 尽量采取有意义的文件名，简短，有意义，==应该为小写单词==，使用下划线分隔各个单词。\ncustomer_dao.go 结构体命名 ==采用驼峰命名法==，首字母根据访问控制大写或者小写\nstruct申明和初始化格式采用多行，例如下面：\ntype Customerorder struct{ Name string Address string } order:=CustomerOrder{\"tom\",\"北京海淀\"} 错误处理 错误处理的原则就是不能丢弃任何有返回 err 的调用，不要使用_丢弃，必须全部处理。\n接收到错误，\n要么返回 err, 或者使用 log 记录下来尽早return , 一旦有错误发生，马上返回 尽量不要使用 panic ,除非你知道你在做什么， 错误描述如果是英文必须为小写，不需要标点结尾，采用独立的错误流进行处理. //正确写法 if err != nil{ //错误处理 return } //正常代码 单元测试 单元测试文件名命名规范为example_test.go测试用例的函数名称必须以Test开头，例如：TestExample\n每个重要的函数都要首先编写测试用例，测试用例和正规代码一起提交方便进行回归测试。\n常量 定义常量的语法\n定义一个常量使用const关键字，语法格式如下：\nconst constantName [type]=value\nconst: 定义常量关键字 constantName: 常量名称 type: 常量类型 value: 常量的值 iota iota比较特殊，可以被认为是一个可被编译器修改的常量，它默认开始值是g,每调用一次加1。遇到const关键字时被重置为0。 实例\npackage Base import \"fmt\" func Iota() { const ( a1 = iota a2 = iota a3 = iota ) fmt.Printf(\"a1:%v\\n\", a1) fmt.Printf(\"a2:%v\\n\", a2) fmt.Printf(\"a3:%v\\n\", a3) } ======== a1:0 a2:1 a3:2 跳过1 func Iota() { const ( a1 = iota _ a3 = iota ) fmt.Printf(\"a1:%v\\n\", a1) fmt.Printf(\"a3:%v\\n\", a3) } ====== a1:0 a3:2 跳过2 func Iota() { const ( a1 = iota a2 = 100 a3 = iota ) fmt.Printf(\"a1:%v\\n\", a1) fmt.Printf(\"a2:%v\\n\", a2) fmt.Printf(\"a3:%v\\n\", a3) } ====== a1:0 a2:100 a3:2 数据类型 指针、数组、切片类型\nfunc DataType() { num := 200 p := \u0026num fmt.Printf(\"%T\\n\", p) //\t*int 指针 arr := [3]int{1, 2, 3} fmt.Printf(\"%T\\n\", arr) //[3]int 数组 arr1 := []int{1, 2, 3} fmt.Printf(\"%T\\n\", arr1) //[]int 切片 } bool 类型 bool 类型：不能使用 0 和 非0 表示真假\n//\tBool b := 0 if b { //失败！ fmt.Println(b) } 数字类型 go 语言支持整型和浮点型数字，并且原生支持复数，其中位的运算采用补码。\n有基于架构的类型，例如：int、uint和uintptr。 这些类型的长度都是根据运行程序所在的操作系统类型所决定的：\nint和uint在32位操作系统上，它们均使用32位(4个字节)，在64位操作系统上，它们均使用64位(8个字节)。\nuintptr的长度被设定为足够存放一个指针即可。\ngo语言中没有float类型。(Go语言中只有float32和float64)\n没有 double 类型。\n与操作系统架构无关的类型都有固定的大小，并在类型的名称中就可以看出来。\n挺多的就不一一测了。\n//\t数字类型 var i8 int8 fmt.Printf(\"%T %db %v~%v\\n\", i8, unsafe.Sizeof(i8), math.MinInt8, math.MaxInt8) //int8 1b -128~127 var i int fmt.Printf(\"%T %db %v~%v\\n\", i, unsafe.Sizeof(i), math.MinInt, math.MaxInt) //int 8b -9223372036854775808~9223372036854775807 字符串 反引号可换行\n字符串连接 加号 使用 fmt.Sprintf() 使用 strings.Join() 使用 buffer.WriteString() //\tString str1 := \"Hello,\" str2 := \"Tom\" sprintf := fmt.Sprintf(\"%s%s\", str1, str2) fmt.Println(sprintf) //\tstrings.Join join := strings.Join([]string{\"Hello\", \"Amy\"}, \",\") fmt.Println(join)\t//\tbuffer.WriteString var buffer bytes.Buffer buffer.WriteString(\"Hello\") buffer.WriteString(\",\") buffer.WriteString(\"DaMing\") fmt.Printf(\"%v\\n\", buffer.String()) 1、golang里面的字符串都是不可变的，每次运算都会产生一个新的字符串，所以会产生很多临时的无用的字符串，不仅没有用，还会给带来额外的负担，所以性能比较差。\n2、内部使用[]byte实现，不像直接运算符这种会产生很多临时的字符串，但是内部的逻辑比较复杂，有很多额外的判断，还用到了interface，所以性能也不是很好\n3、join会先根据字符串数组的内容，计算出一个拼接之后的长度，然后申请对应大小的内存，一个一个字符串填入，在已有一个数组的情况下，这种效率会很高，但是本来没有，去构造这个数据的代价也不小。\n4、这个比较理想，可以当成可变字符使用，对内存的增长也有优化，如果能预估字符串的长度，还可以用buffer.Grow()接口来设置capacity\n字符串切片操作 // 字符切片 str3 := \"Hello world!\" m, n := 3, 6 println(str3[m]) println(str3[:m]) // [0,3) println(str3[m:n]) println(str3[:n]) 字符串函数 格式化输出 https://pkg.go.dev/fmt?utm_source=godoc\nhttps://www.cnblogs.com/yinzhengjie/p/7680829.html\n通用：\n1 %v 值的默认格式表示。当输出结构体时，扩展标志（%+v）会添加字段名 2 %#v 值的Go语法表示 3 %T 值的类型的Go语法表示 4 %% 百分号 //\t格式化输出 user := User{ Name: \"David\", Age: 20, Gender: \"male\", } fmt.Printf(\"%v\\n\", user) // {David 20 male} fmt.Printf(\"%#v\\n\", user) // Base.User{Name:\"David\", Age:20, Gender:\"male\"} 布尔值：\n%t 单词true或false 整数：\n1 %b 表示为二进制 2 %c 该值对应的unicode码值[char] 3 %d 表示为十进制 4 %o 表示为八进制 5 %q 该值对应的单引号括起来的go语法字符字面值，必要时会采用安全的转义表示 6 %x 表示为十六进制，使用a-f 7 %X 表示为十六进制，使用A-F 8 %U 表示为Unicode格式：U+1234，等价于\"U+%04X\" 浮点数、复数的两个组分：\n1 %b 无小数部分、二进制指数的科学计数法，如-123456p-78；参见strconv.FormatFloat %e 科学计数法，如-1234.456e+78 %E 科学计数法，如-1234.456E+78 %f 有小数部分但无指数部分，如123.456 %F 等价于%f %g 根据实际情况采用%e或%f格式（以获得更简洁、准确的输出） 2 %G 根据实际情况采用%E或%F格式（以获得更简洁、准确的输出） 字符串和[]byte：\n%s 直接输出字符串或者[]byte %q 该值对应的双引号括起来的go语法字符串字面值，必要时会采用安全的转义表示 %x 每个字节用两字符十六进制数表示（使用a-f） %X 每个字节用两字符十六进制数表示（使用A-F） 指针：\n%p 表示为十六进制，并加上前导的0x 没有verb %u。整数如果是无符号类型自然输出也是无符号的。类似的，也没有必要指定操作数的尺寸（int8，int64）。\n宽度通过一个紧跟在百分号后面的十进制数指定，如果未指定宽度，则表示值时除必需之外不作填充。精度通过（可能有的）宽度后跟点号后跟的十进制数指定。如果未指定精度，会使用默认精度；如果点号后没有跟数字，表示精度为0。举例如下：\n%f: 默认宽度，默认精度 %9f 宽度9，默认精度 %.2f 默认宽度，精度2 %9.2f 宽度9，精度2 %9.f 宽度9，精度0 宽度和精度格式化控制的是Unicode码值的数量（不同于C的printf，它的这两个因数指的是字节的数量）。两者任一个或两个都可以使用’‘号取代，此时它们的值将被对应的参数（按’‘号和verb出现的顺序，即控制其值的参数会出现在要表示的值前面）控制，这个操作数必须是int类型。\n对于大多数类型的值，宽度是输出的最小字符数，如果必要是会用空格填充。对于字符串，宽度是输出字符数目的最低数量，如果必要会截断字符串。\n对于整数，宽度和精度都设置输出总长度。采用精度时表示右对齐并用0填充，而宽度默认表示用空格填充。\n对于浮点数，宽度设置输出总长度；精度设置小数部分长度（如果有的话），除了%g/%G，此时精度设置总的数字个数。例如，对数字123.45，格式%6.2f 输出123.45；格式%.4g输出123.5。%e和%f的默认精度是6，%g的默认精度是可以将该值区分出来需要的最小数字个数。\n对复数，宽度和精度会分别用于实部和虚部，结果用小括号包裹。因此%f用于1.2+3.4i输出(1.200000+3.400000i)。\n其它flag：\n1 + 总是输出数值的正负号；对%q（%+q）会生成全部是ASCII字符的输出（通过转义）； 2 - 在输出右边填充空白而不是默认的左边（即从默认的右对齐切换为左对齐）； 3 # 切换格式： 4 八进制数前加0（%#o），十六进制数前加0x（%#x）或0X（%#X），指针去掉前面的0x（%#p）； 5 对%q（%#q），如果strconv.CanBackquote返回真会输出反引号括起来的未转义字符串； 6 对%U（%#U），如果字符是可打印的，会在输出Unicode格式、空格、单引号括起来的go字面值； 7 ' ' 对数值，正数前加空格而负数前加负号； 8 对字符串采用%x或%X时（% x或% X）会给各打印的字节之间加空格； 9 0 使用0而不是空格填充，对于数值类型会把填充的0放在正负号后面； verb会忽略不支持的flag。例如，因为没有十进制切换模式，所以%#d和%d的输出是相同的。\n对每一个类似Printf的函数，都有对应的Print型函数，该函数不接受格式字符串，就效果上等价于对每一个参数都是用verb %v。另一个变体Println型函数会在各个操作数的输出之间加空格并在最后换行。\n不管verb如何，如果操作数是一个接口值，那么会使用接口内部保管的值，而不是接口，因此：\n1 /* 2 #!/usr/bin/env gorun 3 @author :yinzhengjie 4 Blog:http://www.cnblogs.com/yinzhengjie/tag/GO%E8%AF%AD%E8%A8%80%E7%9A%84%E8%BF%9B%E9%98%B6%E4%B9%8B%E8%B7%AF/ 5 EMAIL:y1053419035@qq.com 6 */ 7 8 package main 9 10 import \"fmt\" 11 12 func main() { 13 var name interface{} = \"yinzhengjie\" 14 fmt.Printf(\"My name is %v !\\n\", name) 15 var age interface{} = 18 16 fmt.Printf(\"I am [%d] years old。\",age) 17 } 18 19 20 21 #以上代码执行结果如下： 22 My name is yinzhengjie ! 23 I am [18] years old。 除了verb %T和%p之外；对实现了特定接口的操作数会考虑采用特殊的格式化技巧。按应用优先级如下：\n\\1. 如果操作数实现了Formatter接口，会调用该接口的方法。Formatter提供了格式化的控制。\n\\2. 如果verb %v配合flag #使用（%#v），且操作数实现了GoStringer接口，会调用该接口。\n如果操作数满足如下两条任一条，对于%s、%q、%v、%x、%X五个verb，将考虑：\n\\3. 如果操作数实现了error接口，Error方法会用来生成字符串，随后将按给出的flag（如果有）和verb格式化。\n\\4. 如果操作数具有String方法，这个方法将被用来生成字符串，然后将按给出的flag（如果有）和verb格式化。\n复合类型的操作数，如切片和结构体，格式化动verb递归地应用于其每一个成员，而不是作为整体一个操作数使用。因此%q会将[]string的每一个成员括起来，%6.2f会控制浮点数组的每一个元素的格式化。\n为了避免可能出现的无穷递归，如：\n1 type X string 2 func (x X) String() string { return Sprintf(\"\u003c%s\u003e\", x) } 应在递归之前转换值的类型：\n1 func (x X) String() string { return Sprintf(\"\u003c%s\u003e\", string(x)) } 显式指定参数索引：\n在Printf、Sprintf、Fprintf三个函数中，默认的行为是对每一个格式化verb依次对应调用时成功传递进来的参数。但是，紧跟在verb之前的[n]符号表示应格式化第n个参数（索引从1开始）。同样的在’*‘之前的[n]符号表示采用第n个参数的值作为宽度或精度。在处理完方括号表达式[n]后，除非另有指示，会接着处理参数n+1，n+2……（就是说移动了当前处理位置）。例如：\n1 fmt.Sprintf(\"%[2]d %[1]d\\n\", 11, 22) 会生成\"22 11\"，而：\n1 fmt.Sprintf(\"%[3]*.[2]*[1]f\", 12.0, 2, 6), 等价于：\n1 fmt.Sprintf(\"%6.2f\", 12.0), 会生成\" 12.00\"。因为显式的索引会影响随后的verb，这种符号可以通过重设索引用于多次打印同一个值：\n1 fmt.Sprintf(\"%d %d %#[1]x %#x\", 16, 17) 会生成\"16 17 0x10 0x11\"\n格式化错误：\n如果给某个verb提供了非法的参数，如给%d提供了一个字符串，生成的字符串会包含该问题的描述，如下所例：\n1 错误的类型或未知的verb：%!verb(type=value) 2 Printf(\"%d\", hi): %!d(string=hi) 3 太多参数（采用索引时会失效）：%!(EXTRA type=value) 4 Printf(\"hi\", \"guys\"): hi%!(EXTRA string=guys) 5 太少参数: %!verb(MISSING) 6 Printf(\"hi%d\"): hi %!d(MISSING) 7 宽度/精度不是整数值：%!(BADWIDTH) or %!(BADPREC) 9 Printf(\"%.*s\", 4.5, \"hi\"): %!(BADPREC)hi 10 没有索引指向的参数：%!(BADINDEX) 11 Printf(\"%*[2]d\", 7): %!d(BADINDEX) 12 Printf(\"%.[2]d\", 7): %!d(BADINDEX) 所有的错误都以字符串\"%!“开始，有时会后跟单个字符（verb标识符），并以加小括弧的描述结束。\n如果被print系列函数调用时，Error或String方法触发了panic，fmt包会根据panic重建错误信息，用一个字符串说明该panic经过了fmt包。例如，一个String方法调用了panic(“bad”)，生成的格式化信息差不多是这样的：\n%!s(PANIC=bad) %!s指示表示错误（panic）出现时的使用的verb。\n运算符 自增 \u0026 自减 不用于 表达式中。\n//num2:=num++ + 5 num3:=num + 5 fmt.Println(num3) 流程控制 if switch case ==可以多个、可以是表达式==\ncase 里面不需要 break ，若想继续下去 加 fallthrough\nfunc Control() { str := \"b\" checkGrade(str) } func checkGrade(grade string) { //\tswitch switch grade { case \"a\", \"b\": fmt.Printf(\"Very Good\") case \"c\": fmt.Printf(\"Good\") default: fmt.Println(\"normal\") } } 循环 for range 可以使用for range遍历数组、切片、字符串、map及通道(channel)。\n通过for range遍历的返回值有以下规律：\n1.数组、切片、字符串返回索引和值。 2.map返回键和值。 3.通道(channel)只返回通道内的值。\narr := [...]int{1, 2, 3} //[3]int //arr := []int{1, 2, 3} //[]int for i, v := range arr { fmt.Printf(\"%v:%v\\n\", i, v) } fmt.Printf(\"%T\\n\", arr) break：在循环中，跳出一层循环\ncontinue\ngoto\n数组 package Base import \"fmt\" func Array() { //\t数组列表初始化 var arr = [5]int{4, 5, 6, 7, 8} fmt.Println(arr) //\t使用 ... , 让他自行推断长度 var arr1 = [...]int{4, 5, 6, 7, 8, 9, 10} fmt.Println(arr1) //\t指定索引值的方式初始化 var arr2 = [...]int{0: 1, 2: 2, 3: 4} fmt.Println(arr2) } 切片 前面我们学习了数组，数组是固定长度，可以容纳相同数据类型的元素的集合。当长度固定时，使用还是带来一些限制，比如：我们申请的长度太大浪费内存，太小又不够用。\n鉴于上述原因，我们有了go语言的切片，可以把切片理解为，可变长度的数组，其实它底层就是使用数组实现的，增加了自动扩容功能。切片 (slice) 是一个拥有相同类型元素的可变长度的序列。\nfunc Slice() { //\t数组 var arr = [...]int{3, 4, 5, 6} fmt.Println(arr) //\t切片 var slice = []int{3, 4, 5, 6} fmt.Println(slice) // 通过 make var sliceByMake = make([]int, 5) fmt.Println(sliceByMake) println(\"len\", len(sliceByMake)) println(\"cap\", cap(sliceByMake)) } tips headNum := 6 // 这里创建了 6 个 0 var UidIntArr = make([]int, headNum) // right var UidIntArr = make([]int, 0, headNum) 添加、删除、Copy 删除：连续容器的元素删除无论在任何语言中，都要将删除点前后的元素移动到新的位置，随着元素的增加，这个过程将会变得极为耗时，因此，当业务需要大量、频繁地从一个切片中删除元素时，如果对性能要求较高的话，就需要考虑更换其他的容器了（如双链表等能快速从删除点删除元素）。\n//\tadd var slice1 = []int{1, 2, 3, 4, 5} fmt.Println(\"before add\", slice1) slice1 = append(slice1, 6) slice1 = append(slice1, 6) slice1 = append(slice1, 6) fmt.Println(\"after add\", slice1) //before add [1 2 3 4 5] //after add [1 2 3 4 5 6 6 6] //\tdelete fmt.Println(\"before delete\", slice1) // 假设想删除 下标为 4 的元素 slice1 = append(slice1[:4], slice1[5:]...) //\u003c======= fmt.Println(\"after delete\", slice1) //\tcopy var slice3 = []int{1, 2, 3, 4, 5} var slice4 []int copy(slice4, slice3) fmt.Println(\"slice4\", slice1) map map是一种key:value键值对的数据结构容器。map内部实现是哈希表(hash)。 map最重要的一点是通过key来快速检索数据，key类似于索引，指向数据的值。 map是引用类型的。\n初始化 func MapInit() { map1 := map[string]string{ \"name\": \"Tom\", \"age\": \"12\", \"gender\": \"male\", } fmt.Println(map1) //map[age:12 gender:male name:Tom] map2 := make(map[string]string, 5) map2[\"name\"] = \"Amy\" map2[\"age\"] = \"13\" map2[\"gender\"] = \"female\" fmt.Println(map2) //map[age:13 gender:female name:Amy] } 取值、遍历 //\t通过 key 取值 key := \"name\" value := map2[key] fmt.Println(\"key = name , value = \", value) //key = name , value = Amy //\t判断一个map是否含有某个 key 值 value1, ok := map2[key] fmt.Printf(\"key = name , isExist = %t , value = %v\\n\", ok, value1) //key = name , isExist = true , value = Amy //\t遍历 for k, v := range map2 { fmt.Printf(\"%v:%v\\n\", k, v) } //name:Amy //age:13 //gender:female function go语言中函数特性\n1.go语言中有3种函数：普通函数、匿名函数（没有名称的函数）、方法（定义在struct上的函数）。\n2.go语言中不允许函数重载(overload),也就是说不允许函数同名。\n3.go语言中的函数不能嵌套函数，但可以嵌套匿名函数。\n4.函数是一个值，可以将函数赋值给变量，使得这个变量也成为函数。\n5.函数可以作为参数传递给另一个函数。\n6.函数的返回值可以是一个函数。\n7.函数调用的时候，如果有参数传递给函数，则先拷贝参数的副本，再将副本传递给函数。\n8.函数参数可以没有名称。\n返回值 1,return关键字中指定了参数时，返回值可以不用名称。如果return省略参数，则返回值部分必须带名称\n2.当返回值有名称时，必须使用括号包围，逗号分隔，即使只有一个返回值\n3.但即使返回值命名了，return中也可以强制指定其它返回值的名称，也就是说return的优先级更高\n4.命名的返回值是预先声明好的，在函数内部可以直接使用，无需再次声明。命名返回值的名称不能和函数参 数名称相同，否则报错提示变量重复定义\n5.return中可以有表达式，但不能出现赋值表达式，这和其它语言可能有所不同。例如return a+b是正确 的，但return c=a+b是错误的。\nfunc Function() { name, age := fun1() fmt.Printf(\"name:%v,age:%v\\n\", name, age) } func fun1() (name string, age int) { name = \"Amy\" age = 19 return //\t等价于 ==\u003e return name, age } 参数 值传递 【因为会创建函数副本】\n注意 ：map、slice、interface、channel这些数据类型本身就是指针类型的，所以就算是拷贝传值也是拷贝的指针，拷贝后的参数仍然指向底层数据结构，所以修改它们可能会影响外部数据结构的值。\nfunc Function() { a := []int{1, 2} fun2(a) fmt.Println(a[0]) // 100 } func fun2(a []int) { a[0] = 100 } 变长参数 func Function() { fun3(\"Amy\", \"Beijing\", \"23\") } func fun3(args ...string) { for i, arg := range args { fmt.Printf(\"%v:%v\\n\", i, arg) } } 0:Amy 1:Beijing 2:23 高阶函数 函数可以作为一个函数的参数、返回值。\n匿名函数 闭包 闭包可以理解成定义在一个函数内部的函数。在本质上，闭包是将函数内部和函数外部连接起来的桥梁。或者说是函数和其引用环境的组合体。 闭包指的是一个函数和与其相关的引用环境组合而成的实体。简单来说，==闭包=函数+引用环境==。\n变量f是一个函数并且它引用了其外部作用域中的x变量，此时f就是一个闭包。在f的生命周期内，变量x也一直有效。\nfunc Closure() { f := add() println(f(10)) println(f(20)) println(f(30)) // 10 // 30 // 60 //\t变量逃逸，从栈去到堆 } func add() func(int) int { var x int return func(y int) int { x += y return x } } 递归 函数内部调用函数自身的函数称为递归函数。 使用递归函数最重要的三点：\n1.递归就是自己调用自己。 2.必须先定义函数的退出条件，没有退出条件，递归将成为死循环。 3.go语言递归函数很可能会产生一大堆的goroutine,也很可能会出现栈空间内存谥出问题。\ndefer go语言中的defer语句会将其后面跟随的语句进行延迟处理。\n在defer归属的函数即将返回时，将延迟处理的语句按defer定义的逆序进行执行，\n也就是说，先被defer的语句最后被执行，最后被defer的语句，最先被执行。\ndefer’特性\n1.关键字defer用于注册延迟调用。 2.这些调用直到return前才被执。因此，可以用来做资源清理。 3.多个defer语句，按先进后出的方式执行。 4.defer语句中的变量，在defer声明时就决定了。\ndefer用途 1.关闭文件句柄 2.锁资源释放 3.数据库连接释放\ninit函数 golang有一个特殊的函数init函数，先于main函数执行，实现包级别的一些初始化操作。\ninit函数的主要特点 ·init函数先于main函数==自动执行==，不能被其他函数调用： ·init函数没有输入参数、返回值： ·每个包可以有多个init函数： ·包的每个源文件也可以有多个init函数，这点比较特殊： ·同一个包的init执行顺序，golang没有明确定义，编程时要注意程序不要依赖这个执行顺序。 ·不同包的it函数按照包，导入的依赖关系决定执行顺序。 golang初始化顺序 初始化顺序：变量初始化-\u003einit()-\u003emain()\n指针 G0语言中的函数传参都是值拷贝，当我们想要修改某个变量的时候，我们可以创建一个指向该变量地址的指针变 量。传递数据使用指针，而无须拷贝数据。\n类型指针不能进行偏移和运算。\nG0语言中的指针操作非常简单，只需要记住两个符号：\u0026（取地址）和 *（根据地址取值）。\n指针地址和指针类型 每个变量在运行时都拥有一个地址，这个地址代表变量在内存中的位置。\nGo语言中使用\u0026字符放在变量前面对变量进行取地址操作。\nGo语言中的值类型(int、float、bool、string、array、struct)都有对应的指针类型，如：*int、*int64、*string等。\n指针语法 一个指针变量指向了一个值的内存地址。\n(也就是我们声明了一个指针之后，可以像变量赋值一样，把一个值的内存地址放入到指针当中。)\n类似于变量和常量，在使用指针前你需要声明指针。指针声明格式如下：\nvar var_name *var-type var-type: 为指针类型 var-name: 为指针变量名 *：用于指定变量是作为一个指针 指针数组 表示数组里面的元素的类型是指针类型\n定义语法\nvar ptr [MAX]*int; 例子\nfunc Pointer() { var arr = [3]int{1, 2, 3} var pArr [3]*int for i := 0; i \u003c len(arr); i++ { pArr[i] = \u0026arr[i] } for i := 0; i \u003c len(arr); i++ { println(pArr[i]) } //0xc000143f38 //0xc000143f40 //0xc000143f48 } 类型定义和类型别名 在介绍结构体之前，我们先来看看什么是类型定义和类型别名。\ngo语言类型定义 类型定义的语法\ntype NewType Type 实例\n//类型定义 type MyInt int //i为MyInt类型 var i MyInt i = 100 fmt.Printf(\"i:%v i:%T\\n\", i, i) //\ti:100 i:Base.MyInt 类型别名 //类型别名 type MyInt1 = int var i1 MyInt1 i1 = 100 fmt.Printf(\"i:%v i:%T\\n\", i1, i1) //\ti:100 i:int 结构体 go语言没有面向对象的概念了，但是可以使用结构体来实现面向对象编程的一些特性，例如：继承、组合等特 性。\n结构体的定义 结构体的定义和类型定义类似，只不过多了一个struct关键字：\ntype Person struct { id int name string age int email string } func Struct() { // 初始化 person1 := Person{ 2, \"Amy\", 23, \"hello@qq.com\", } person2 := Person{ id: 3, name: \"Tom\", age: 20, email: \"world@qq.com\", } fmt.Printf(\"%#v\\n\", person1) fmt.Printf(\"%#v\\n\", person2) } 结构体指针 var p1Point *Person p1Point = \u0026person1 fmt.Printf(\"%p\\n\", p1Point) // 通过 new var p2Point = new(Person) fmt.Printf(\"%p\\n\", p2Point) 结构体作为函数参数 go结构体可以像普通变量一样，作为函数的参数，传递给函数，这里分为两种情况：\n直接传递结构体，这是是一个副本（拷贝），在函数内部不会改变外面结构体内容。 传递结构体指针，这时在函数内部，能够改变外部结构体内容。 直接传递结构体 这是值传递，将拷贝一份，不会改变原来的数据\n传递结构体指针 这就会修改原来的数据了\ntype Person struct { id int name string age int email string } func Struct() { // 初始化 person1 := Person{ 2, \"Amy\", 23, \"hello@qq.com\", } fmt.Printf(\"%#v\\n\", person1) showPerson(\u0026person1) fmt.Printf(\"%#v\\n\", person1) //Base.Person{id:2, name:\"Amy\", age:23, email:\"hello@qq.com\"} //Base.Person{id:2, name:\"Amy\", age:1000, email:\"hello@qq.com\"} } func showPerson(person *Person) { person.age = 1000 } 嵌套结构体 go语言没有面向对象编程思想，也没有继承关系，但是可以通过结构体嵌套来实现这种效果。\n下面通过实例演示如何实现结构体嵌套，加入有一个人Person结构体，这个人还养了一个宠物Dog结构体。\ntype Dog struct { name string color string age int } type Person struct { dog Dog name string age int } 方法 gp语言没有面向对象的特性，也没有类对象的概念。\n但是，可以使用结构体来模拟这些特性，我们都知道面向对象里面有类方法等概念。\n我们也可以声明一些方法，属于某个结构体。\n方法的语法 Go中的方法，是一种特殊的函数，定义于struct之上（与struct关联、绑定），被称为struct的接受者(receiver))。\n通俗的讲，方法就是有接收者的函数。\n一个方法和一个函数非常相似，多了一个接受类型。\n语法格式如下： type mytype struct{} func (recv mytype)my_method(para)return_type {} func (recv *mytype)my_method(para)return_type {} mytype:定义一个结构体 recv:接受该方法的结构体(receiver) my-method:方法名称 para:参数列表 return-type:返回值类型 实例\ntype Person struct { name string age int } func (p Person) eat() { fmt.Printf(\"%v is eating.\\n\", p.name) } func (p Person) sleep() { fmt.Printf(\"%v is sleepy.\\n\", p.name) } func Struct() { person := Person{ name: \"Tom\", age: 43, } person.eat() person.sleep() } 方法的注意事项 方法的receiver type并非一定要是struct类型，type定义的类型别名、slice、.map、channel、.func类型等都可 以。 struct结合它的方法就等价于面向对象中的类。只不过struct可以和它的方法分开，并非一定要属于同一个文 件，但必须属于同一个包。 方法有两种接收类型：(T Type)和(T*Type),它们之间有区别。 方法就是函数，所以Go中没有方法重载(overload)的说法，也就是说同一个类型中的所有方法名必须都唯一。 如果receiver是一个指针类型，则会自动解除引用。 方法和type是分开的，意味着实例的行为(behavior)和数据存储(field)是分开的，但是它们通过receiver建立起 关联关系。 方法接收者类型 结构体实例，有值类型和指针类型，那么方法的接收者是结构体，那么也有值类型和指针类型。\n区别就是接收者是否复制结构体副本。==值类型复制，指针类型不复制。==\npackage Base import \"fmt\" type Person struct { name string age int } func (p Person) modifyName() { p.name = \"hello\" } func (p *Person) modifyName1() { p.name = \"hello\" } func Struct() { person := Person{ name: \"Tom\", age: 43, } fmt.Println(person) person.modifyName() fmt.Println(person) person.modifyName1() fmt.Println(person) //{Tom 43} //{Tom 43} //{hello 43} } 接口 接口像是一个公司里面的领导，他会定义一些通用规范，只设计规范，而不实现规范。\ngo语言的接口，是一种新的类型定义，它把所有的具有共性的方法定义在一起，任何其他类型只要实现了这些方 法就是实现了这个接口。\n语法格式和方法非常类似。\ndb_init package Dao import ( \"log\" \"server/Model\" \"gorm.io/driver/mysql\" \"gorm.io/gorm\" \"gorm.io/gorm/schema\" ) type Manager interface { Register(userinfo Model.User) error GetUser(userId uint64) (Model.User, error) IsExist(username string) (Model.User, error) GetPostListByUserId(userId uint64) ([]Model.Post, error) UpdateProfileById(userId uint64, data *Model.User) error GetCommunityList() ([]Model.Community, error) StoreArticle(postInfo Model.Post) error GetList(latestTime int64) ([]Model.Post, error) GetPostById(postId int64) (Model.Post, error) GetUsernameById(AuthorId uint64) (author string, err error) GetCommunityNameById(CommunityId uint64) (CommunityName string, err error) DeletePostById(postId int64) error AddComment(comment *Model.Comment) } type manager struct { db *gorm.DB } var Mgr Manager func init() { dsn := \"root:Admin666@tcp(127.0.0.1:3306)/blogserver?charset=utf8mb4\u0026parseTime=True\u0026loc=Local\" db, err := gorm.Open(mysql.Open(dsn), \u0026gorm.Config{ NamingStrategy: schema.NamingStrategy{ SingularTable: true, }, }) if err != nil { log.Fatal(\"Failed to init db:\", err) } Mgr = \u0026manager{db: db} if err := db.AutoMigrate(\u0026Model.Post{}); err != nil { log.Fatal(err) } } dao.user package Dao import ( \"server/Model\" ) func (mgr manager) Register(userinfo Model.User) error { result := mgr.db.Create(\u0026userinfo) return result.Error } func (mgr manager) GetUser(userId uint64) (Model.User, error) { var user Model.User if err := mgr.db.Select(\"user_id\", \"username\", \"company\", \"user_page\", \"user_introduce\", \"position\", \"created_at\"). Where(\"user_id=?\", userId).Find(\u0026user).Error; err != nil { return user, err } return user, nil } func (mgr manager) IsExist(username string) (Model.User, error) { var userinfo Model.User result := mgr.db.Where(\"username=?\", username).Find(\u0026userinfo) return userinfo, result.Error } func (mgr manager) UpdateProfileById(userId uint64, data *Model.User) error { var userinfo Model.User var maps = make(map[string]interface{}) maps[\"username\"] = data.Username maps[\"user_page\"] = data.UserPage maps[\"company\"] = data.Company maps[\"user_introduce\"] = data.UserIntroduce maps[\"position\"] = data.Position err := mgr.db.Model(\u0026userinfo).Where(\"user_id = ? \", userId).Updates(maps).Error return err } 接口和类型的关系 1.一个类型可以实现多个接口 2.多个类型可以实现同一个接口（多态）\n一个类型实现多个接口\n例如：有一个Player接口可以播放音乐，有一个Video接口可以播放视频，\n一个手机Mobile实现这两个接口，既可以播放音乐，又可以播放视频。\n接口嵌套 package Base import \"fmt\" type Fly interface { FlyFunc() } type Swim interface { SwimFunc() } type FlyFish interface { Fly Swim } type Fish struct { } func (f Fish) FlyFunc() { fmt.Println(\"Fish is flying.\") } func (f Fish) SwimFunc() { fmt.Println(\"Fish is swimming.\") } func Interface() { var ff FlyFish // 此处如果不实现方法会报错 ff = Fish{} ff.SwimFunc() ff.FlyFunc() } 通过接口实现OCP设计原则 面向对象的可复用设计的第一块基石，便是所谓的”开-闭“原则(Open-Closed Principle,常缩写为OCP)。\n虽然，go不是面向对象语言，但是也可以模拟实现这个原则。\n实例 接口:\n特殊的数据类型\n方法定义的集合\n方法名(形参类型)返回值类型\n提高代码的复用率\n接口本身不能绑定方法\n保存的是：值+原始类型\n5.2.2 实现\n一个类型实现了接口的所有方法\n即实现了该接口\ngo中无需“implements”关键字\n5.2.3 类型选择\nswitch…case + interface.(type)\n.(type)不能在 switch…case 外使用\n5.2.4 类型断言\n还原为原始类型 interface.(Type)\n如果接口没有保存类型，则会报错\n可返回两个值\nvalue, ok := interface.(Type)\n5.2.5 空接口\ninterface{}\n空接口可保存任何类型\n5.2.6 nil问题\nnil 值：有类型没有值，接口本身并不是 nil，可以处理\nnil 接口：即没有保存值，也没有保存类型，使用时会报错\n//5.2 接口 type textMes struct { Type string Text string } func (tm *textMes) setText() { tm.Text = \"hello\" } type imgMes struct { Type string Img string } func (im *imgMes) setImg() { im.Img = \"清明上河图\" } type Mes interface { setType() } func (tm *textMes) setType() { tm.Type = \"文字消息\" } func (im *imgMes) setType() { im.Type = \"图片消息\" } func SendMes(m Mes) { m.setType() switch mptr := m.(type) { case *textMes: mptr.setText() case *imgMes: mptr.setImg() } fmt.Println(\"m=\", m) } func Interface() { tm := textMes{} SendMes(\u0026tm) im := imgMes{} SendMes(\u0026im) var n1 int = 1 n1interface := interface{}(n1) n2, ok := n1interface.(int) if ok { fmt.Println(\"n2=\", n2) } else { fmt.Println(\"类型断言失败\") } } 继承 golang本质上没有ocp的概念，也没有继承的概念，但是可以通过结构体嵌套实现这个特性。\ngolang 中的继承是通过结构体中的==匿名字段==来实现\n例：定义一个 BaseNum 对象 (结构体)，作为父类，Add 和Sub 对象(结构体)中包含了BaseNum 匿名字段， 此时 Add 和Sub 就是BaseNum的子类\ntype BaseNum struct { num1 int num2 int } // BaseNum 即为父类型名称 type Add struct { BaseNum } //加法子类, 定义加法子类的主要目的, 是为了定义对应子类的方法 type Sub struct { BaseNum } //减法子类 构造函数 golang没有构造函数的概念，可以使用函数来模拟构造函数的的功能。\npackage Base import \"fmt\" type Person1 struct { name string age int } func NewPerson(name string, age int) (*Person1, error) { if name == \"\" { return nil, fmt.Errorf(\"name不能为空\") } if age \u003c 0 { return nil, fmt.Errorf(\"age不能小于g\") } return \u0026Person1{name: name, age: age}, nil } func Constructor() { person, err := NewPerson(\"tom\", 20) if err != nil { fmt.Printf(\"err:%v\\n\", err) } fmt.Printf(\"person:%v\\n\", *person) } 包管理工具go module go modules是golang1.11新加的特性，用来管理模块中包的依赖关系。\ngo mod使用方法\n初始化模块\tgo mod init\u003c项目模块名称\u003e\n依赖关系处理，根据go.mod文件\tgo mod tidy\n将依赖包复制到项目下的vendor目录\tgo mod vendor\n如果包被屏蔽（墙），可以使用这个命令，随后使用go build-mod=vendor编译\n显示依赖关系\tgo list -m all\n显示详细依赖关系\tgo list -m -json all\n下载依赖\tgo mod download [path@version] [path@version]是非必写的\n并发编程-\u003e协程 Golang中的并发是函数相互独立运行的能力。Goroutines是并发运行的函数。\nGolang提供了Goroutines作为并发处理操作的一种方式。\n创建一个协程非常简单，就是在一个任务函数前面添加一个go关键字：\ngo task() Q1 select …… case //5.3 协程 var ( c int lock sync.Mutex ) func PrimeNum(n int) { for i := 2; i \u003c n; i++ { if n%i == 0 { return } } fmt.Printf(\"%v\\t\", n) lock.Lock() c++ lock.Unlock() } func Goroutine() { for i := 2; i \u003c 100001; i++ { go PrimeNum(i) } var key string fmt.Scanln(\u0026key) fmt.Printf(\"\\n共找到%v个素数\\n\", c) } //5.4 channel func pushNum(c chan int) { for i := 0; i \u003c 100; i++ { c \u003c- i } close(c) } func pushPrimeNum(n int, c chan int) { for i := 2; i \u003c n; i++ { if n%i == 0 { return } } c \u003c- n } func Channel() { var c1 chan int = make(chan int) go pushNum(c1) // for { // v, ok := \u003c-c1 // if ok { // fmt.Printf(\"%v\\t\", v) // } else { // break // } // } for v := range c1 { fmt.Printf(\"%v\\t\", v) } var c2 chan int = make(chan int, 100) for i := 2; i \u003c 100001; i++ { go pushPrimeNum(i, c2) } Print: for { select { case v := \u003c-c2: fmt.Printf(\"%v\\t\", v) default: fmt.Println(\"所有素数已经找到\") break Print } } } 在 Go 编程语言中，select 语句用于在多个通道操作中进行选择。它可以在多个通道上等待数据到达或操作完成，并根据情况执行相应的操作。select 的结构如下：\nselect { case \u003c-channel1: // 执行 channel1 数据到达时的操作 case data := \u003c-channel2: // 执行 channel2 数据到达时的操作，并将数据存储在 data 变量中 case channel3 \u003c- data: // 执行将 data 发送到 channel3 的操作 default: // 当没有任何通道操作准备就绪时执行的操作 } 在您提供的代码中，您使用了 select 来从通道 c2 中接收数据，同时还设置了一个 default 分支。让我对您的代码进行解释：\n首先，您创建了一个缓冲通道 c2，并启动了一系列 goroutine，每个 goroutine 负责将素数推送到 c2 通道。 然后，使用一个无限循环，不断地执行 select 语句。 在 select 语句中，您使用了一个 case 分支，该分支尝试从 c2 通道接收一个整数。如果 c2 通道中有数据，它会执行相应的操作，将接收到的整数打印出来。 您还使用了一个 default 分支，这是当没有通道操作准备就绪时执行的分支。在这种情况下，它会输出 “所有素数已经找到”，并通过 break Print 语句跳出 for 循环。 总结来说，您的代码通过多个并发的 goroutine 计算素数并推送到通道中，然后使用 select 语句从通道中接收数据并进行处理。select 的作用在于允许您同时等待多个通道的数据到达，哪个通道有数据，就执行相应的操作。\n那这段代码没有 select case 可以吗？\n当您使用 select 时，是因为您希望能够同时监视多个通道，并在其中任何一个通道就绪时执行相应的操作。在您的代码示例中，您使用 select 来从通道 c2 接收数据，并在没有数据可接收时输出提示。\n如果您不需要同时监视多个通道，而只是希望从单个通道中接收数据并执行相应的操作，那么是可以省略 select 的。您可以直接使用通道的阻塞接收操作，例如：\nfor { v, ok := \u003c-c2 if !ok { fmt.Println(\"所有素数已经找到\") break } fmt.Printf(\"%v\\t\", v) } 在这个循环中，v, ok := \u003c-c2 将从通道 c2 接收数据，并将数据存储在变量 v 中。同时，ok 表示通道是否关闭，如果通道关闭了，就不再有数据可以接收了。\n然后，您可以检查 ok 的值，如果为 false，就输出提示信息并跳出循环。否则，继续执行打印操作。\n所以，您可以根据自己的需求，选择使用带有 select 的并发操作，或者直接使用通道的阻塞接收操作。\n并发编程-\u003e通道channel Go提供了一种称为通道的机制，用于在==goroutine之间==共享数据。\n当您作为goroutine执行并发活动时，需要在goroutine之间共享资源或数据，通道充当goroutine之间的管道（管道）并提供一种机制来保证同步交换。需要在声明通道时指定数据类型。我们可以共享内置、命名、结构和引用类型的值和指针。数据在通道上传递：在 任何给定时间只有一个goroutine可以访问数据项：因此按照设计不会发生数据竞争。\n根据数据交换的行为，有两种类型的通道：无缓冲通道和缓冲通道。\n无缓冲通道用于执行goroutine之间的同步通信，而缓冲通道用于执行异步通信。\n无缓冲通道保证在发送和接收发生的瞬间执行两个goroutine之间的交换。缓冲通道没有这样的保证。\n无缓冲通道（Unbuffered Channel）和缓冲通道（Buffered Channel）是 Go 语言中的两种通道类型，它们在使用方式和适用场景上有一些区别。\n无缓冲通道：\n无缓冲通道是指在发送数据到通道时，发送方会被阻塞直到接收方接收数据。同样，在接收数据时，接收方会被阻塞直到发送方发送数据。这种通道保证了数据的同步传输，发送和接收是紧密耦合的。无缓冲通道的声明方式为 make(chan T)。\n适用场景：\n在并发编程中，用于协调两个 goroutine 之间的同步操作。 当确保发送方和接收方同步工作很重要时，可以使用无缓冲通道。 缓冲通道：\n缓冲通道允许在通道中存储一定数量的数据，当通道中的数据数量达到缓冲区大小时，发送方才会被阻塞。只有在通道满了时，发送方才会被阻塞。同样，当通道中没有数据时，接收方才会被阻塞。缓冲通道的声明方式为 make(chan T, capacity)。\n适用场景：\n在解耦发送方和接收方的情况下，允许发送方发送数据到通道，然后继续执行其他操作，而不必等待接收方。 在生产者-消费者模式中，可以使用缓冲通道来平衡生产者和消费者之间的速度差异 通道由make函数创建，该函数指定chan关键字和通道的元素类型。\n这是创建无缓冲和缓冲通道的代码块：\n语法\nUnbuffered:=make(chan int)\t//整型无缓冲通道 buffered:=make(chan int,10)\t//整型有缓冲通道 使用内置函数make创建无缓冲和缓冲通道。\nmake的第一个参数需要关键字chan,然后是通道允许交换的数据类型。\npackage Base import ( \"math/rand\" \"time\" ) var channel = make(chan int) func send() { rand.Seed(time.Now().UnixNano()) random := rand.Intn(10) println(\"随机值：\", random) time.Sleep(2 * time.Second) channel \u003c- random } func GoRoutine() { defer close(channel) go send() println(\"wait...\") receive := \u003c-channel println(\"接收值：\", receive) println(\"end...\") } channel 遍历 package Base func Channel() { c := make(chan int) go func() { for i := 0; i \u003c 5; i++ { c \u003c- i } close(c) }() for v := range c { println(v) } } 并发编程-\u003eWaitGroup实现同步 查看添加WaitGroup和不添加WaitGroup的区别\npackage Base import ( \"fmt\" \"sync\" ) var wg sync.WaitGroup func showMsg(i int) { defer wg.Done() fmt.Println(i) } func GoRoutine() { for i := 0; i \u003c 10; i++ { wg.Add(1) go showMsg(i) } wg.Wait() } // StuData 请求参数验证结构 type StuData struct { File *multipart.FileHeader `form:\"file\" binding:\"required\"` } func dealStuData(row []string, buff chan map[string]string, wg *sync.WaitGroup, userList chan map[string]string, errData chan []string) { errMsg := make(map[string]string, 0) // 不能提交空数据 for _, val := range row { if val == \"\" { errMsg[\"name\"] = row[common.EStuName] errMsg[\"reason\"] = \"数据不能为空\" errData \u003c- row buff \u003c- errMsg wg.Done() return } } if row[common.EStuGender] != \"男\" \u0026\u0026 row[common.EStuGender] != \"女\" { errMsg[\"name\"] = row[common.EStuName] errMsg[\"reason\"] = \"性别格式错误\" errData \u003c- row buff \u003c- errMsg wg.Done() return } // 比对学院代码是否正确 org := common.Organization{} err := org.GetOrgByCode(row[common.EStuCollegeCode]) if err != nil { msg := fmt.Sprintf(\"查询目标学院代码错误:%v\", err) logger.Error(msg) errMsg[\"name\"] = row[common.EStuName] errMsg[\"reason\"] = msg errData \u003c- row buff \u003c- errMsg wg.Done() return } if errors.Is(err, sql.ErrNoRows) || org.Name != row[common.EStuCollege] { var msg string if org.Code != \"\" { msg = fmt.Sprintf(\"同一个学院出现不同的学院代码：正确：【%v,%v】，错误：【%v,%v】\", org.Code, org.Name, row[common.EStuCollegeCode], row[common.EStuCollege]) } else { msg = fmt.Sprintf(\"不存在代码为：%v的学院\", row[common.EStuCollegeCode]) } logger.Error(msg) errMsg[\"name\"] = row[common.EStuName] errMsg[\"reason\"] = msg errData \u003c- row buff \u003c- errMsg wg.Done() return } ab := common.AddrBook{} // 通过同步系统数据库查看企业微信中是否有对应的学院部门 collegeDep, err := ab.GetDepByDbID(row[common.EStuCollegeCode], row[common.EStuLevel]) if err != nil \u0026\u0026 !errors.Is(err, sql.ErrNoRows) { msg := fmt.Sprintf(\"查询同步系统库失败:%s\", err.Error()) logger.Error(msg) errMsg[\"name\"] = row[common.EStuName] errMsg[\"reason\"] = msg errData \u003c- row buff \u003c- errMsg wg.Done() return } // 如果对应学院部门不存在 if errors.Is(err, sql.ErrNoRows) { parentDepid, _ := strconv.Atoi(pid[row[common.EStuLevel]]) depid, err := ab.GetAndUpdateConf() if err != nil { // TODO 数据库异常概率小，故直接返回500 logger.Error(err.Error()) errMsg[\"name\"] = row[common.EStuName] errMsg[\"reason\"] = err.Error() errData \u003c- row buff \u003c- errMsg wg.Done() return } // TODO 在企业微信中新建学院部门 err = Wxapi.CreateDept(row[common.EStuCollege], int64(parentDepid), depid, depid) if err != nil { logger.Error(fmt.Sprintf(\"新建学院部门失败: %s,错误数据为:[%s],\", err.Error(), strings.Join(row, \",\"))) errMsg[\"name\"] = row[common.EStuName] errMsg[\"reason\"] = err.Error() errData \u003c- row buff \u003c- errMsg wg.Done() return } collegeDep.WxName = row[common.EStuCollege] collegeDep.WxParentID = pid[row[common.EStuLevel]] collegeDep.WxCollegeID = \"None\" collegeDep.DbID = row[common.EStuCollegeCode] collegeDep.Grade = \"None\" collegeDep.WxGrade = \"None\" collegeDep.Level = 3 // TODO 将部门信息写入数据库 err = ab.NewDep(\u0026collegeDep, row[common.EStuLevel], depid) if err != nil { msg := fmt.Sprintf(\"将部门信息写入数据库失败: %s,\", err.Error()) logger.Error(msg) // TODO 删除创建的部门 err := Wxapi.DelDept(depid) if err != nil { logger.Error(fmt.Sprintf(\"删除部门失败：%s\", err.Error())) } errMsg[\"name\"] = row[common.EStuName] errMsg[\"reason\"] = msg errData \u003c- row buff \u003c- errMsg wg.Done() return } } // 通过同步系统数据库查看企业微信中是否有对应的年级部门 gradeDep, err := ab.GetDepByParentIdAndName(collegeDep.WxID, row[common.EStuGrade], row[common.EStuLevel]) if err != nil \u0026\u0026 !errors.Is(err, sql.ErrNoRows) { msg := fmt.Sprintf(\"查询同步数据库失败: %s\", err.Error()) logger.Error(msg) errMsg[\"name\"] = row[common.EStuName] errMsg[\"reason\"] = msg errData \u003c- row buff \u003c- errMsg wg.Done() return } // 如果年级部门不存在 if errors.Is(err, sql.ErrNoRows) { parentId, _ := strconv.Atoi(collegeDep.WxID) depid, err := ab.GetAndUpdateConf() if err != nil { // TODO 数据库异常概率小，故直接返回500 logger.Error(fmt.Sprintf(\"查询同步数据库失败:%s\", err.Error())) errMsg[\"name\"] = row[common.EStuName] errMsg[\"reason\"] = err.Error() errData \u003c- row buff \u003c- errMsg wg.Done() return } // TODO 在企业微信中新建年级部门 err = Wxapi.CreateDept(row[common.EStuGrade], int64(parentId), depid, depid) if err != nil { logger.Error(fmt.Sprintf(\"新建年级部门失败: %s\", err.Error())) errMsg[\"name\"] = row[common.EStuName] errMsg[\"reason\"] = err.Error() errData \u003c- row buff \u003c- errMsg wg.Done() return } gradeDep.WxName = row[common.EStuGrade] gradeDep.WxParentID = collegeDep.WxID gradeDep.WxCollegeID = collegeDep.WxID gradeDep.DbID = \"None\" gradeDep.Grade = \"None\" gradeDep.WxGrade = \"None\" gradeDep.Level = collegeDep.Level + 1 // TODO 将部门信息写入数据库 err = ab.NewDep(\u0026gradeDep, row[common.EStuLevel], depid) if err != nil { msg := fmt.Sprintf(\"将部门信息写入数据库失败: %s,\", err.Error()) logger.Error(msg) errMsg[\"name\"] = row[common.EStuName] errMsg[\"reason\"] = msg errData \u003c- row buff \u003c- errMsg wg.Done() return } } // 先查询是否有该新生数据 bts := common.TStudent{} err1 := bts.QueryStudentByIdCard(row[common.EStuIdCard]) if err1 != nil \u0026\u0026 !errors.Is(err1, gorm.ErrRecordNotFound) { msg := fmt.Sprintf(\"查询学生信息错误:%s\", err) logger.Error(msg) errMsg[\"name\"] = row[common.EStuName] errMsg[\"reason\"] = msg errData \u003c- row buff \u003c- errMsg wg.Done() return } // 录入新生数据 ts := common.TStudent{ Name: row[common.EStuName], IdCard: row[common.EStuIdCard], StuId: row[common.EStuStuId], Gender: WxGender[row[common.EStuGender]], Birthday: row[common.EStuBirth], College: row[common.EStuCollege], CollegeCode: row[common.EStuCollegeCode], Grade: row[common.EStuGrade], Level: row[common.EStuLevel], } curUser := make(map[string]string, 0) curUser[\"name\"] = row[common.EStuName] curUser[\"idcard\"] = row[common.EStuIdCard] curUser[\"stu_id\"] = row[common.EStuStuId] curUser[\"gender\"] = WxGender[row[common.EStuGender]] curUser[\"birth\"] = row[common.EStuBirth] curUser[\"college\"] = row[common.EStuCollege] curUser[\"college_code\"] = row[common.EStuCollegeCode] curUser[\"grade\"] = row[common.EStuGrade] curUser[\"level\"] = row[common.EStuLevel] exist := false // 如果已有信息 if err1 == nil { if bts.Status == \"已核验\" { errMsg[\"name\"] = row[common.EStuName] errMsg[\"reason\"] = \"success\" buff \u003c- errMsg wg.Done() return } err := ts.UpdateStudentByIdCard(ts.IdCard) if err != nil { msg := fmt.Sprintf(\"修改学生信息失败:%s,错误数据:[%s]\", err, strings.Join(row, \",\")) logger.Error(msg) errMsg[\"name\"] = row[common.EStuName] errMsg[\"reason\"] = msg errData \u003c- row buff \u003c- errMsg wg.Done() return } exist = true } //TODO 判断中间库中是否有该研究生的信息（要从中间库中本科生，研究生，教职工表中查询） if row[common.EStuLevel] != \"本科生\" { pgStu := common.PGStudent{} originPosition, err2 := pgStu.GetStudentByIdCard(row[common.EStuIdCard]) if err2 != nil \u0026\u0026 !errors.Is(err2, sql.ErrNoRows) { logger.Error(fmt.Sprintf(\"中间库操作错误：%s\", err2)) errMsg[\"name\"] = row[common.EStuName] errMsg[\"reason\"] = err2.Error() errData \u003c- row buff \u003c- errMsg wg.Done() return } // TODO 如果该研究生信息在中间库中存在 if err2 == nil { user, err3 := Wxapi.GetUser(pgStu.StuID) if err3 != nil { msg := fmt.Sprintf(\"在企业微信中获取研究生:%s 的信息失败,ERROR:%s\", pgStu.Name, err3.Error()) logger.Error(msg) errMsg[\"name\"] = row[common.EStuName] errMsg[\"reason\"] = msg errData \u003c- row buff \u003c- errMsg wg.Done() return } var depid []int64 d, _ := strconv.Atoi(gradeDep.WxID) for _, val := range user.Departments { if val.DeptID != int64(d) { depid = append(depid, val.DeptID) } } // TODO 给企业微信中存在数据的研究生添加新部门 depid = append(depid, int64(d)) extattr := user.Extattr err4 := Wxapi.UpdateUser(pgStu.StuID, pgStu.Name, depid, WxGender[row[common.EStuGender]], extattr) if err4 != nil { msg := fmt.Sprintf(\"更新已有研究生部门失败:%s\", err4.Error()) logger.Error(msg) errMsg[\"name\"] = row[common.EStuName] errMsg[\"reason\"] = msg errData \u003c- row buff \u003c- errMsg wg.Done() return } ts.Status = \"已核验\" ts.InMidDb = \"y\" //记录该成员信息在中间库中存在 ts.OriginalPosition = originPosition curUser[\"status\"] = \"已核验\" curUser[\"in_middb\"] = \"y\" curUser[\"originPosition\"] = originPosition } } // 获取标签列表 taglist, err := Wxapi.GetTagList() if err != nil { logger.Error(fmt.Sprintf(\"获取企业微信标签列表失败:%s\", err.Error())) errMsg[\"name\"] = row[common.EStuName] errMsg[\"reason\"] = err.Error() errData \u003c- row buff \u003c- errMsg wg.Done() return } flag := false // 判断标签是否存在 tmp := strings.Replace(row[common.EStuGrade], \"级\", \"\", -1) tmp = fmt.Sprintf(\"%s/所有学院%s级部门\", row[common.EStuLevel], tmp) for _, values := range taglist.TagList { if values.TagName == tmp { flag = true break } } tagId := int64(-1) // 标签不存在 if !flag { var err error tagId, err = Wxapi.CreateTag(tmp) if err != nil { msg := fmt.Sprintf(\"创建标签失败：%s,ERR: %s\", tmp, err.Error()) logger.Error(msg) errMsg[\"name\"] = row[common.EStuName] errMsg[\"reason\"] = msg errData \u003c- row buff \u003c- errMsg wg.Done() return } } // 将对应年级部门加入到标签 if tagId != -1 { curDepid, _ := strconv.Atoi(gradeDep.WxID) err := Wxapi.AddTagUserOrDep(tagId, []string{}, []int64{int64(curDepid)}) if err != nil { msg := fmt.Sprintf(\"为部门%v添加标签：[%v]失败，ERR: %s\", gradeDep.WxID, tmp, err.Error()) logger.Error(msg) errMsg[\"name\"] = row[common.EStuName] errMsg[\"reason\"] = msg errData \u003c- row buff \u003c- errMsg wg.Done() return } } errMsg[\"name\"] = row[common.EStuName] errMsg[\"reason\"] = \"success\" if !exist { userList \u003c- curUser } buff \u003c- errMsg wg.Done() } func (st *StuHandle) ImportStuData(context *gin.Context) { var resp = gin.H{ \"status\": 200, \"msg\": \"操作成功\", \"err_data_url\": \"\", } var form StuData if err := context.ShouldBind(\u0026form); err != nil { logger.Error(err.Error()) Response(context, http.StatusBadRequest, \"请求不合法\", resp) return } tmpFile := `./fileTmp/test.xlsx` if _, err := os.Stat(tmpFile); os.IsNotExist(err) { logger.Info(\"文件不存在\") } else { logger.Info(\"文件存在\") err := os.Remove(tmpFile) if err != nil { msg := fmt.Sprintf(\"删除文件失败: %s\", err) logger.Error(msg) Response(context, http.StatusInternalServerError, \"操作失败，请稍后再试\", resp) return } } // 接收并处理上传的excel表格 err := context.SaveUploadedFile(form.File, tmpFile) if err != nil { msg := fmt.Sprintf(\"保存上传文件失败: %s\", err) logger.Error(msg) Response(context, http.StatusInternalServerError, \"操作失败，请稍后再试\", resp) return } f, err := excelize.OpenFile(tmpFile) if err != nil { msg := fmt.Sprintf(\"打开文件失败:%s\", err) logger.Error(msg) Response(context, http.StatusInternalServerError, \"操作失败，请稍后再试\", resp) return } // 关闭文件 defer func() { if err := f.Close(); err != nil { msg := fmt.Sprintf(\"关闭文件失败:%s\", err) logger.Error(msg) } }() rows, err := f.GetRows(\"Sheet1\") if err != nil { msg := fmt.Sprintf(\"读取Excel文件失败: %s\", err.Error()) logger.Error(msg) Response(context, http.StatusAccepted, \"解析Excel数据错误，请确保提交正确的Excel数据\", resp) return } if len(rows) == 0 { logger.Error(\"不能提交空文件\") Response(context, http.StatusAccepted, \"不能提交空文件\", resp) return } row := rows[0] if len(row) != 9 || row[common.EStuName] != \"姓名\" || row[common.EStuIdCard] != \"身份证号\" || row[common.EStuStuId] != \"学号\" || row[common.EStuGender] != \"性别\" || row[common.EStuBirth] != \"出生日期\" || row[common.EStuCollege] != \"学院名称\" || row[common.EStuCollegeCode] != \"学院代码\" || row[common.EStuGrade] != \"年级\" || row[common.EStuLevel] != \"层次\" { logger.Error(\"Excel格式不符合模板要求\") Response(context, http.StatusBadRequest, \"Excel格式不符合模板要求\", resp) return } var wg sync.WaitGroup wg.Add(len(rows) - 1) buff := make(chan map[string]string, len(rows)-1) //建立缓冲区，记录不能导入的数据对应的姓名 _failInfo := make([]map[string]string, 0) userBuff := make(chan map[string]string, len(rows)-1) errBuff := make(chan []string, len(rows)-1) // 多进程处理，为每条数据分配一个goroutine for _, data := range rows[1:] { if len(data) != 9 { msg := fmt.Sprintf(\"数据不符合要求：【%v】\", data) logger.Error(msg) tmp := make(map[string]string, 0) tmp[\"name\"] = row[common.EStuName] tmp[\"reason\"] = msg errBuff \u003c- data buff \u003c- tmp } // 多线程处理，为每条数据开一个线程 go dealStuData(data, buff, \u0026wg, userBuff, errBuff) } wg.Wait() close(buff) close(userBuff) close(errBuff) for val := range buff { _failInfo = append(_failInfo, val) } ts := common.TStudent{} userList := make([]common.TStudent, 0) for val := range userBuff { t := common.TStudent{ Name: val[\"name\"], IdCard: val[\"idcard\"], StuId: val[\"stu_id\"], Gender: val[\"gender\"], Birthday: val[\"birth\"], College: val[\"college\"], CollegeCode: val[\"college_code\"], Grade: val[\"grade\"], Level: val[\"level\"], } t.Status = val[\"status\"] t.InMidDb = val[\"in_middb\"] t.OriginalPosition = val[\"originPosition\"] userList = append(userList, t) } failData := make([][]string, 0) for val := range errBuff { failData = append(failData, val) } err = ts.CreateStudent(userList) if err != nil { logger.Error(err.Error()) Response(context, http.StatusInternalServerError, err.Error(), resp) return } success := 0 fail := 0 var failInfo []string for _, val := range _failInfo { if val[\"reason\"] != \"success\" { fail++ failInfo = append(failInfo, val[\"reason\"]) continue } success++ } if len(failData) == 0 { resp[\"err_data_url\"] = \"\" } else { fileName, _ := golib.NewErrDataFile(failData, failInfo) fileName = strings.Replace(fileName, \".xlsx\", \"\", -1) resp[\"err_data_url\"] = fmt.Sprintf(\"%v/student/err?name=%v\", config.HostName, fileName) } msg := fmt.Sprintf(\"成功导入条数:%d 导入失败条数:%d 总计条数:%d\", success, len(failData), len(rows)-1) status := http.StatusOK if fail != 0 { status = http.StatusAccepted } Response(context, status, msg, resp) return } // 下载不能导入的信息 type reqErrFile struct { FileName int `form:\"name\" binding:\"required\"` } func (st *StuHandle) StuErrFile(ctx *gin.Context) { resp := gin.H{ \"status\": 200, \"msg\": \"操作成功\", } err := golib.DelOldFile() if err != nil { logger.Error(fmt.Sprintf(\"删除旧文件失败：%v\", err)) Response(ctx, http.StatusInternalServerError, \"操作失败\", resp) return } var form reqErrFile if err := ctx.ShouldBind(\u0026form); err != nil { logger.Error(fmt.Sprintf(\"参数错误：%v\", err)) Response(ctx, http.StatusBadRequest, \"操作不合法\", resp) return } file, err := ioutil.ReadFile(fmt.Sprintf(\"./fileTmp/%v.xlsx\", form.FileName)) if err != nil { logger.Error(fmt.Sprintf(\"读取文件失败:%v\", err)) Response(ctx, http.StatusNotFound, \"找不到资源\", resp) return } ctx.Header(\"content-disposition\", `attachment; filename=`+fmt.Sprintf(\"%v.xlsx\", form.FileName)) ctx.Data(200, \"application/octet-stream\", file) } d := make(map[string]int,6) d[\"name\"] = 0 d[\"content\"] = 1 d[\"org\"] = 2 d[\"year\"] = 3 d[\"user_id\"] = 4 d[\"username\"] = 5 data 并发编程-\u003eruntime runtime包里面定义了一些协程管理相关的api\nruntime.Gosched() 让出CPU时间片，重新等待安排任务\nfunc showMsg1(s string) { for i := 0; i \u003c 2; i++ { fmt.Println(s) } } func RunTime() { go showMsg1(\"java\") for i := 0; i \u003c 2; i++ { runtime.Gosched() fmt.Println(\"golang\") } fmt.Println(\"end...\") } java java golang golang end... 如果没有第11行，可能main协程直接结束啦 golang golang end... runtime.Goexit() 退出协程\nruntime.Goexit() runtime.GOMAXPROCS() func showA() { for i := 0; i \u003c 15; i++ { fmt.Printf(\"A:%v\\n\", i) } } func showB() { for i := 0; i \u003c 15; i++ { fmt.Printf(\"B:%v\\n\", i) } } func RunTime() { cpuNum := runtime.NumCPU() // 我这是 8 核 println(cpuNum) runtime.GOMAXPROCS(1) // 如果设置为 1 ，则不会交替执行。除非有睡眠在。 go showA() go showB() time.Sleep(time.Second) } 并发编程-\u003eMutex互斥锁实现同步 除了使用 channel 实现同步之外，还可以使用Mutex互斥锁的方式实现同步。\nGo语言提供了sync包和channel机制来解决并发机制中不同goroutine之间的同步和通信\n没加锁 package Base import ( \"fmt\" \"time\" ) func addOne(i int) { i++ } func subOne(i int) { i-- } func Mutex() { var i = 1 for ; i \u003c= 1000; i++ { go addOne(i) go subOne(i) } time.Sleep(time.Second * 1) fmt.Println(\"Sum:\", i) } Sum: 1001 加了锁 package Base import ( \"fmt\" \"sync\" \"time\" ) var mutex sync.Mutex func addOne(i int) { mutex.Lock() i++ mutex.Unlock() } func subOne(i int) { mutex.Lock() i-- mutex.Unlock() } func Mutex() { i := 0 for ; i \u003c 1000; i++ { go addOne(i) go subOne(i) } time.Sleep(time.Second * 1) fmt.Println(\"Sum:\", i) } Sum: 1000 锁 Locker Go语言使用go语句开启新的goroutine，由于goroutine非常轻量除了对其分配栈空间外，所占的空间也是微乎其微的。但当多个goroutine同时处理时会遇到比如同时抢占一个资源，某个goroutine会等待等一个goroutine处理完毕某才能继续执行的问题。对于这种情况，官方并不希望依靠共享内存的方式来实现进程的协同操作，而是希望通过channel信道的方式来处理。但在某些特殊情况下，依然需要使用到锁，为此sync包提供了锁。\n当在并发情况下，多个goroutine同时修改某一个变量时，就会出现资源抢占，因此会导致数据不一致的问题。\npackage main import ( \"fmt\" \"time\" ) func main() { var num = 0 for i := 0; i \u003c 100000; i++ { go func(i int) { num++ fmt.Printf(\"goroutine %d: num = %d\\n\", i, num) }(i) } time.Sleep(time.Second)//主goroutine等待1秒以确保所有工作goroutine执行完毕 } ... goroutine 10018: num = 98635 goroutine 12646: num = 98635 goroutine 12844: num = 98635 goroutine 12950: num = 98635 ... 上例中goroutine一依次从寄存器中读取num的值后做加法运算，然后将其结果回写到寄存器中。运行中会发现存在一个goroutine取出num的值时做加法运算时，另一个goroutine也取出了num的值。因为上一个goroutine运行结果还没有回写到寄存器，最终导致多个goroutine产生的相同的结果。\n并发编程中同步原语-锁，为了保证多个线程或goroutine在访问同一块内存时不出现混乱，Go语言的sync包提供了常见的并发编程同步原语的控制锁。\nsync包围绕着Locker锁接口展开，Locker接口中提供了两个方法Lock()和Unlock()。\ntype Locker interface { Lock() Unlock() } Go语言标准库sync中提供了两种锁分别是互斥锁sync.Mutex和读写互斥锁sync.RWMutex\n互斥锁sync.Mutex sync.Mutex是一个互斥锁，可以由不同的goroutine加锁和解锁。\nsync.Mutex是Golang标准库提供的一个互斥锁，当一个goroutine获得互斥锁权限后，其他请求锁的goroutine会阻塞在Lock()方法的调用上，直到调用Unlock()方法被释放。\n例如：10个并发的goroutine打印同一个数字100，为避免重复打印，实现printOnce(num int)函数，使用集合set记录已打印过的数字。若数字已经打印过，则不再打印。\n$ vim mutex_test.go package test import ( \"fmt\" \"testing\" \"time\" ) var set = make(map[int]bool, 0) func printOnce(index int, num int) { if _, ok := set[num]; !ok { fmt.Println(index, num) } set[num] = true } func TestPrint(t *testing.T) { for i := 0; i \u003c 10; i++ { go printOnce(i, 100) } time.Sleep(time.Second) } $ go test -v mutex_test.go === RUN TestPrint 9 100 3 100 --- PASS: TestPrint (1.00s) PASS ok command-line-arguments 1.304s 程序多次运行后会发现打印次数多次，因为对同一个数据结构set的访问发生了冲突。\n并发访问中比如多个goroutine并发更新同一个资源，比如计时器、账户余额、秒杀系统、向同一个缓存中并发写入数据等等。如果没有互斥控制，很容易会出现异常，比如计时器计数不准确、用户账户可能出现透支、秒杀系统出现超卖、缓存出现数据缓存等等，后果会很严重。\n互斥锁是并发控制的一种基本手段，是为了避免竞争而建立的一种并发控制机制。学习前首先需要弄清楚一个概念-临界区。在并发编程中，如果程序中的一部分会被并发访问或修改，为了避免并发访问导致的意想不到的结果，这部分程序需要被保护起来，这部分被保护起来的程序就叫做临界区。\n临界区是一个被共享的资源，或者说是一个整体的共享资源，比如对数据库的访问，对某个共享数据结构的操作。对一个I/O设备的使用，对一个连接池中的连接的调用等等。\n如果很多线程同步访问临界区就会造成访问或操作错误，这并不是我们希望看到的结果。所以，使用互斥锁，限定临界区只能同时由一个线程持有。当临界区由一个线程持有的时候，其他线程如果想进入临界区就会返回失败，或者是等待。直到持有的线程退出临界区，这些等待线程中的某一个才有机会接着持有这个临界区。\n互斥锁\n互斥锁可以很好的解决资源竞争的问题，因此也有人称之为排它锁。Golang标准库中使用Mutex来实现互斥锁。根据2019年分析Go并发Bug的论文Understanding Real-World Concurrency Bugs in Go中，Mutex是使用最为广泛的同步原语（Synchronization primitives， 并发原语或同步原语）。关于同步原语并没有一个严格的定义，可将其看作是解决并发问题的一个基础的数据结构。\ntype Mutex struct { state int32 //状态标识 sema uint32 //信号量 } Go标准库提供了sync.Mutex互斥锁类型以及两个方法分别是Lock加锁和Unlock释放锁。可以通过在代码前调用Lock方法，在代码后调用Unlock方法来保证一段代码的互斥执行，也可以使用defer语句来保证互斥锁一定会被解锁。当一个goroutine调用Lock方法获得锁后，其它请求的goroutine都会阻塞在Lock方法直到锁被释放。\n一个互斥锁只能同时被一个goroutine锁定，其它goroutine将阻塞直到互斥锁被解锁，也就是重新争抢对互斥锁的锁定。需要注意的是，对一个未锁定的互斥锁解锁时将会产生运行时错误。\nsync.Mutex不区分读写锁，只有Lock()和Lock()之间才会导致阻塞的情况。若在一个地方Lock()，在另一个地方不Lock()而是直接修改或访问共享数据，对于sync.Mutext类型是允许的，因为mutex不会和goroutine进行关联。若要区分读锁和写锁，可使用sync.RWMutex类型。\n在Lock()和Unlock()之间的代码段成为资源临界区（critical section），在这一区间内的代码是严格被Lock()保护的，是线程安全的，任何一个时间点都只能有一个goroutine执行这段区间的代码。\n例如：使用互斥锁的Lock()和Unlock()方法将冲突包裹\npackage test import ( \"fmt\" \"sync\" \"testing\" \"time\" ) var m sync.Mutex var set = make(map[int]bool, 0) func printOnce(index int, num int) { m.Lock() defer m.Unlock() if _, ok := set[num]; !ok { fmt.Println(index, num) } set[num] = true } func TestPrint(t *testing.T) { for i := 0; i \u003c 10; i++ { go printOnce(i, 100) } time.Sleep(time.Second) } 相同的数字只会比打印一次，当一个goroutine调用了Lock()方法时，其他goroutine被阻塞了，直到Unlock()调用将锁释放。因此被包裹部分的代码就能避免冲突，实现互斥。\n互斥即不能同时运行，使用互斥锁的两个代码片段相互排斥，只有其中一个代码片段执行完毕后，另一个才能执行。\npackage main import ( \"fmt\" \"sync\" \"time\" ) func main() { var num = 0 var locker sync.Mutex for i := 0; i \u003c 100000; i++ { go func(i int) { locker.Lock() defer locker.Unlock() num++ fmt.Printf(\"goroutine %d: num = %d\\n\", i, num) }(i) } time.Sleep(time.Second) } 从上例中可以发现，添加互斥锁后，不仅没有出现抢占资源导致的重复输出，而且输出结果顺序递增。\nGo语言中的Mutex类型的互斥锁Lock()锁定与其它语言不同的是，Lock()锁定的是互斥锁而非一段代码。其他语言比如Java中使用同步锁锁定的是一段代码，以确保多线程并发誓只有一个线程可以控制运行此代码块直到释放同步锁。Go语言是在goroutine中锁定互斥锁，其它goroutine执行到有锁的位置时，由于获取不到互斥锁的锁定，因此会发生阻塞而等待，从而达到控制同步的目的。\nrace detector Golang提供了一个检测并发访问共享资源是否存在问题的工具 - race detector，它可以帮助自动发现城中有没有data race的问题。\nGolang的race detector是基于Google的C/C++ sanitizers技术实现的，编译器通过探测所有的内存访问，加入代码能监视对这些内存地址的访问（读或是写）。代码运行时race detector能监控对共享变量的非同步访问，出现race时就会打印出警告信息。\nhttps://blog.golang.org/race-detector\n读写锁sync.RWMutex 在银行存取钱时，对账户余额的修改是需要加锁的，因此此时可能有人汇款到你的账户，如果对金额的修改不加锁，很可能导致最后的金额发生错误。读取账户余额也需要等待修改操作结束，才能读取到正确的余额。大部分情况下，读取余额的操作会更加频繁，如果能保证读取余额的操作能并发执行，程序的效率会很大地提升。\n保证读操作的安全，只需要保证并发读时没有写操作在进行就行。在这种场景下就需要一种特殊类型的锁，即允许多个只读操作并行执行，但写操作会完全互斥。这种锁称之为多读单写锁（multiple readers, single writer lock），简称读写锁。读写锁分为读锁和写锁，读锁允许同时执行，但写锁是互斥的。\nsync.RWMutex读写锁是基于sync.Mutex实现的，读写锁的特点是针对读写操作的互斥锁，读写锁与互斥锁最大不同之处在于分别对读、写进行了锁定。一般用在大量读操作少量写操作中。\n同时只能具有一个goroutine能够获得写锁定 同时可以具有任意多个goroutine获得读锁定 同时只能存在写锁定或读锁定，即读和写互斥。 换句话说\n当只有一个goroutine获得写锁定时，其它无论是读锁定还是写锁定都将会阻塞直到写解锁。 当只有一个goroutine获得读锁定时，其它读锁定仍然可以继续执行。 当有一个或多个读锁定时，写锁定将等待所有读锁定解锁之后才能进行写锁定。 这里所谓的读锁定（RLock）目的是为了告诉写锁定（Lock），此时有很多人正在读取数据，写锁定需要排队等待。\n一般来说，读写锁会分为几种情况：\n读锁之间不互斥，在没有写锁的情况下，读锁是无堵塞的，多个goroutine可以同时获得读锁。 写锁之间是互斥的，当存在写锁时，其它写锁会阻塞。 写锁与读锁互斥，若存在读锁则写锁阻塞，若存在写锁则读锁阻塞。 Go标准库sync.RWMutex读写互斥锁提供了四个方法\n读写互斥锁 描述 Lock 添加写锁 Unlock 释放写锁 RLock 添加读锁 RUnlock 释放读锁 并发编程-\u003eselect switch 1.select是Go中的一个控制结构，类似于switch语句，用于处理异步IO操作。select会监听case语句中channel的读写操作，当case中channel读写操作为非阻塞状态（即能读写）时，将会触发相应的动作。\nselect中的case语句必须是一个channel操作. select中的default子句总是可运行的。\n2.如果有多个case都可以运行，select会随机公平地选出一个执行，其他不会执行。\n3.如果没有可运行的case语句，且有default语句，那么就会执行default的动作。\n4.如果没有可运行的case语句，且没有default语句，select将阻塞，直到某个case通信可以运行.\n实例\npackage Base import \"time\" var chanInt = make(chan int) var chanStr = make(chan string) func Channel() { go func() { chanInt \u003c- 100 chanStr \u003c- \"Hello\" defer close(chanInt) defer close(chanStr) }() for { select { case r := \u003c-chanInt: println(\"chanInt\", r) case r := \u003c-chanStr: println(\"chanStr\", r) default: println(\"default\") } time.Sleep(time.Second) } } default chanInt 100 chanStr Hello chanStr chanStr chanInt 0 chanInt 0 ……\n并发编程-\u003eTimer Timer顾名思义，就是定时器的意思，可以实现一些定时操作，内部也是通过channel来实现的。\npackage Base import ( \"fmt\" \"time\" ) func Timer() { // 第一种创建方式 timer := time.NewTimer(time.Second * 2) fmt.Println(time.Now()) c := \u003c-timer.C fmt.Println(c) // 相差两秒 //2022-09-13 11:28:25.6609052 +0800 +08 m=+0.004536701 //2022-09-13 11:28:27.6616643 +0800 +08 m=+2.005295801 } 并发编程-\u003eTicker Timer只执行一次，TickerT可以周期的执行。\n实例\nfunc Ticker() { ticker := time.NewTicker(time.Second) count := 0 for range ticker.C { fmt.Println(\"ticker...\") count++ if count \u003e= 5 { ticker.Stop() break } } } 并发编程-\u003e原子变量 package Base import ( \"fmt\" \"sync/atomic\" \"time\" ) var num int64 = 1 func Add(i int64) { atomic.AddInt64(\u0026i, 1) } func Sub(i int64) { atomic.AddInt64(\u0026i, -1) } func Atomic() { for ; num \u003c 1000; num++ { go Add(num) go Sub(num) } time.Sleep(time.Second * 1) fmt.Println(\"Sum:\", num) } Advanced level fmt https://www.bilibili.com/read/cv14519061/?from=readlist\n文件常见操作/读写 (os, io, bufio包) https://www.bilibili.com/read/cv14586068/?from=readlist\n错误/日志/单元测试 错误处理\nfunc Errors() { defer func() { err := recover() fmt.Println(\"捕捉到了错误:\", err) }() err1 := errors.New(\"可爱的错误\") fmt.Println(\"err1=\", err1) err2 := fmt.Errorf(\"%s的错误\", \"温柔\") fmt.Println(\"err2=\", err2) panic(err1) } 单元测试 6.10.1 命名规范\n文件名: xxx_test.go (通常xxx为被测试文件名)\n6.10.2 测试函数\n测试函数: func TestXxx(*testing.T) (通常Xxx为被测试函数名)\n性能测试函数: func BenchmarkXxx(*testing.B) (通常Xxx为被测试函数名)\n6.10.3 testing.T与testing.B\ntesting.T与testing.B是testing包定义的结构体，下面简称t与b\n6.10.4 测试命令(go mod下)\n项目名可以简写为”.\"，下面同一为\".\"\n测试指定包: go test ./文件夹路径\n将自动调用所有_test.go文件中的所有TestXxx函数\n测试指定文件: go test ./文件夹路径/xxx_test.go ./go/文件夹路径/xxx.go\n将自动调用xxx_test.go中的所有TestXxx函数\nflag\nflag可以写在 ./… 前也可以写在 ./… 之后\n也运行BenchmarkXxx函数: go test -bench ./…\n详细输出(verbose): go test -v ./…\n即使运行成功也输出日志\n规定测试时间: go test -benchtime XhXmXs ./…\n规定测试次数: go test -benchtime Nx ./…\n指定测试cpu数量: go test -cpu N ./…\n指定测试函数: go test -run TestXxx ./…\n只测试TestXxx函数\n超时限制: go test -timeout XhXmXs ./…\n默认限制为10min\n打印测试的内存使用统计: go test -benchmem ./…\n作者：FangChannel https://www.bilibili.com/read/cv14614760/?from=readlist 出处：bilibili\nfor range package main import ( \"fmt\" \"strings\" ) type Detail struct{ Rid int TeamName string Member string } type TeamMember struct{ Rid int Member string } func main() { d1:=Detail{ Rid: 10, TeamName: \"ddd10\", Member: \"\", } d2:=Detail{ Rid: 11, TeamName: \"ddd11\", Member: \"\", } d3:=Detail{ Rid: 12, TeamName: \"ddd12\", Member: \"\", } t1:=TeamMember{ Rid: 10, Member: \"10的Member\", } var ds []Detail ds = append(ds,d1,d2,d3) var ts []TeamMember ts = append(ts, t1) fmt.Println(ts) fmt.Println(ds) for i := 0; i \u003c len(ds); i++ { for j := 0; j \u003c len(ts); j++ { if ds[i].Rid == ts[j].Rid { ds[i].Member = ts[j].Member break } } } // ==== ?? ==== for _, v := range ds { for _, v2 := range ts { if v.Rid == v2.Rid { v.member = v2.menber } } } fmt.Println(ts) fmt.Println(ds) } ",
  "wordCount" : "22946",
  "inLanguage": "zh",
  "datePublished": "2021-11-30T15:55:23+08:00",
  "dateModified": "2021-11-30T15:55:23+08:00",
  "author":[{
    "@type": "Person",
    "name": "Blaine"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://Bin-lin-rgb.github.io/posts/go/base/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Blaine's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://Bin-lin-rgb.github.io/img/icon.png"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    (function () {
        let  arr,reg = new RegExp("(^| )"+"change-themes"+"=([^;]*)(;|$)");
        if(arr = document.cookie.match(reg)) {
        } else {
            if (new Date().getHours() >= 19 || new Date().getHours() < 6) {
                document.body.classList.add('dark');
                localStorage.setItem("pref-theme", 'dark');
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem("pref-theme", 'light');
            }
        }
    })()

    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://Bin-lin-rgb.github.io/" accesskey="h" title="Blaine&#39;s Blog (Alt + H)">
            <img src="https://Bin-lin-rgb.github.io/img/icon.png" alt="logo" aria-label="logo"
                 height="35">Blaine&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://Bin-lin-rgb.github.io/" title="🏠 主页">
                <span>🏠 主页</span>
                </a>
            </li>
            <li>
                <a href="https://Bin-lin-rgb.github.io/posts" title="📚 文章">
                <span>📚 文章</span>
                </a>
            </li>
            <li>
                <a href="https://Bin-lin-rgb.github.io/search" title="🔍 搜索 (Alt &#43; /)" accesskey=/>
                <span>🔍 搜索</span>
                </a>
            </li>
            <li>
                <a href="https://Bin-lin-rgb.github.io/tags" title="🧩 标签">
                <span>🧩 标签</span>
                </a>
            </li>
            <li>
                <a href="https://Bin-lin-rgb.github.io/archives/" title="⏱️ 时间轴">
                <span>⏱️ 时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://Bin-lin-rgb.github.io/about" title="🙋🏻‍♂️ 关于">
                <span>🙋🏻‍♂️ 关于</span>
                </a>
            </li>
            <li>
                <a href="https://Bin-lin-rgb.github.io/links" title="🤝 友链">
                <span>🤝 友链</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }
</style>

<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="https://Bin-lin-rgb.github.io/">🏠 主页</a>&nbsp;»&nbsp;<a href="https://Bin-lin-rgb.github.io/posts/">📚文章</a>&nbsp;»&nbsp;<a href="https://Bin-lin-rgb.github.io/posts/go/">🥇 Golang</a></div>
            <h1 class="post-title">
                Golang 基础语法
            </h1>
            <div class="post-description">
                Golang 基础语法
            </div>
            <div class="post-meta">

<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2021-11-30
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>22946字
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>46分钟
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>Blaine
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="https://Bin-lin-rgb.github.io/tags/golang/" style="color: var(--secondary)!important;">Golang</a>
                &nbsp;<a href="https://Bin-lin-rgb.github.io/tags/tech/" style="color: var(--secondary)!important;">tech</a>
            </span>
        </span>
    </span>
</span>
<span style="opacity: 0.8;">
                    <span id="post_meta_style_7">
                        &nbsp;&nbsp;
                        <span class="fa fa-eye" ></span>
                        <span>
                            <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
                            &nbsp;&nbsp;
                        </span>
                    </span>
                    <span id="post_meta_style_8">
                        <span class="fa fa-commenting-o"></span>
                        <span>
                            <script src="https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js"></script>
                            <script>
                                let url = document.documentURI
                                
                                let dnsUrl = "https://Bin-lin-rgb.github.io/"
                                let urlSplit = url.split(dnsUrl)
                                let finalUrl = urlSplit[1]
                                if (finalUrl[0] !== '/') {
                                    finalUrl = '/'+finalUrl
                                }
                                twikoo.getCommentsCount({
                                    envId: "https://twikoo-api-nine-silk.vercel.app/", 
                                region: "ap-guangzhou", 
                                urls: [ 
                                    
                                    finalUrl,
                                ],
                                    includeReply: false 
                                }).then(function (res) {
                                    let count = res[0].count
                                    const obj = document.getElementById("comment_count");
                                    obj.innerText = count
                                    
                                    
                                    
                                }).catch(function (err) {
                                    
                                    console.error(err);
                                });
                            </script>
                            <span id="comment_count"></span>
                        </span>
                    </span>
                </span>

</div>
        </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul><ul>
                <li>
                    <a href="#go-%e5%b8%b8%e7%94%a8%e5%91%bd%e4%bb%a4" aria-label="go 常用命令">go 常用命令</a></li>
                <li>
                    <a href="#%e6%a0%87%e8%af%86%e7%ac%a6%e7%9a%84%e7%bb%84%e6%88%90" aria-label="标识符的组成">标识符的组成</a><ul>
                        
                <li>
                    <a href="#go%e6%98%af%e4%b8%80%e9%97%a8%e5%8c%ba%e5%88%86%e5%a4%a7%e5%b0%8f%e5%86%99%e7%9a%84%e8%af%ad%e8%a8%80" aria-label="Go是一门区分大小写的语言">Go是一门区分大小写的语言</a></li>
                <li>
                    <a href="#%e5%8c%85%e5%90%8d%e7%a7%b0" aria-label="包名称">包名称</a></li>
                <li>
                    <a href="#%e6%96%87%e4%bb%b6%e5%91%bd%e5%90%8d" aria-label="文件命名">文件命名</a></li>
                <li>
                    <a href="#%e7%bb%93%e6%9e%84%e4%bd%93%e5%91%bd%e5%90%8d" aria-label="结构体命名">结构体命名</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%94%99%e8%af%af%e5%a4%84%e7%90%86" aria-label="错误处理">错误处理</a></li>
                <li>
                    <a href="#%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95" aria-label="单元测试">单元测试</a></li>
                <li>
                    <a href="#%e5%b8%b8%e9%87%8f" aria-label="常量">常量</a><ul>
                        
                <li>
                    <a href="#iota" aria-label="iota">iota</a><ul>
                        
                <li>
                    <a href="#%e8%b7%b3%e8%bf%871" aria-label="跳过1">跳过1</a></li>
                <li>
                    <a href="#%e8%b7%b3%e8%bf%872" aria-label="跳过2">跳过2</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b" aria-label="数据类型">数据类型</a><ul>
                        
                <li>
                    <a href="#bool-%e7%b1%bb%e5%9e%8b" aria-label="bool 类型">bool 类型</a></li>
                <li>
                    <a href="#%e6%95%b0%e5%ad%97%e7%b1%bb%e5%9e%8b" aria-label="数字类型">数字类型</a></li>
                <li>
                    <a href="#%e5%ad%97%e7%ac%a6%e4%b8%b2" aria-label="字符串">字符串</a><ul>
                        
                <li>
                    <a href="#%e5%ad%97%e7%ac%a6%e4%b8%b2%e8%bf%9e%e6%8e%a5" aria-label="字符串连接">字符串连接</a></li>
                <li>
                    <a href="#%e5%ad%97%e7%ac%a6%e4%b8%b2%e5%88%87%e7%89%87%e6%93%8d%e4%bd%9c" aria-label="字符串切片操作">字符串切片操作</a></li>
                <li>
                    <a href="#%e5%ad%97%e7%ac%a6%e4%b8%b2%e5%87%bd%e6%95%b0" aria-label="字符串函数">字符串函数</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e6%a0%bc%e5%bc%8f%e5%8c%96%e8%be%93%e5%87%ba" aria-label="格式化输出">格式化输出</a></li>
                <li>
                    <a href="#%e8%bf%90%e7%ae%97%e7%ac%a6" aria-label="运算符">运算符</a></li>
                <li>
                    <a href="#%e6%b5%81%e7%a8%8b%e6%8e%a7%e5%88%b6" aria-label="流程控制">流程控制</a><ul>
                        
                <li>
                    <a href="#if" aria-label="if">if</a></li>
                <li>
                    <a href="#switch" aria-label="switch">switch</a></li>
                <li>
                    <a href="#%e5%be%aa%e7%8e%af" aria-label="循环">循环</a><ul>
                        
                <li>
                    <a href="#for-range" aria-label="for range">for range</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e6%95%b0%e7%bb%84" aria-label="数组">数组</a></li>
                <li>
                    <a href="#%e5%88%87%e7%89%87" aria-label="切片">切片</a><ul>
                        
                <li>
                    <a href="#tips" aria-label="tips">tips</a></li>
                <li>
                    <a href="#%e6%b7%bb%e5%8a%a0%e5%88%a0%e9%99%a4copy" aria-label="添加、删除、Copy">添加、删除、Copy</a></li></ul>
                </li>
                <li>
                    <a href="#map" aria-label="map">map</a><ul>
                        
                <li>
                    <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96" aria-label="初始化">初始化</a></li>
                <li>
                    <a href="#%e5%8f%96%e5%80%bc%e9%81%8d%e5%8e%86" aria-label="取值、遍历">取值、遍历</a></li></ul>
                </li>
                <li>
                    <a href="#function" aria-label="function">function</a><ul>
                        
                <li>
                    <a href="#%e8%bf%94%e5%9b%9e%e5%80%bc" aria-label="返回值">返回值</a></li>
                <li>
                    <a href="#%e5%8f%82%e6%95%b0" aria-label="参数">参数</a><ul>
                        
                <li>
                    <a href="#%e5%80%bc%e4%bc%a0%e9%80%92" aria-label="值传递">值传递</a></li>
                <li>
                    <a href="#%e5%8f%98%e9%95%bf%e5%8f%82%e6%95%b0" aria-label="变长参数">变长参数</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%ab%98%e9%98%b6%e5%87%bd%e6%95%b0" aria-label="高阶函数">高阶函数</a></li>
                <li>
                    <a href="#%e5%8c%bf%e5%90%8d%e5%87%bd%e6%95%b0" aria-label="匿名函数">匿名函数</a></li>
                <li>
                    <a href="#%e9%97%ad%e5%8c%85" aria-label="闭包">闭包</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%80%92%e5%bd%92" aria-label="递归">递归</a></li>
                <li>
                    <a href="#defer" aria-label="defer">defer</a></li>
                <li>
                    <a href="#init%e5%87%bd%e6%95%b0" aria-label="init函数">init函数</a><ul>
                        
                <li>
                    <a href="#init%e5%87%bd%e6%95%b0%e7%9a%84%e4%b8%bb%e8%a6%81%e7%89%b9%e7%82%b9" aria-label="init函数的主要特点">init函数的主要特点</a></li>
                <li>
                    <a href="#golang%e5%88%9d%e5%a7%8b%e5%8c%96%e9%a1%ba%e5%ba%8f" aria-label="golang初始化顺序">golang初始化顺序</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%8c%87%e9%92%88" aria-label="指针">指针</a><ul>
                        
                <li>
                    <a href="#%e6%8c%87%e9%92%88%e5%9c%b0%e5%9d%80%e5%92%8c%e6%8c%87%e9%92%88%e7%b1%bb%e5%9e%8b" aria-label="指针地址和指针类型">指针地址和指针类型</a></li>
                <li>
                    <a href="#%e6%8c%87%e9%92%88%e8%af%ad%e6%b3%95" aria-label="指针语法">指针语法</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%8c%87%e9%92%88%e6%95%b0%e7%bb%84" aria-label="指针数组">指针数组</a></li>
                <li>
                    <a href="#%e7%b1%bb%e5%9e%8b%e5%ae%9a%e4%b9%89%e5%92%8c%e7%b1%bb%e5%9e%8b%e5%88%ab%e5%90%8d" aria-label="类型定义和类型别名">类型定义和类型别名</a><ul>
                        
                <li>
                    <a href="#go%e8%af%ad%e8%a8%80%e7%b1%bb%e5%9e%8b%e5%ae%9a%e4%b9%89" aria-label="go语言类型定义">go语言类型定义</a></li>
                <li>
                    <a href="#%e7%b1%bb%e5%9e%8b%e5%88%ab%e5%90%8d" aria-label="类型别名">类型别名</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%bb%93%e6%9e%84%e4%bd%93" aria-label="结构体">结构体</a><ul>
                        
                <li>
                    <a href="#%e7%bb%93%e6%9e%84%e4%bd%93%e7%9a%84%e5%ae%9a%e4%b9%89" aria-label="结构体的定义">结构体的定义</a></li>
                <li>
                    <a href="#%e7%bb%93%e6%9e%84%e4%bd%93%e6%8c%87%e9%92%88" aria-label="结构体指针">结构体指针</a></li>
                <li>
                    <a href="#%e7%bb%93%e6%9e%84%e4%bd%93%e4%bd%9c%e4%b8%ba%e5%87%bd%e6%95%b0%e5%8f%82%e6%95%b0" aria-label="结构体作为函数参数">结构体作为函数参数</a><ul>
                        
                <li>
                    <a href="#%e7%9b%b4%e6%8e%a5%e4%bc%a0%e9%80%92%e7%bb%93%e6%9e%84%e4%bd%93" aria-label="直接传递结构体">直接传递结构体</a></li>
                <li>
                    <a href="#%e4%bc%a0%e9%80%92%e7%bb%93%e6%9e%84%e4%bd%93%e6%8c%87%e9%92%88" aria-label="传递结构体指针">传递结构体指针</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%b5%8c%e5%a5%97%e7%bb%93%e6%9e%84%e4%bd%93" aria-label="嵌套结构体">嵌套结构体</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%96%b9%e6%b3%95" aria-label="方法">方法</a><ul>
                        
                <li>
                    <a href="#%e6%96%b9%e6%b3%95%e7%9a%84%e8%af%ad%e6%b3%95" aria-label="方法的语法">方法的语法</a></li>
                <li>
                    <a href="#%e6%96%b9%e6%b3%95%e7%9a%84%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9" aria-label="方法的注意事项">方法的注意事项</a></li>
                <li>
                    <a href="#%e6%96%b9%e6%b3%95%e6%8e%a5%e6%94%b6%e8%80%85%e7%b1%bb%e5%9e%8b" aria-label="方法接收者类型">方法接收者类型</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%8e%a5%e5%8f%a3" aria-label="接口">接口</a><ul>
                        
                <li>
                    <a href="#db_init" aria-label="db_init">db_init</a></li>
                <li>
                    <a href="#daouser" aria-label="dao.user">dao.user</a></li>
                <li>
                    <a href="#%e6%8e%a5%e5%8f%a3%e5%92%8c%e7%b1%bb%e5%9e%8b%e7%9a%84%e5%85%b3%e7%b3%bb" aria-label="接口和类型的关系">接口和类型的关系</a></li>
                <li>
                    <a href="#%e6%8e%a5%e5%8f%a3%e5%b5%8c%e5%a5%97" aria-label="接口嵌套">接口嵌套</a></li>
                <li>
                    <a href="#%e9%80%9a%e8%bf%87%e6%8e%a5%e5%8f%a3%e5%ae%9e%e7%8e%b0ocp%e8%ae%be%e8%ae%a1%e5%8e%9f%e5%88%99" aria-label="通过接口实现OCP设计原则">通过接口实现OCP设计原则</a></li>
                <li>
                    <a href="#%e5%ae%9e%e4%be%8b" aria-label="实例">实例</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%bb%a7%e6%89%bf" aria-label="继承">继承</a></li>
                <li>
                    <a href="#%e6%9e%84%e9%80%a0%e5%87%bd%e6%95%b0" aria-label="构造函数">构造函数</a></li>
                <li>
                    <a href="#%e5%8c%85%e7%ae%a1%e7%90%86%e5%b7%a5%e5%85%b7go-module" aria-label="包管理工具go module">包管理工具go module</a></li>
                <li>
                    <a href="#%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b-%e5%8d%8f%e7%a8%8b" aria-label="并发编程-&amp;gt;协程">并发编程-&gt;协程</a><ul>
                        
                <li>
                    <a href="#q1-select--case" aria-label="Q1 select …… case">Q1 select …… case</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b-%e9%80%9a%e9%81%93channel" aria-label="并发编程-&amp;gt;通道channel">并发编程-&gt;通道channel</a><ul>
                        
                <li>
                    <a href="#channel-%e9%81%8d%e5%8e%86" aria-label="channel 遍历">channel 遍历</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b-waitgroup%e5%ae%9e%e7%8e%b0%e5%90%8c%e6%ad%a5" aria-label="并发编程-&amp;gt;WaitGroup实现同步">并发编程-&gt;WaitGroup实现同步</a></li>
                <li>
                    <a href="#%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b-runtime" aria-label="并发编程-&amp;gt;runtime">并发编程-&gt;runtime</a><ul>
                        
                <li>
                    <a href="#runtimegosched" aria-label="runtime.Gosched()">runtime.Gosched()</a></li>
                <li>
                    <a href="#runtimegoexit" aria-label="runtime.Goexit()">runtime.Goexit()</a></li>
                <li>
                    <a href="#runtimegomaxprocs" aria-label="runtime.GOMAXPROCS()">runtime.GOMAXPROCS()</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b-mutex%e4%ba%92%e6%96%a5%e9%94%81%e5%ae%9e%e7%8e%b0%e5%90%8c%e6%ad%a5" aria-label="并发编程-&amp;gt;Mutex互斥锁实现同步">并发编程-&gt;Mutex互斥锁实现同步</a><ul>
                        
                <li>
                    <a href="#%e6%b2%a1%e5%8a%a0%e9%94%81" aria-label="没加锁">没加锁</a></li>
                <li>
                    <a href="#%e5%8a%a0%e4%ba%86%e9%94%81" aria-label="加了锁">加了锁</a></li>
                <li>
                    <a href="#%e9%94%81-locker" aria-label="锁 Locker">锁 <code>Locker</code></a></li>
                <li>
                    <a href="#%e4%ba%92%e6%96%a5%e9%94%81syncmutex" aria-label="互斥锁sync.Mutex">互斥锁<code>sync.Mutex</code></a></li>
                <li>
                    <a href="#race-detector" aria-label="race detector">race detector</a></li>
                <li>
                    <a href="#%e8%af%bb%e5%86%99%e9%94%81syncrwmutex" aria-label="读写锁sync.RWMutex">读写锁<code>sync.RWMutex</code></a></li></ul>
                </li>
                <li>
                    <a href="#%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b-select-switch" aria-label="并发编程-&amp;gt;select switch">并发编程-&gt;select switch</a></li>
                <li>
                    <a href="#%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b-timer" aria-label="并发编程-&amp;gt;Timer">并发编程-&gt;Timer</a></li>
                <li>
                    <a href="#%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b-ticker" aria-label="并发编程-&amp;gt;Ticker">并发编程-&gt;Ticker</a></li>
                <li>
                    <a href="#%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b-%e5%8e%9f%e5%ad%90%e5%8f%98%e9%87%8f" aria-label="并发编程-&amp;gt;原子变量">并发编程-&gt;原子变量</a></li></ul>
                    
                <li>
                    <a href="#advanced-level" aria-label="Advanced level">Advanced level</a><ul>
                        
                <li>
                    <a href="#fmt" aria-label="fmt">fmt</a></li>
                <li>
                    <a href="#%e6%96%87%e4%bb%b6%e5%b8%b8%e8%a7%81%e6%93%8d%e4%bd%9c%e8%af%bb%e5%86%99-os-io-bufio%e5%8c%85" aria-label="文件常见操作/读写 (os, io, bufio包)">文件常见操作/读写 (os, io, bufio包)</a></li>
                <li>
                    <a href="#%e9%94%99%e8%af%af%e6%97%a5%e5%bf%97%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95" aria-label="错误/日志/单元测试">错误/日志/单元测试</a><ul>
                        
                <li>
                    <a href="#%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95-1" aria-label="单元测试">单元测试</a></li></ul>
                </li>
                <li>
                    <a href="#for-range-1" aria-label="for range">for range</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        if (elements) {
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                    (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                    return element;
                }
            }) || activeElement

            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                if (element === activeElement){
                    document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
                } else {
                    document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
                }
            })
        }
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        <div class="post-content"><p>Base</p>
<h2 id="go-常用命令">go 常用命令<a hidden class="anchor" aria-hidden="true" href="#go-常用命令">#</a></h2>
<ul>
<li>build: 编译包和依赖</li>
<li>clean: 移除对象文件</li>
<li>doc: 显示包或者符号的文档</li>
<li>env: 打印go的环境信息</li>
<li>bug: 启动错误报告</li>
<li>fix: 运行go tool fix</li>
<li>fmt: 运行gofmt进行格式化</li>
<li>generate: 从processing source生成go文件</li>
<li>get: 下载并安装包和依赖</li>
<li>install: 编译并安装包和依赖</li>
<li>list: 列出包</li>
<li>run: 编译并运行go程序</li>
<li>test: 运行测试</li>
<li>tool: 运行go提供的工具</li>
<li>version: 显示go的版本</li>
<li>vet: 运行go tool vet</li>
</ul>
<h2 id="标识符的组成">标识符的组成<a hidden class="anchor" aria-hidden="true" href="#标识符的组成">#</a></h2>
<p>1.标识符由数字、字母和下划线 (_) 组成。</p>
<p>2.只能以字母和下划线 (_) 开头。</p>
<p>3.标识符区分大小写。</p>
<h3 id="go是一门区分大小写的语言">Go是一门区分大小写的语言<a hidden class="anchor" aria-hidden="true" href="#go是一门区分大小写的语言">#</a></h3>
<p>命名规则涉及变量、常量、全局函数、结构、接口、方法等的命名。</p>
<p>GO语言从语法层面进行了以下限定：</p>
<p><strong>任何需要对外暴露的名字必须以大写字母开头</strong>，</p>
<p>不需要对外暴露的则应该以小写字母开头。</p>
<p>短变量声明只能在函数里使用。</p>
<h3 id="包名称">包名称<a hidden class="anchor" aria-hidden="true" href="#包名称">#</a></h3>
<p>保持packāge的名字和目录保持一致，尽量采取有意义的包名，简短，有意义，尽量和标准库不要冲突。==包名应该为小写单词==，不要使用下线或者混合大小写。</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> dao
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> service
</span></span></code></pre></div><h3 id="文件命名">文件命名<a hidden class="anchor" aria-hidden="true" href="#文件命名">#</a></h3>
<p>尽量采取有意义的文件名，简短，有意义，==应该为小写单词==，使用下划线分隔各个单词。</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>customer_dao.<span style="color:#ff6ac1">go</span> 
</span></span></code></pre></div><h3 id="结构体命名">结构体命名<a hidden class="anchor" aria-hidden="true" href="#结构体命名">#</a></h3>
<p>==采用驼峰命名法==，首字母根据访问控制大写或者小写</p>
<p>struct申明和初始化格式采用多行，例如下面：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">type</span> Customerorder <span style="color:#ff5c57">struct</span>{
</span></span><span style="display:flex;"><span>    Name <span style="color:#9aedfe">string</span>
</span></span><span style="display:flex;"><span>    Address <span style="color:#9aedfe">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>order<span style="color:#ff6ac1">:=</span>CustomerOrder{<span style="color:#5af78e">&#34;tom&#34;</span>,<span style="color:#5af78e">&#34;北京海淀&#34;</span>}
</span></span></code></pre></div><h2 id="错误处理">错误处理<a hidden class="anchor" aria-hidden="true" href="#错误处理">#</a></h2>
<p>错误处理的原则就是不能丢弃任何有返回 err 的调用，不要使用_丢弃，必须全部处理。</p>
<p>接收到错误，</p>
<ul>
<li>要么返回 err,</li>
<li>或者使用 log 记录下来尽早return ,  一旦有错误发生，马上返回</li>
<li>尽量不要使用 panic ,除非你知道你在做什么，</li>
<li>错误描述如果是英文必须为小写，不需要标点结尾，采用独立的错误流进行处理.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#78787e">//正确写法
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span><span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#78787e">//错误处理
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>    <span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#78787e">//正常代码
</span></span></span></code></pre></div><h2 id="单元测试">单元测试<a hidden class="anchor" aria-hidden="true" href="#单元测试">#</a></h2>
<p>单元测试文件名命名规范为<code>example_test.go</code>测试用例的函数名称必须以Test开头，例如：<code>TestExample</code></p>
<p>每个重要的函数都要首先编写测试用例，测试用例和正规代码一起提交方便进行回归测试。</p>
<h2 id="常量">常量<a hidden class="anchor" aria-hidden="true" href="#常量">#</a></h2>
<p>定义常量的语法</p>
<p>定义一个常量使用const关键字，语法格式如下：</p>
<p><code>const constantName [type]=value</code></p>
<ul>
<li>const: 定义常量关键字</li>
<li>constantName: 常量名称</li>
<li>type: 常量类型</li>
<li>value: 常量的值</li>
</ul>
<h3 id="iota">iota<a hidden class="anchor" aria-hidden="true" href="#iota">#</a></h3>
<p>iota比较特殊，可以被认为是一个可被编译器修改的常量，它默认开始值是g,每调用一次加1。遇到const关键字时被重置为0。
实例</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> Base
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> <span style="color:#5af78e">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Iota</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">const</span> (
</span></span><span style="display:flex;"><span>		a1 = <span style="color:#ff6ac1">iota</span>
</span></span><span style="display:flex;"><span>		a2 = <span style="color:#ff6ac1">iota</span>
</span></span><span style="display:flex;"><span>		a3 = <span style="color:#ff6ac1">iota</span>
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;a1:%v\n&#34;</span>, a1)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;a2:%v\n&#34;</span>, a2)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;a3:%v\n&#34;</span>, a3)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">========</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>a1:<span style="color:#ff9f43">0</span>
</span></span><span style="display:flex;"><span>a2:<span style="color:#ff9f43">1</span>
</span></span><span style="display:flex;"><span>a3:<span style="color:#ff9f43">2</span>
</span></span></code></pre></div><h4 id="跳过1">跳过1<a hidden class="anchor" aria-hidden="true" href="#跳过1">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Iota</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">const</span> (
</span></span><span style="display:flex;"><span>		a1 = <span style="color:#ff6ac1">iota</span>
</span></span><span style="display:flex;"><span>		_
</span></span><span style="display:flex;"><span>		a3 = <span style="color:#ff6ac1">iota</span>
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;a1:%v\n&#34;</span>, a1)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;a3:%v\n&#34;</span>, a3)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">======</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>a1:<span style="color:#ff9f43">0</span>
</span></span><span style="display:flex;"><span>a3:<span style="color:#ff9f43">2</span>
</span></span></code></pre></div><h4 id="跳过2">跳过2<a hidden class="anchor" aria-hidden="true" href="#跳过2">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Iota</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">const</span> (
</span></span><span style="display:flex;"><span>		a1 = <span style="color:#ff6ac1">iota</span>
</span></span><span style="display:flex;"><span>		a2 = <span style="color:#ff9f43">100</span>
</span></span><span style="display:flex;"><span>		a3 = <span style="color:#ff6ac1">iota</span>
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;a1:%v\n&#34;</span>, a1)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;a2:%v\n&#34;</span>, a2)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;a3:%v\n&#34;</span>, a3)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">======</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>a1:<span style="color:#ff9f43">0</span>
</span></span><span style="display:flex;"><span>a2:<span style="color:#ff9f43">100</span>
</span></span><span style="display:flex;"><span>a3:<span style="color:#ff9f43">2</span>
</span></span></code></pre></div><h2 id="数据类型">数据类型<a hidden class="anchor" aria-hidden="true" href="#数据类型">#</a></h2>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/Bin-lin-rgb/blog-img@main/20220906155414.png" alt=""  />
</p>
<p>指针、数组、切片类型</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">DataType</span>() {
</span></span><span style="display:flex;"><span>	num <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">200</span>
</span></span><span style="display:flex;"><span>	p <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">&amp;</span>num
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%T\n&#34;</span>, p)
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//	*int 指针
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>
</span></span><span style="display:flex;"><span>	arr <span style="color:#ff6ac1">:=</span> [<span style="color:#ff9f43">3</span>]<span style="color:#9aedfe">int</span>{<span style="color:#ff9f43">1</span>, <span style="color:#ff9f43">2</span>, <span style="color:#ff9f43">3</span>}
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%T\n&#34;</span>, arr)
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//[3]int 数组
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>
</span></span><span style="display:flex;"><span>	arr1 <span style="color:#ff6ac1">:=</span> []<span style="color:#9aedfe">int</span>{<span style="color:#ff9f43">1</span>, <span style="color:#ff9f43">2</span>, <span style="color:#ff9f43">3</span>}
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%T\n&#34;</span>, arr1)
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//[]int 切片
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="bool-类型">bool 类型<a hidden class="anchor" aria-hidden="true" href="#bool-类型">#</a></h3>
<p>bool 类型：不能使用 0 和 非0 表示真假</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#78787e">//	Bool
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	b <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> b { <span style="color:#78787e">//失败！
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>		fmt.<span style="color:#57c7ff">Println</span>(b)
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><h3 id="数字类型">数字类型<a hidden class="anchor" aria-hidden="true" href="#数字类型">#</a></h3>
<p>go 语言支持<strong>整型和浮点型</strong>数字，并且原生支持复数，其中位的运算采用补码。</p>
<p>有基于架构的类型，例如：int、uint和uintptr。
这些类型的长度都是根据运行程序所在的操作系统类型所决定的：</p>
<p>int和uint在32位操作系统上，它们均使用32位(4个字节)，在64位操作系统上，它们均使用64位(8个字节)。</p>
<p>uintptr的长度被设定为足够存放一个指针即可。</p>
<p>go语言中没有float类型。(Go语言中<strong>只有float32和float64</strong>)</p>
<p>没有 double 类型。</p>
<p>与操作系统架构无关的类型都有固定的大小，并在类型的名称中就可以看出来。</p>
<p>挺多的就不一一测了。</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#78787e">//	数字类型
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff5c57">var</span> i8 <span style="color:#9aedfe">int8</span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%T %db %v~%v\n&#34;</span>, i8, unsafe.<span style="color:#57c7ff">Sizeof</span>(i8), math.MinInt8, math.MaxInt8)
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//int8 1b -128~127
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">var</span> i <span style="color:#9aedfe">int</span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%T %db %v~%v\n&#34;</span>, i, unsafe.<span style="color:#57c7ff">Sizeof</span>(i), math.MinInt, math.MaxInt)
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//int 8b -9223372036854775808~9223372036854775807
</span></span></span></code></pre></div><h3 id="字符串">字符串<a hidden class="anchor" aria-hidden="true" href="#字符串">#</a></h3>
<p>反引号可换行</p>
<h4 id="字符串连接">字符串连接<a hidden class="anchor" aria-hidden="true" href="#字符串连接">#</a></h4>
<ol>
<li>加号</li>
<li>使用 fmt.Sprintf()</li>
<li>使用 strings.Join()</li>
<li>使用 buffer.WriteString()</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#78787e">//	String
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	str1 <span style="color:#ff6ac1">:=</span> <span style="color:#5af78e">&#34;Hello,&#34;</span>
</span></span><span style="display:flex;"><span>	str2 <span style="color:#ff6ac1">:=</span> <span style="color:#5af78e">&#34;Tom&#34;</span>
</span></span><span style="display:flex;"><span>	sprintf <span style="color:#ff6ac1">:=</span> fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;%s%s&#34;</span>, str1, str2)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(sprintf)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//	strings.Join
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	join <span style="color:#ff6ac1">:=</span> strings.<span style="color:#57c7ff">Join</span>([]<span style="color:#9aedfe">string</span>{<span style="color:#5af78e">&#34;Hello&#34;</span>, <span style="color:#5af78e">&#34;Amy&#34;</span>}, <span style="color:#5af78e">&#34;,&#34;</span>)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(join)	
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#78787e">//	buffer.WriteString
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff5c57">var</span> buffer bytes.Buffer
</span></span><span style="display:flex;"><span>	buffer.<span style="color:#57c7ff">WriteString</span>(<span style="color:#5af78e">&#34;Hello&#34;</span>)
</span></span><span style="display:flex;"><span>	buffer.<span style="color:#57c7ff">WriteString</span>(<span style="color:#5af78e">&#34;,&#34;</span>)
</span></span><span style="display:flex;"><span>	buffer.<span style="color:#57c7ff">WriteString</span>(<span style="color:#5af78e">&#34;DaMing&#34;</span>)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%v\n&#34;</span>, buffer.<span style="color:#57c7ff">String</span>())
</span></span></code></pre></div><p>1、golang里面的字符串都是不可变的，每次运算都会产生一个新的字符串，所以会产生很多临时的无用的字符串，不仅没有用，还会给带来额外的负担，所以性能比较差。</p>
<p>2、内部使用[]byte实现，不像直接运算符这种会产生很多临时的字符串，但是内部的逻辑比较复杂，有很多额外的判断，还用到了interface，所以性能也不是很好</p>
<p>3、join会先根据字符串数组的内容，计算出一个拼接之后的长度，然后申请对应大小的内存，一个一个字符串填入，在已有一个数组的情况下，这种效率会很高，但是本来没有，去构造这个数据的代价也不小。</p>
<p>4、这个比较理想，可以当成可变字符使用，对内存的增长也有优化，如果能预估字符串的长度，还可以用buffer.Grow()接口来设置capacity</p>
<h4 id="字符串切片操作">字符串切片操作<a hidden class="anchor" aria-hidden="true" href="#字符串切片操作">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#78787e">//  字符切片
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	str3 <span style="color:#ff6ac1">:=</span> <span style="color:#5af78e">&#34;Hello world!&#34;</span>
</span></span><span style="display:flex;"><span>	m, n <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">3</span>, <span style="color:#ff9f43">6</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">println</span>(str3[m])
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">println</span>(str3[:m]) <span style="color:#78787e">// [0,3)
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff5c57">println</span>(str3[m:n])
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">println</span>(str3[:n])
</span></span></code></pre></div><h4 id="字符串函数">字符串函数<a hidden class="anchor" aria-hidden="true" href="#字符串函数">#</a></h4>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/Bin-lin-rgb/blog-img@main/3cadc5862efe0aae1d91f79b16dd225.jpg" alt=""  />
</p>
<h2 id="格式化输出">格式化输出<a hidden class="anchor" aria-hidden="true" href="#格式化输出">#</a></h2>
<p><a href="https://pkg.go.dev/fmt?utm_source=godoc">https://pkg.go.dev/fmt?utm_source=godoc</a></p>
<p><a href="https://www.cnblogs.com/yinzhengjie/p/7680829.html">https://www.cnblogs.com/yinzhengjie/p/7680829.html</a></p>
<p>通用：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff9f43">1</span> <span style="color:#ff6ac1">%</span>v    值的默认格式表示<span style="color:#ff5c57">。</span>当输出结构体时<span style="color:#ff5c57">，</span>扩展标志<span style="color:#ff5c57">（</span><span style="color:#ff6ac1">%+</span>v<span style="color:#ff5c57">）</span>会添加字段名
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">2</span> <span style="color:#ff6ac1">%</span><span style="color:#ff5c57">#</span>v    值的Go语法表示
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">3</span> <span style="color:#ff6ac1">%</span>T    值的类型的Go语法表示
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">4</span> <span style="color:#ff6ac1">%%</span>    百分号
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//	格式化输出
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	user <span style="color:#ff6ac1">:=</span> User{
</span></span><span style="display:flex;"><span>		Name:   <span style="color:#5af78e">&#34;David&#34;</span>,
</span></span><span style="display:flex;"><span>		Age:    <span style="color:#ff9f43">20</span>,
</span></span><span style="display:flex;"><span>		Gender: <span style="color:#5af78e">&#34;male&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%v\n&#34;</span>, user)
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// {David 20 male}
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%#v\n&#34;</span>, user)
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// Base.User{Name:&#34;David&#34;, Age:20, Gender:&#34;male&#34;}
</span></span></span></code></pre></div><p>布尔值：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>%t    单词true或false
</span></span></code></pre></div><p>整数：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1 %b    表示为二进制
</span></span><span style="display:flex;"><span>2 %c    该值对应的unicode码值[char]
</span></span><span style="display:flex;"><span>3 %d    表示为十进制
</span></span><span style="display:flex;"><span>4 %o    表示为八进制
</span></span><span style="display:flex;"><span>5 %q    该值对应的单引号括起来的go语法字符字面值，必要时会采用安全的转义表示
</span></span><span style="display:flex;"><span>6 %x    表示为十六进制，使用a-f
</span></span><span style="display:flex;"><span>7 %X    表示为十六进制，使用A-F
</span></span><span style="display:flex;"><span>8 %U    表示为Unicode格式：U+1234，等价于&#34;U+%04X&#34;
</span></span></code></pre></div><p>浮点数、复数的两个组分：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1 %b    无小数部分、二进制指数的科学计数法，如-123456p-78；参见strconv.FormatFloat %e    科学计数法，如-1234.456e+78 %E    科学计数法，如-1234.456E+78 %f    有小数部分但无指数部分，如123.456 %F    等价于%f %g    根据实际情况采用%e或%f格式（以获得更简洁、准确的输出）
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2 %G    根据实际情况采用%E或%F格式（以获得更简洁、准确的输出）
</span></span></code></pre></div><p>字符串和[]byte：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>%s    直接输出字符串或者[]byte %q    该值对应的双引号括起来的go语法字符串字面值，必要时会采用安全的转义表示
</span></span><span style="display:flex;"><span>%x    每个字节用两字符十六进制数表示（使用a-f）
</span></span><span style="display:flex;"><span>%X    每个字节用两字符十六进制数表示（使用A-F）
</span></span></code></pre></div><p>指针：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>%p    表示为十六进制，并加上前导的0x
</span></span></code></pre></div><p>没有verb %u。整数如果是无符号类型自然输出也是无符号的。类似的，也没有必要指定操作数的尺寸（int8，int64）。</p>
<p>宽度通过一个紧跟在百分号后面的十进制数指定，如果未指定宽度，则表示值时除必需之外不作填充。精度通过（可能有的）宽度后跟点号后跟的十进制数指定。如果未指定精度，会使用默认精度；如果点号后没有跟数字，表示精度为0。举例如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>%f:    默认宽度，默认精度
</span></span><span style="display:flex;"><span>%9f    宽度9，默认精度
</span></span><span style="display:flex;"><span>%.2f   默认宽度，精度2 
</span></span><span style="display:flex;"><span>%9.2f  宽度9，精度2 
</span></span><span style="display:flex;"><span>%9.f   宽度9，精度0
</span></span></code></pre></div><p>宽度和精度格式化控制的是Unicode码值的数量（不同于C的printf，它的这两个因数指的是字节的数量）。两者任一个或两个都可以使用&rsquo;<em>&lsquo;号取代，此时它们的值将被对应的参数（按&rsquo;</em>&lsquo;号和verb出现的顺序，即控制其值的参数会出现在要表示的值前面）控制，这个操作数必须是int类型。</p>
<p>对于大多数类型的值，宽度是输出的最小字符数，如果必要是会用空格填充。对于字符串，宽度是输出字符数目的最低数量，如果必要会截断字符串。</p>
<p>对于整数，宽度和精度都设置输出总长度。采用精度时表示右对齐并用0填充，而宽度默认表示用空格填充。</p>
<p>对于浮点数，宽度设置输出总长度；精度设置小数部分长度（如果有的话），除了%g/%G，此时精度设置总的数字个数。例如，对数字123.45，格式%6.2f 输出123.45；格式%.4g输出123.5。%e和%f的默认精度是6，%g的默认精度是可以将该值区分出来需要的最小数字个数。</p>
<p>对复数，宽度和精度会分别用于实部和虚部，结果用小括号包裹。因此%f用于1.2+3.4i输出(1.200000+3.400000i)。</p>
<p>其它flag：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1 +    总是输出数值的正负号；对%q（%+q）会生成全部是ASCII字符的输出（通过转义）；
</span></span><span style="display:flex;"><span>2 -    在输出右边填充空白而不是默认的左边（即从默认的右对齐切换为左对齐）；
</span></span><span style="display:flex;"><span>3 #    切换格式：
</span></span><span style="display:flex;"><span>4       八进制数前加0（%#o），十六进制数前加0x（%#x）或0X（%#X），指针去掉前面的0x（%#p）；
</span></span><span style="display:flex;"><span>5      对%q（%#q），如果strconv.CanBackquote返回真会输出反引号括起来的未转义字符串；
</span></span><span style="display:flex;"><span>6      对%U（%#U），如果字符是可打印的，会在输出Unicode格式、空格、单引号括起来的go字面值；
</span></span><span style="display:flex;"><span>7 &#39; &#39;    对数值，正数前加空格而负数前加负号；
</span></span><span style="display:flex;"><span>8       对字符串采用%x或%X时（% x或% X）会给各打印的字节之间加空格；
</span></span><span style="display:flex;"><span>9 0    使用0而不是空格填充，对于数值类型会把填充的0放在正负号后面；
</span></span></code></pre></div><p>verb会忽略不支持的flag。例如，因为没有十进制切换模式，所以%#d和%d的输出是相同的。</p>
<p>对每一个类似Printf的函数，都有对应的Print型函数，该函数不接受格式字符串，就效果上等价于对每一个参数都是用verb %v。另一个变体Println型函数会在各个操作数的输出之间加空格并在最后换行。</p>
<p>不管verb如何，如果操作数是一个接口值，那么会使用接口内部保管的值，而不是接口，因此：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span> <span style="color:#ff9f43">1</span> <span style="color:#78787e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"> 2 #!/usr/bin/env gorun
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"> 3 @author :yinzhengjie
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"> 4 Blog:http://www.cnblogs.com/yinzhengjie/tag/GO%E8%AF%AD%E8%A8%80%E7%9A%84%E8%BF%9B%E9%98%B6%E4%B9%8B%E8%B7%AF/
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"> 5 EMAIL:y1053419035@qq.com
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"> 6 */</span>
</span></span><span style="display:flex;"><span> <span style="color:#ff9f43">7</span> 
</span></span><span style="display:flex;"><span> <span style="color:#ff9f43">8</span> <span style="color:#ff6ac1">package</span> main
</span></span><span style="display:flex;"><span> <span style="color:#ff9f43">9</span> 
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">10</span> <span style="color:#ff6ac1">import</span> <span style="color:#5af78e">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">11</span> 
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">12</span> <span style="color:#ff5c57">func</span> <span style="color:#57c7ff">main</span>() {
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">13</span>     <span style="color:#ff5c57">var</span> name <span style="color:#ff5c57">interface</span>{} = <span style="color:#5af78e">&#34;yinzhengjie&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">14</span>     fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;My name is %v !\n&#34;</span>, name)
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">15</span>     <span style="color:#ff5c57">var</span> age  <span style="color:#ff5c57">interface</span>{} = <span style="color:#ff9f43">18</span>
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">16</span>     fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;I am [%d] years old。&#34;</span>,age)
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">17</span> }
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">18</span> 
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">19</span> 
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">20</span> 
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">21</span> <span style="color:#ff5c57">#</span>以上代码执行结果如下<span style="color:#ff5c57">：</span>
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">22</span> My name is yinzhengjie !
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">23</span> I am [<span style="color:#ff9f43">18</span>] years old<span style="color:#ff5c57">。</span>
</span></span></code></pre></div><p>除了verb %T和%p之外；对实现了特定接口的操作数会考虑采用特殊的格式化技巧。按应用优先级如下：</p>
<p>\1. 如果操作数实现了Formatter接口，会调用该接口的方法。Formatter提供了格式化的控制。</p>
<p>\2. 如果verb %v配合flag #使用（%#v），且操作数实现了GoStringer接口，会调用该接口。</p>
<p>如果操作数满足如下两条任一条，对于%s、%q、%v、%x、%X五个verb，将考虑：</p>
<p>\3. 如果操作数实现了error接口，Error方法会用来生成字符串，随后将按给出的flag（如果有）和verb格式化。</p>
<p>\4. 如果操作数具有String方法，这个方法将被用来生成字符串，然后将按给出的flag（如果有）和verb格式化。</p>
<p>复合类型的操作数，如切片和结构体，格式化动verb递归地应用于其每一个成员，而不是作为整体一个操作数使用。因此%q会将[]string的每一个成员括起来，%6.2f会控制浮点数组的每一个元素的格式化。</p>
<p>为了避免可能出现的无穷递归，如：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1 type X string
</span></span><span style="display:flex;"><span>2 func (x X) String() string { return Sprintf(&#34;&lt;%s&gt;&#34;, x) }
</span></span></code></pre></div><p>应在递归之前转换值的类型：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1 func (x X) String() string { return Sprintf(&#34;&lt;%s&gt;&#34;, string(x)) }
</span></span></code></pre></div><p>显式指定参数索引：</p>
<p>在Printf、Sprintf、Fprintf三个函数中，默认的行为是对每一个格式化verb依次对应调用时成功传递进来的参数。但是，紧跟在verb之前的[n]符号表示应格式化第n个参数（索引从1开始）。同样的在&rsquo;*&lsquo;之前的[n]符号表示采用第n个参数的值作为宽度或精度。在处理完方括号表达式[n]后，除非另有指示，会接着处理参数n+1，n+2……（就是说移动了当前处理位置）。例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1 fmt.Sprintf(&#34;%[2]d %[1]d\n&#34;, 11, 22)
</span></span></code></pre></div><p>会生成&quot;22 11&quot;，而：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1 fmt.Sprintf(&#34;%[3]*.[2]*[1]f&#34;, 12.0, 2, 6),
</span></span></code></pre></div><p>等价于：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1 fmt.Sprintf(&#34;%6.2f&#34;, 12.0),
</span></span></code></pre></div><p>会生成&quot; 12.00&quot;。因为显式的索引会影响随后的verb，这种符号可以通过重设索引用于多次打印同一个值：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1 fmt.Sprintf(&#34;%d %d %#[1]x %#x&#34;, 16, 17)
</span></span></code></pre></div><p>会生成&quot;16 17 0x10 0x11&quot;</p>
<p>格式化错误：</p>
<p>如果给某个verb提供了非法的参数，如给%d提供了一个字符串，生成的字符串会包含该问题的描述，如下所例：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span> 1 错误的类型或未知的verb：%!verb(type=value)
</span></span><span style="display:flex;"><span> 2     Printf(&#34;%d&#34;, hi):          %!d(string=hi)
</span></span><span style="display:flex;"><span> 3 太多参数（采用索引时会失效）：%!(EXTRA type=value)
</span></span><span style="display:flex;"><span> 4     Printf(&#34;hi&#34;, &#34;guys&#34;):      hi%!(EXTRA string=guys)
</span></span><span style="display:flex;"><span> 5 太少参数: %!verb(MISSING)
</span></span><span style="display:flex;"><span> 6     Printf(&#34;hi%d&#34;):            hi %!d(MISSING)
</span></span><span style="display:flex;"><span> 7 宽度/精度不是整数值：%!(BADWIDTH) or %!(BADPREC)
</span></span><span style="display:flex;"><span> 9     Printf(&#34;%.*s&#34;, 4.5, &#34;hi&#34;): %!(BADPREC)hi
</span></span><span style="display:flex;"><span>10 没有索引指向的参数：%!(BADINDEX)
</span></span><span style="display:flex;"><span>11     Printf(&#34;%*[2]d&#34;, 7):       %!d(BADINDEX)
</span></span><span style="display:flex;"><span>12     Printf(&#34;%.[2]d&#34;, 7):       %!d(BADINDEX)
</span></span></code></pre></div><p>所有的错误都以字符串&quot;%!&ldquo;开始，有时会后跟单个字符（verb标识符），并以加小括弧的描述结束。</p>
<p>如果被print系列函数调用时，Error或String方法触发了panic，fmt包会根据panic重建错误信息，用一个字符串说明该panic经过了fmt包。例如，一个String方法调用了panic(&ldquo;bad&rdquo;)，生成的格式化信息差不多是这样的：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>%!s(PANIC=bad)
</span></span></code></pre></div><p>%!s指示表示错误（panic）出现时的使用的verb。</p>
<h2 id="运算符">运算符<a hidden class="anchor" aria-hidden="true" href="#运算符">#</a></h2>
<p>自增 &amp; 自减 不用于 表达式中。</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#78787e">//num2:=num++ + 5
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	num3<span style="color:#ff6ac1">:=</span>num <span style="color:#ff6ac1">+</span> <span style="color:#ff9f43">5</span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(num3)
</span></span></code></pre></div><h2 id="流程控制">流程控制<a hidden class="anchor" aria-hidden="true" href="#流程控制">#</a></h2>
<h3 id="if">if<a hidden class="anchor" aria-hidden="true" href="#if">#</a></h3>
<h3 id="switch">switch<a hidden class="anchor" aria-hidden="true" href="#switch">#</a></h3>
<p>case <strong>==可以多个、可以是表达式==</strong></p>
<p>case 里面不需要 break ，若想继续下去 加 fallthrough</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Control</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	str <span style="color:#ff6ac1">:=</span> <span style="color:#5af78e">&#34;b&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">checkGrade</span>(str)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">checkGrade</span>(grade <span style="color:#9aedfe">string</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//	switch
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">switch</span> grade {
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">case</span> <span style="color:#5af78e">&#34;a&#34;</span>, <span style="color:#5af78e">&#34;b&#34;</span>:
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;Very Good&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">case</span> <span style="color:#5af78e">&#34;c&#34;</span>:
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;Good&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">default</span>:
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;normal&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="循环">循环<a hidden class="anchor" aria-hidden="true" href="#循环">#</a></h3>
<h4 id="for-range">for range<a hidden class="anchor" aria-hidden="true" href="#for-range">#</a></h4>
<p>可以使用for range遍历数组、切片、字符串、map及通道(channel)。</p>
<p>通过for range遍历的返回值有以下规律：</p>
<p>1.数组、切片、字符串返回索引和值。
2.map返回键和值。
3.通道(channel)只返回通道内的值。</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	arr <span style="color:#ff6ac1">:=</span> [<span style="color:#ff6ac1">...</span>]<span style="color:#9aedfe">int</span>{<span style="color:#ff9f43">1</span>, <span style="color:#ff9f43">2</span>, <span style="color:#ff9f43">3</span>} <span style="color:#78787e">//[3]int
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#78787e">//arr := []int{1, 2, 3}  //[]int
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff6ac1">for</span> i, v <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">range</span> arr {
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%v:%v\n&#34;</span>, i, v)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%T\n&#34;</span>, arr)
</span></span></code></pre></div><p>break：在循环中，跳出一层循环</p>
<p>continue</p>
<p>goto</p>
<h2 id="数组">数组<a hidden class="anchor" aria-hidden="true" href="#数组">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> Base
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> <span style="color:#5af78e">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Array</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//	数组列表初始化
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff5c57">var</span> arr = [<span style="color:#ff9f43">5</span>]<span style="color:#9aedfe">int</span>{<span style="color:#ff9f43">4</span>, <span style="color:#ff9f43">5</span>, <span style="color:#ff9f43">6</span>, <span style="color:#ff9f43">7</span>, <span style="color:#ff9f43">8</span>}
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(arr)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//	使用 ... , 让他自行推断长度
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff5c57">var</span> arr1 = [<span style="color:#ff6ac1">...</span>]<span style="color:#9aedfe">int</span>{<span style="color:#ff9f43">4</span>, <span style="color:#ff9f43">5</span>, <span style="color:#ff9f43">6</span>, <span style="color:#ff9f43">7</span>, <span style="color:#ff9f43">8</span>, <span style="color:#ff9f43">9</span>, <span style="color:#ff9f43">10</span>}
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(arr1)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//	指定索引值的方式初始化
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff5c57">var</span> arr2 = [<span style="color:#ff6ac1">...</span>]<span style="color:#9aedfe">int</span>{<span style="color:#ff9f43">0</span>: <span style="color:#ff9f43">1</span>, <span style="color:#ff9f43">2</span>: <span style="color:#ff9f43">2</span>, <span style="color:#ff9f43">3</span>: <span style="color:#ff9f43">4</span>}
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(arr2)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="切片">切片<a hidden class="anchor" aria-hidden="true" href="#切片">#</a></h2>
<p>前面我们学习了数组，数组是固定长度，可以容纳相同数据类型的元素的集合。当长度固定时，使用还是带来一些限制，比如：我们申请的长度太大浪费内存，太小又不够用。</p>
<p>鉴于上述原因，我们有了go语言的切片，可以把切片理解为，可变长度的数组，<strong>其实它底层就是使用数组实现的</strong>，增加了自动扩容功能。切片 (slice) 是一个拥有相同类型元素的可变长度的序列。</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Slice</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//	数组
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff5c57">var</span> arr = [<span style="color:#ff6ac1">...</span>]<span style="color:#9aedfe">int</span>{<span style="color:#ff9f43">3</span>, <span style="color:#ff9f43">4</span>, <span style="color:#ff9f43">5</span>, <span style="color:#ff9f43">6</span>}
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(arr)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//	切片
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff5c57">var</span> slice = []<span style="color:#9aedfe">int</span>{<span style="color:#ff9f43">3</span>, <span style="color:#ff9f43">4</span>, <span style="color:#ff9f43">5</span>, <span style="color:#ff9f43">6</span>}
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(slice)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//  通过 make
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff5c57">var</span> sliceByMake = <span style="color:#ff5c57">make</span>([]<span style="color:#9aedfe">int</span>, <span style="color:#ff9f43">5</span>)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(sliceByMake)
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">println</span>(<span style="color:#5af78e">&#34;len&#34;</span>, <span style="color:#ff5c57">len</span>(sliceByMake))
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">println</span>(<span style="color:#5af78e">&#34;cap&#34;</span>, <span style="color:#ff5c57">cap</span>(sliceByMake))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="tips">tips<a hidden class="anchor" aria-hidden="true" href="#tips">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	headNum <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">6</span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// 这里创建了 6 个 0
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff5c57">var</span> UidIntArr = <span style="color:#ff5c57">make</span>([]<span style="color:#9aedfe">int</span>, headNum)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// right
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff5c57">var</span> UidIntArr = <span style="color:#ff5c57">make</span>([]<span style="color:#9aedfe">int</span>, <span style="color:#ff9f43">0</span>, headNum)
</span></span></code></pre></div><h3 id="添加删除copy">添加、删除、Copy<a hidden class="anchor" aria-hidden="true" href="#添加删除copy">#</a></h3>
<p>删除：连续容器的元素删除无论在任何语言中，都要将删除点前后的元素移动到新的位置，随着元素的增加，这个过程将会变得极为耗时，因此，当业务需要大量、频繁地从一个切片中删除元素时，如果对性能要求较高的话，就需要考虑更换其他的容器了（如双链表等能快速从删除点删除元素）。</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#78787e">//	add
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff5c57">var</span> slice1 = []<span style="color:#9aedfe">int</span>{<span style="color:#ff9f43">1</span>, <span style="color:#ff9f43">2</span>, <span style="color:#ff9f43">3</span>, <span style="color:#ff9f43">4</span>, <span style="color:#ff9f43">5</span>}
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;before add&#34;</span>, slice1)
</span></span><span style="display:flex;"><span>	slice1 = <span style="color:#ff5c57">append</span>(slice1, <span style="color:#ff9f43">6</span>)
</span></span><span style="display:flex;"><span>	slice1 = <span style="color:#ff5c57">append</span>(slice1, <span style="color:#ff9f43">6</span>)
</span></span><span style="display:flex;"><span>	slice1 = <span style="color:#ff5c57">append</span>(slice1, <span style="color:#ff9f43">6</span>)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;after add&#34;</span>, slice1)
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//before add [1 2 3 4 5]
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#78787e">//after add [1 2 3 4 5 6 6 6]
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//	delete
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;before delete&#34;</span>, slice1)
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//  假设想删除 下标为 4 的元素
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	slice1 = <span style="color:#ff5c57">append</span>(slice1[:<span style="color:#ff9f43">4</span>], slice1[<span style="color:#ff9f43">5</span>:]<span style="color:#ff6ac1">...</span>)  <span style="color:#78787e">//&lt;=======
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;after delete&#34;</span>, slice1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//	copy
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff5c57">var</span> slice3 = []<span style="color:#9aedfe">int</span>{<span style="color:#ff9f43">1</span>, <span style="color:#ff9f43">2</span>, <span style="color:#ff9f43">3</span>, <span style="color:#ff9f43">4</span>, <span style="color:#ff9f43">5</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">var</span> slice4 []<span style="color:#9aedfe">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">copy</span>(slice4, slice3)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;slice4&#34;</span>, slice1)
</span></span></code></pre></div><h2 id="map">map<a hidden class="anchor" aria-hidden="true" href="#map">#</a></h2>
<p>map是一种key:value键值对的数据结构容器。map内部实现是哈希表(hash)。
map最重要的一点是通过key来快速检索数据，key类似于索引，指向数据的值。
map是引用类型的。</p>
<h3 id="初始化">初始化<a hidden class="anchor" aria-hidden="true" href="#初始化">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">MapInit</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	map1 <span style="color:#ff6ac1">:=</span> <span style="color:#ff5c57">map</span>[<span style="color:#9aedfe">string</span>]<span style="color:#9aedfe">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#5af78e">&#34;name&#34;</span>:   <span style="color:#5af78e">&#34;Tom&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#5af78e">&#34;age&#34;</span>:    <span style="color:#5af78e">&#34;12&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#5af78e">&#34;gender&#34;</span>: <span style="color:#5af78e">&#34;male&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(map1)
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//map[age:12 gender:male name:Tom]
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>
</span></span><span style="display:flex;"><span>	map2 <span style="color:#ff6ac1">:=</span> <span style="color:#ff5c57">make</span>(<span style="color:#ff5c57">map</span>[<span style="color:#9aedfe">string</span>]<span style="color:#9aedfe">string</span>, <span style="color:#ff9f43">5</span>)
</span></span><span style="display:flex;"><span>	map2[<span style="color:#5af78e">&#34;name&#34;</span>] = <span style="color:#5af78e">&#34;Amy&#34;</span>
</span></span><span style="display:flex;"><span>	map2[<span style="color:#5af78e">&#34;age&#34;</span>] = <span style="color:#5af78e">&#34;13&#34;</span>
</span></span><span style="display:flex;"><span>	map2[<span style="color:#5af78e">&#34;gender&#34;</span>] = <span style="color:#5af78e">&#34;female&#34;</span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(map2)
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//map[age:13 gender:female name:Amy]
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>}
</span></span></code></pre></div><h3 id="取值遍历">取值、遍历<a hidden class="anchor" aria-hidden="true" href="#取值遍历">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#78787e">//	通过 key 取值
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	key <span style="color:#ff6ac1">:=</span> <span style="color:#5af78e">&#34;name&#34;</span>
</span></span><span style="display:flex;"><span>	value <span style="color:#ff6ac1">:=</span> map2[key]
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;key = name , value = &#34;</span>, value)
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//key = name , value =  Amy
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//	判断一个map是否含有某个 key 值
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	value1, ok <span style="color:#ff6ac1">:=</span> map2[key]
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;key = name , isExist = %t , value = %v\n&#34;</span>, ok, value1)
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//key = name , isExist = true , value = Amy
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//	遍历
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff6ac1">for</span> k, v <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">range</span> map2 {
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%v:%v\n&#34;</span>, k, v)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//name:Amy
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#78787e">//age:13
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#78787e">//gender:female
</span></span></span></code></pre></div><h2 id="function">function<a hidden class="anchor" aria-hidden="true" href="#function">#</a></h2>
<p>go语言中函数特性</p>
<p>1.go语言中有3种函数：普通函数、匿名函数（没有名称的函数）、方法（定义在struct上的函数）。</p>
<p>2.go语言中不允许函数重载(overload),也就是说不允许函数同名。</p>
<p>3.go语言中的函数不能嵌套函数，但可以嵌套匿名函数。</p>
<p>4.函数是一个值，可以将函数赋值给变量，使得这个变量也成为函数。</p>
<p>5.函数可以作为参数传递给另一个函数。</p>
<p>6.函数的返回值可以是一个函数。</p>
<p>7.函数调用的时候，如果有参数传递给函数，则先拷贝参数的副本，再将副本传递给函数。</p>
<p>8.函数参数可以没有名称。</p>
<h3 id="返回值">返回值<a hidden class="anchor" aria-hidden="true" href="#返回值">#</a></h3>
<p>1,return关键字中指定了参数时，返回值可以不用名称。如果return省略参数，则返回值部分必须带名称</p>
<p>2.当返回值有名称时，必须使用括号包围，逗号分隔，即使只有一个返回值</p>
<p>3.但即使返回值命名了，return中也可以强制指定其它返回值的名称，也就是说return的优先级更高</p>
<p>4.命名的返回值是预先声明好的，在函数内部可以直接使用，无需再次声明。命名返回值的名称不能和函数参
数名称相同，否则报错提示变量重复定义</p>
<p>5.return中可以有表达式，但不能出现赋值表达式，这和其它语言可能有所不同。例如return a+b是正确
的，但return c=a+b是错误的。</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Function</span>() {
</span></span><span style="display:flex;"><span>	name, age <span style="color:#ff6ac1">:=</span> <span style="color:#57c7ff">fun1</span>()
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;name:%v,age:%v\n&#34;</span>, name, age)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">fun1</span>() (name <span style="color:#9aedfe">string</span>, age <span style="color:#9aedfe">int</span>) {
</span></span><span style="display:flex;"><span>	name = <span style="color:#5af78e">&#34;Amy&#34;</span>
</span></span><span style="display:flex;"><span>	age = <span style="color:#ff9f43">19</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//	等价于 ==&gt; return name, age
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>}
</span></span></code></pre></div><h3 id="参数">参数<a hidden class="anchor" aria-hidden="true" href="#参数">#</a></h3>
<h4 id="值传递">值传递<a hidden class="anchor" aria-hidden="true" href="#值传递">#</a></h4>
<p>【因为会创建函数副本】</p>
<blockquote>
<p><strong>注意</strong> ：map、slice、interface、channel这些数据类型本身就是指针类型的，所以就算是拷贝传值也是拷贝的指针，拷贝后的参数仍然指向底层数据结构，所以修改它们可能会影响外部数据结构的值。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Function</span>() {
</span></span><span style="display:flex;"><span>	a <span style="color:#ff6ac1">:=</span> []<span style="color:#9aedfe">int</span>{<span style="color:#ff9f43">1</span>, <span style="color:#ff9f43">2</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">fun2</span>(a)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(a[<span style="color:#ff9f43">0</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#78787e">// 100
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">fun2</span>(a []<span style="color:#9aedfe">int</span>) {
</span></span><span style="display:flex;"><span>	a[<span style="color:#ff9f43">0</span>] = <span style="color:#ff9f43">100</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="变长参数">变长参数<a hidden class="anchor" aria-hidden="true" href="#变长参数">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Function</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">fun3</span>(<span style="color:#5af78e">&#34;Amy&#34;</span>, <span style="color:#5af78e">&#34;Beijing&#34;</span>, <span style="color:#5af78e">&#34;23&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">fun3</span>(args <span style="color:#ff6ac1">...</span><span style="color:#9aedfe">string</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> i, arg <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">range</span> args {
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%v:%v\n&#34;</span>, i, arg)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">0</span>:Amy
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">1</span>:Beijing
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">2</span>:<span style="color:#ff9f43">23</span>
</span></span></code></pre></div><h3 id="高阶函数">高阶函数<a hidden class="anchor" aria-hidden="true" href="#高阶函数">#</a></h3>
<p>函数可以作为一个函数的参数、返回值。</p>
<h3 id="匿名函数">匿名函数<a hidden class="anchor" aria-hidden="true" href="#匿名函数">#</a></h3>
<h3 id="闭包">闭包<a hidden class="anchor" aria-hidden="true" href="#闭包">#</a></h3>
<p>闭包可以理解成定义在一个函数内部的函数。在本质上，闭包是将函数内部和函数外部连接起来的桥梁。或者说是函数和其引用环境的组合体。
闭包指的是一个函数和与其相关的引用环境组合而成的实体。简单来说，==闭包=函数+引用环境==。</p>
<p>变量f是一个函数并且它引用了其外部作用域中的x变量，此时f就是一个闭包。在f的生命周期内，变量x也一直有效。</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Closure</span>() {
</span></span><span style="display:flex;"><span>	f <span style="color:#ff6ac1">:=</span> <span style="color:#57c7ff">add</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">println</span>(<span style="color:#57c7ff">f</span>(<span style="color:#ff9f43">10</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">println</span>(<span style="color:#57c7ff">f</span>(<span style="color:#ff9f43">20</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">println</span>(<span style="color:#57c7ff">f</span>(<span style="color:#ff9f43">30</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//  10
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#78787e">//  30
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#78787e">//  60
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#78787e">//	变量逃逸，从栈去到堆
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">add</span>() <span style="color:#ff5c57">func</span>(<span style="color:#9aedfe">int</span>) <span style="color:#9aedfe">int</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">var</span> x <span style="color:#9aedfe">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">return</span> <span style="color:#ff5c57">func</span>(y <span style="color:#9aedfe">int</span>) <span style="color:#9aedfe">int</span> {
</span></span><span style="display:flex;"><span>		x <span style="color:#ff6ac1">+=</span> y
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span> x
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="递归">递归<a hidden class="anchor" aria-hidden="true" href="#递归">#</a></h2>
<p>函数内部调用函数自身的函数称为递归函数。
使用递归函数最重要的三点：</p>
<p>1.递归就是自己调用自己。
2.必须先定义函数的<strong>退出条件</strong>，没有退出条件，递归将成为死循环。
3.go语言递归函数很可能会产生一大堆的goroutine,也很可能会出现栈空间内存谥出问题。</p>
<h2 id="defer">defer<a hidden class="anchor" aria-hidden="true" href="#defer">#</a></h2>
<p>go语言中的defer语句会将其后面跟随的语句进行延迟处理。</p>
<p>在defer归属的函数即将返回时，将延迟处理的语句按defer定义的逆序进行执行，</p>
<p>也就是说，先被defer的语句最后被执行，最后被defer的语句，最先被执行。</p>
<p>defer&rsquo;特性</p>
<p>1.关键字defer用于注册延迟调用。
2.这些调用直到return前才被执。因此，可以用来做资源清理。
3.多个defer语句，按先进后出的方式执行。
4.defer语句中的变量，在defer声明时就决定了。</p>
<p>defer用途
1.关闭文件句柄
2.锁资源释放
3.数据库连接释放</p>
<h2 id="init函数">init函数<a hidden class="anchor" aria-hidden="true" href="#init函数">#</a></h2>
<p>golang有一个特殊的函数init函数，先于main函数执行，实现包级别的一些初始化操作。</p>
<h3 id="init函数的主要特点">init函数的主要特点<a hidden class="anchor" aria-hidden="true" href="#init函数的主要特点">#</a></h3>
<ul>
<li>·init函数先于main函数==自动执行==，不能被其他函数调用：</li>
<li>·init函数<strong>没有输入参数、返回值</strong>：</li>
<li>·每个包可以有多个init函数：</li>
<li>·包的每个源文件也可以有多个init函数，这点比较特殊：</li>
<li>·同一个包的init执行顺序，golang没有明确定义，编程时要注意程序不要依赖这个执行顺序。</li>
<li>·不同包的it函数按照包，导入的依赖关系决定执行顺序。</li>
</ul>
<h3 id="golang初始化顺序">golang初始化顺序<a hidden class="anchor" aria-hidden="true" href="#golang初始化顺序">#</a></h3>
<p>初始化顺序：变量初始化-&gt;init()-&gt;main()</p>
<h2 id="指针">指针<a hidden class="anchor" aria-hidden="true" href="#指针">#</a></h2>
<p>G0语言中的函数传参都是值拷贝，当我们想要修改某个变量的时候，我们可以创建一个指向该变量地址的指针变
量。传递数据使用指针，而无须拷贝数据。</p>
<p>类型指针不能进行偏移和运算。</p>
<p>G0语言中的指针操作非常简单，只需要记住两个符号：<code>&amp;</code>（取地址）和  <code>*</code>（根据地址取值）。</p>
<h3 id="指针地址和指针类型">指针地址和指针类型<a hidden class="anchor" aria-hidden="true" href="#指针地址和指针类型">#</a></h3>
<p>每个变量在运行时都拥有一个地址，这个地址代表变量在内存中的位置。</p>
<p>Go语言中使用<code>&amp;</code>字符放在变量前面对变量进行取地址操作。</p>
<p>Go语言中的值类型(int、float、bool、string、array、struct)都有对应的指针类型，如：<code>*int、*int64、*string</code>等。</p>
<h3 id="指针语法">指针语法<a hidden class="anchor" aria-hidden="true" href="#指针语法">#</a></h3>
<p>一个指针变量指向了一个值的内存地址。</p>
<p>(也就是我们声明了一个指针之后，可以像变量赋值一样，把一个值的内存地址放入到指针当中。)</p>
<p>类似于变量和常量，在使用指针前你需要声明指针。指针声明格式如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">var</span> var_name <span style="color:#ff6ac1">*</span><span style="color:#ff5c57">var</span><span style="color:#ff6ac1">-</span><span style="color:#ff5c57">type</span>
</span></span></code></pre></div><ul>
<li>var-type: 为指针类型</li>
<li>var-name: 为指针变量名</li>
<li><code>*</code>：用于指定变量是作为一个指针</li>
</ul>
<h2 id="指针数组">指针数组<a hidden class="anchor" aria-hidden="true" href="#指针数组">#</a></h2>
<p>表示数组里面的元素的类型是指针类型</p>
<p>定义语法</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">var</span> ptr [MAX]<span style="color:#ff6ac1">*</span><span style="color:#9aedfe">int</span>;
</span></span></code></pre></div><p>例子</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Pointer</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">var</span> arr = [<span style="color:#ff9f43">3</span>]<span style="color:#9aedfe">int</span>{<span style="color:#ff9f43">1</span>, <span style="color:#ff9f43">2</span>, <span style="color:#ff9f43">3</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">var</span> pArr [<span style="color:#ff9f43">3</span>]<span style="color:#ff6ac1">*</span><span style="color:#9aedfe">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> i <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">0</span>; i &lt; <span style="color:#ff5c57">len</span>(arr); i<span style="color:#ff6ac1">++</span> {
</span></span><span style="display:flex;"><span>		pArr[i] = <span style="color:#ff6ac1">&amp;</span>arr[i]
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> i <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">0</span>; i &lt; <span style="color:#ff5c57">len</span>(arr); i<span style="color:#ff6ac1">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff5c57">println</span>(pArr[i])
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//0xc000143f38
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#78787e">//0xc000143f40
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#78787e">//0xc000143f48
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>}
</span></span></code></pre></div><h2 id="类型定义和类型别名">类型定义和类型别名<a hidden class="anchor" aria-hidden="true" href="#类型定义和类型别名">#</a></h2>
<p>在介绍结构体之前，我们先来看看什么是类型定义和类型别名。</p>
<h3 id="go语言类型定义">go语言类型定义<a hidden class="anchor" aria-hidden="true" href="#go语言类型定义">#</a></h3>
<p>类型定义的语法</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>type NewType Type
</span></span></code></pre></div><p>实例</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#78787e">//类型定义
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff5c57">type</span> MyInt <span style="color:#9aedfe">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//i为MyInt类型
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff5c57">var</span> i MyInt
</span></span><span style="display:flex;"><span>	i = <span style="color:#ff9f43">100</span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;i:%v i:%T\n&#34;</span>, i, i)
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//	i:100 i:Base.MyInt
</span></span></span></code></pre></div><h3 id="类型别名">类型别名<a hidden class="anchor" aria-hidden="true" href="#类型别名">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#78787e">//类型别名
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff5c57">type</span> MyInt1 = <span style="color:#9aedfe">int</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">var</span> i1 MyInt1
</span></span><span style="display:flex;"><span>	i1 = <span style="color:#ff9f43">100</span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;i:%v i:%T\n&#34;</span>, i1, i1)
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//	i:100 i:int
</span></span></span></code></pre></div><h2 id="结构体">结构体<a hidden class="anchor" aria-hidden="true" href="#结构体">#</a></h2>
<p>go语言没有面向对象的概念了，但是可以使用结构体来实现面向对象编程的一些特性，例如：继承、组合等特
性。</p>
<h3 id="结构体的定义">结构体的定义<a hidden class="anchor" aria-hidden="true" href="#结构体的定义">#</a></h3>
<p>结构体的定义和类型定义类似，只不过多了一个struct关键字：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">type</span> Person <span style="color:#ff5c57">struct</span> {
</span></span><span style="display:flex;"><span>	id    <span style="color:#9aedfe">int</span>
</span></span><span style="display:flex;"><span>	name  <span style="color:#9aedfe">string</span>
</span></span><span style="display:flex;"><span>	age   <span style="color:#9aedfe">int</span>
</span></span><span style="display:flex;"><span>	email <span style="color:#9aedfe">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Struct</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//  初始化
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	person1 <span style="color:#ff6ac1">:=</span> Person{
</span></span><span style="display:flex;"><span>		<span style="color:#ff9f43">2</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#5af78e">&#34;Amy&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff9f43">23</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#5af78e">&#34;hello@qq.com&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	person2 <span style="color:#ff6ac1">:=</span> Person{
</span></span><span style="display:flex;"><span>		id:    <span style="color:#ff9f43">3</span>,
</span></span><span style="display:flex;"><span>		name:  <span style="color:#5af78e">&#34;Tom&#34;</span>,
</span></span><span style="display:flex;"><span>		age:   <span style="color:#ff9f43">20</span>,
</span></span><span style="display:flex;"><span>		email: <span style="color:#5af78e">&#34;world@qq.com&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%#v\n&#34;</span>, person1)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%#v\n&#34;</span>, person2)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="结构体指针">结构体指针<a hidden class="anchor" aria-hidden="true" href="#结构体指针">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#ff5c57">var</span> p1Point <span style="color:#ff6ac1">*</span>Person
</span></span><span style="display:flex;"><span>	p1Point = <span style="color:#ff6ac1">&amp;</span>person1
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%p\n&#34;</span>, p1Point)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//  通过 new 
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff5c57">var</span> p2Point = <span style="color:#ff5c57">new</span>(Person)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%p\n&#34;</span>, p2Point)
</span></span></code></pre></div><h3 id="结构体作为函数参数">结构体作为函数参数<a hidden class="anchor" aria-hidden="true" href="#结构体作为函数参数">#</a></h3>
<p>go结构体可以像普通变量一样，作为函数的参数，传递给函数，这里分为两种情况：</p>
<ol>
<li>直接传递结构体，这是是一个副本（拷贝），在函数内部不会改变外面结构体内容。</li>
<li>传递结构体指针，这时在函数内部，能够改变外部结构体内容。</li>
</ol>
<h4 id="直接传递结构体">直接传递结构体<a hidden class="anchor" aria-hidden="true" href="#直接传递结构体">#</a></h4>
<p>这是值传递，将拷贝一份，不会改变原来的数据</p>
<h4 id="传递结构体指针">传递结构体指针<a hidden class="anchor" aria-hidden="true" href="#传递结构体指针">#</a></h4>
<p>这就会修改原来的数据了</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">type</span> Person <span style="color:#ff5c57">struct</span> {
</span></span><span style="display:flex;"><span>	id    <span style="color:#9aedfe">int</span>
</span></span><span style="display:flex;"><span>	name  <span style="color:#9aedfe">string</span>
</span></span><span style="display:flex;"><span>	age   <span style="color:#9aedfe">int</span>
</span></span><span style="display:flex;"><span>	email <span style="color:#9aedfe">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Struct</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//  初始化
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	person1 <span style="color:#ff6ac1">:=</span> Person{
</span></span><span style="display:flex;"><span>		<span style="color:#ff9f43">2</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#5af78e">&#34;Amy&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff9f43">23</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#5af78e">&#34;hello@qq.com&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%#v\n&#34;</span>, person1)
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">showPerson</span>(<span style="color:#ff6ac1">&amp;</span>person1)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%#v\n&#34;</span>, person1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//Base.Person{id:2, name:&#34;Amy&#34;, age:23, email:&#34;hello@qq.com&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#78787e">//Base.Person{id:2, name:&#34;Amy&#34;, age:1000, email:&#34;hello@qq.com&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">showPerson</span>(person <span style="color:#ff6ac1">*</span>Person) {
</span></span><span style="display:flex;"><span>	person.age = <span style="color:#ff9f43">1000</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="嵌套结构体">嵌套结构体<a hidden class="anchor" aria-hidden="true" href="#嵌套结构体">#</a></h3>
<p>go语言没有面向对象编程思想，也没有继承关系，但是可以通过结构体嵌套来实现这种效果。</p>
<p>下面通过实例演示如何实现结构体嵌套，加入有一个人Person结构体，这个人还养了一个宠物Dog结构体。</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">type</span> Dog <span style="color:#ff5c57">struct</span> {
</span></span><span style="display:flex;"><span>	name  <span style="color:#9aedfe">string</span>
</span></span><span style="display:flex;"><span>	color <span style="color:#9aedfe">string</span>
</span></span><span style="display:flex;"><span>	age   <span style="color:#9aedfe">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">type</span> Person <span style="color:#ff5c57">struct</span> {
</span></span><span style="display:flex;"><span>	dog  Dog
</span></span><span style="display:flex;"><span>	name <span style="color:#9aedfe">string</span>
</span></span><span style="display:flex;"><span>	age  <span style="color:#9aedfe">int</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="方法">方法<a hidden class="anchor" aria-hidden="true" href="#方法">#</a></h2>
<p>gp语言没有面向对象的特性，也没有类对象的概念。</p>
<p>但是，可以使用结构体来模拟这些特性，我们都知道面向对象里面有类方法等概念。</p>
<p>我们也可以声明一些方法，属于某个结构体。</p>
<h3 id="方法的语法">方法的语法<a hidden class="anchor" aria-hidden="true" href="#方法的语法">#</a></h3>
<p>Go中的方法，是一种特殊的函数，定义于struct之上（与struct关联、绑定），被称为struct的接受者(receiver))。</p>
<p>通俗的讲，方法就是有接收者的函数。</p>
<p>一个方法和一个函数非常相似，多了一个接受类型。</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57c7ff">语法格式如下：</span>
</span></span><span style="display:flex;"><span><span style="color:#57c7ff">type mytype struct{}</span>
</span></span><span style="display:flex;"><span><span style="color:#57c7ff">func (recv mytype)my_method(para)return_type {}</span>
</span></span><span style="display:flex;"><span><span style="color:#57c7ff">func (recv *mytype)my_method(para)return_type {}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57c7ff">mytype:定义一个结构体</span>
</span></span><span style="display:flex;"><span><span style="color:#57c7ff">recv:接受该方法的结构体(receiver)</span>
</span></span><span style="display:flex;"><span><span style="color:#57c7ff">my-method:方法名称</span>
</span></span><span style="display:flex;"><span><span style="color:#57c7ff">para:参数列表</span>
</span></span><span style="display:flex;"><span><span style="color:#57c7ff">return-type:返回值类型</span>
</span></span></code></pre></div><p>实例</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">type</span> Person <span style="color:#ff5c57">struct</span> {
</span></span><span style="display:flex;"><span>	name <span style="color:#9aedfe">string</span>
</span></span><span style="display:flex;"><span>	age  <span style="color:#9aedfe">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> (p Person) <span style="color:#57c7ff">eat</span>() {
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%v is eating.\n&#34;</span>, p.name)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> (p Person) <span style="color:#57c7ff">sleep</span>() {
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%v is sleepy.\n&#34;</span>, p.name)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Struct</span>() {
</span></span><span style="display:flex;"><span>	person <span style="color:#ff6ac1">:=</span> Person{
</span></span><span style="display:flex;"><span>		name: <span style="color:#5af78e">&#34;Tom&#34;</span>,
</span></span><span style="display:flex;"><span>		age:  <span style="color:#ff9f43">43</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	person.<span style="color:#57c7ff">eat</span>()
</span></span><span style="display:flex;"><span>	person.<span style="color:#57c7ff">sleep</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="方法的注意事项">方法的注意事项<a hidden class="anchor" aria-hidden="true" href="#方法的注意事项">#</a></h3>
<ol>
<li>方法的receiver type并非一定要是struct类型，type定义的类型别名、slice、.map、channel、.func类型等都可
以。</li>
<li>struct结合它的方法就等价于面向对象中的类。只不过struct可以和它的方法分开，并非一定要属于同一个文
件，但必须属于同一个包。</li>
<li>方法有两种接收类型：(T Type)和(T*Type),它们之间有区别。</li>
<li>方法就是函数，所以Go中没有方法重载(overload)的说法，也就是说同一个类型中的所有方法名必须都唯一。</li>
<li>如果receiver是一个指针类型，则会自动解除引用。</li>
<li>方法和type是分开的，意味着实例的行为(behavior)和数据存储(field)是分开的，但是它们通过receiver建立起
关联关系。</li>
</ol>
<h3 id="方法接收者类型">方法接收者类型<a hidden class="anchor" aria-hidden="true" href="#方法接收者类型">#</a></h3>
<p>结构体实例，有值类型和指针类型，那么方法的接收者是结构体，那么也有值类型和指针类型。</p>
<p>区别就是接收者是否复制结构体副本。==值类型复制，指针类型不复制。==</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> Base
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> <span style="color:#5af78e">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">type</span> Person <span style="color:#ff5c57">struct</span> {
</span></span><span style="display:flex;"><span>	name <span style="color:#9aedfe">string</span>
</span></span><span style="display:flex;"><span>	age  <span style="color:#9aedfe">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> (p Person) <span style="color:#57c7ff">modifyName</span>() {
</span></span><span style="display:flex;"><span>	p.name = <span style="color:#5af78e">&#34;hello&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> (p <span style="color:#ff6ac1">*</span>Person) <span style="color:#57c7ff">modifyName1</span>() {
</span></span><span style="display:flex;"><span>	p.name = <span style="color:#5af78e">&#34;hello&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Struct</span>() {
</span></span><span style="display:flex;"><span>	person <span style="color:#ff6ac1">:=</span> Person{
</span></span><span style="display:flex;"><span>		name: <span style="color:#5af78e">&#34;Tom&#34;</span>,
</span></span><span style="display:flex;"><span>		age:  <span style="color:#ff9f43">43</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(person)
</span></span><span style="display:flex;"><span>	person.<span style="color:#57c7ff">modifyName</span>()
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(person)
</span></span><span style="display:flex;"><span>	person.<span style="color:#57c7ff">modifyName1</span>()
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(person)
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//{Tom 43}
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#78787e">//{Tom 43}
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#78787e">//{hello 43}
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>}
</span></span></code></pre></div><h2 id="接口">接口<a hidden class="anchor" aria-hidden="true" href="#接口">#</a></h2>
<p>接口像是一个公司里面的领导，他会定义一些通用规范，<strong>只设计规范，而不实现规范</strong>。</p>
<p>go语言的接口，是一种新的类型定义，它把所有的具有共性的方法定义在一起，任何其他类型只要实现了这些方
法就是实现了这个接口。</p>
<p>语法格式和方法非常类似。</p>
<h3 id="db_init">db_init<a hidden class="anchor" aria-hidden="true" href="#db_init">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> Dao
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;server/Model&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;gorm.io/driver/mysql&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;gorm.io/gorm&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;gorm.io/gorm/schema&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">type</span> Manager <span style="color:#ff5c57">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">Register</span>(userinfo Model.User) <span style="color:#9aedfe">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">GetUser</span>(userId <span style="color:#9aedfe">uint64</span>) (Model.User, <span style="color:#9aedfe">error</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">IsExist</span>(username <span style="color:#9aedfe">string</span>) (Model.User, <span style="color:#9aedfe">error</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">GetPostListByUserId</span>(userId <span style="color:#9aedfe">uint64</span>) ([]Model.Post, <span style="color:#9aedfe">error</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">UpdateProfileById</span>(userId <span style="color:#9aedfe">uint64</span>, data <span style="color:#ff6ac1">*</span>Model.User) <span style="color:#9aedfe">error</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">GetCommunityList</span>() ([]Model.Community, <span style="color:#9aedfe">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">StoreArticle</span>(postInfo Model.Post) <span style="color:#9aedfe">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">GetList</span>(latestTime <span style="color:#9aedfe">int64</span>) ([]Model.Post, <span style="color:#9aedfe">error</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">GetPostById</span>(postId <span style="color:#9aedfe">int64</span>) (Model.Post, <span style="color:#9aedfe">error</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">GetUsernameById</span>(AuthorId <span style="color:#9aedfe">uint64</span>) (author <span style="color:#9aedfe">string</span>, err <span style="color:#9aedfe">error</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">GetCommunityNameById</span>(CommunityId <span style="color:#9aedfe">uint64</span>) (CommunityName <span style="color:#9aedfe">string</span>, err <span style="color:#9aedfe">error</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">DeletePostById</span>(postId <span style="color:#9aedfe">int64</span>) <span style="color:#9aedfe">error</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">AddComment</span>(comment <span style="color:#ff6ac1">*</span>Model.Comment)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">type</span> manager <span style="color:#ff5c57">struct</span> {
</span></span><span style="display:flex;"><span>	db <span style="color:#ff6ac1">*</span>gorm.DB
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">var</span> Mgr Manager
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">init</span>() {
</span></span><span style="display:flex;"><span>	dsn <span style="color:#ff6ac1">:=</span> <span style="color:#5af78e">&#34;root:Admin666@tcp(127.0.0.1:3306)/blogserver?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&#34;</span>
</span></span><span style="display:flex;"><span>	db, err <span style="color:#ff6ac1">:=</span> gorm.<span style="color:#57c7ff">Open</span>(mysql.<span style="color:#57c7ff">Open</span>(dsn), <span style="color:#ff6ac1">&amp;</span>gorm.Config{
</span></span><span style="display:flex;"><span>		NamingStrategy: schema.NamingStrategy{
</span></span><span style="display:flex;"><span>			SingularTable: <span style="color:#ff6ac1">true</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#57c7ff">Fatal</span>(<span style="color:#5af78e">&#34;Failed to init db:&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	Mgr = <span style="color:#ff6ac1">&amp;</span>manager{db: db}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">:=</span> db.<span style="color:#57c7ff">AutoMigrate</span>(<span style="color:#ff6ac1">&amp;</span>Model.Post{}); err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#57c7ff">Fatal</span>(err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="daouser">dao.user<a hidden class="anchor" aria-hidden="true" href="#daouser">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> Dao
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;server/Model&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> (mgr manager) <span style="color:#57c7ff">Register</span>(userinfo Model.User) <span style="color:#9aedfe">error</span> {
</span></span><span style="display:flex;"><span>	result <span style="color:#ff6ac1">:=</span> mgr.db.<span style="color:#57c7ff">Create</span>(<span style="color:#ff6ac1">&amp;</span>userinfo)
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">return</span> result.Error
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> (mgr manager) <span style="color:#57c7ff">GetUser</span>(userId <span style="color:#9aedfe">uint64</span>) (Model.User, <span style="color:#9aedfe">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">var</span> user Model.User
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">:=</span> mgr.db.<span style="color:#57c7ff">Select</span>(<span style="color:#5af78e">&#34;user_id&#34;</span>, <span style="color:#5af78e">&#34;username&#34;</span>, <span style="color:#5af78e">&#34;company&#34;</span>, <span style="color:#5af78e">&#34;user_page&#34;</span>, <span style="color:#5af78e">&#34;user_introduce&#34;</span>, <span style="color:#5af78e">&#34;position&#34;</span>, <span style="color:#5af78e">&#34;created_at&#34;</span>).
</span></span><span style="display:flex;"><span>		<span style="color:#57c7ff">Where</span>(<span style="color:#5af78e">&#34;user_id=?&#34;</span>, userId).<span style="color:#57c7ff">Find</span>(<span style="color:#ff6ac1">&amp;</span>user).Error; err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span> user, err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">return</span> user, <span style="color:#ff6ac1">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> (mgr manager) <span style="color:#57c7ff">IsExist</span>(username <span style="color:#9aedfe">string</span>) (Model.User, <span style="color:#9aedfe">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">var</span> userinfo Model.User
</span></span><span style="display:flex;"><span>	result <span style="color:#ff6ac1">:=</span> mgr.db.<span style="color:#57c7ff">Where</span>(<span style="color:#5af78e">&#34;username=?&#34;</span>, username).<span style="color:#57c7ff">Find</span>(<span style="color:#ff6ac1">&amp;</span>userinfo)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">return</span> userinfo, result.Error
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> (mgr manager) <span style="color:#57c7ff">UpdateProfileById</span>(userId <span style="color:#9aedfe">uint64</span>, data <span style="color:#ff6ac1">*</span>Model.User) <span style="color:#9aedfe">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">var</span> userinfo Model.User
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">var</span> maps = <span style="color:#ff5c57">make</span>(<span style="color:#ff5c57">map</span>[<span style="color:#9aedfe">string</span>]<span style="color:#ff5c57">interface</span>{})
</span></span><span style="display:flex;"><span>	maps[<span style="color:#5af78e">&#34;username&#34;</span>] = data.Username
</span></span><span style="display:flex;"><span>	maps[<span style="color:#5af78e">&#34;user_page&#34;</span>] = data.UserPage
</span></span><span style="display:flex;"><span>	maps[<span style="color:#5af78e">&#34;company&#34;</span>] = data.Company
</span></span><span style="display:flex;"><span>	maps[<span style="color:#5af78e">&#34;user_introduce&#34;</span>] = data.UserIntroduce
</span></span><span style="display:flex;"><span>	maps[<span style="color:#5af78e">&#34;position&#34;</span>] = data.Position
</span></span><span style="display:flex;"><span>	err <span style="color:#ff6ac1">:=</span> mgr.db.<span style="color:#57c7ff">Model</span>(<span style="color:#ff6ac1">&amp;</span>userinfo).<span style="color:#57c7ff">Where</span>(<span style="color:#5af78e">&#34;user_id = ? &#34;</span>, userId).<span style="color:#57c7ff">Updates</span>(maps).Error
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">return</span> err
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="接口和类型的关系">接口和类型的关系<a hidden class="anchor" aria-hidden="true" href="#接口和类型的关系">#</a></h3>
<p>1.一个类型可以实现多个接口
2.多个类型可以实现同一个接口（多态）</p>
<p>一个类型实现多个接口</p>
<p>例如：有一个Player接口可以播放音乐，有一个Video接口可以播放视频，</p>
<p>一个手机Mobile实现这两个接口，既可以播放音乐，又可以播放视频。</p>
<h3 id="接口嵌套">接口嵌套<a hidden class="anchor" aria-hidden="true" href="#接口嵌套">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> Base
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> <span style="color:#5af78e">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">type</span> Fly <span style="color:#ff5c57">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">FlyFunc</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">type</span> Swim <span style="color:#ff5c57">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">SwimFunc</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">type</span> FlyFish <span style="color:#ff5c57">interface</span> {
</span></span><span style="display:flex;"><span>	Fly
</span></span><span style="display:flex;"><span>	Swim
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">type</span> Fish <span style="color:#ff5c57">struct</span> {
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> (f Fish) <span style="color:#57c7ff">FlyFunc</span>() {
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;Fish is flying.&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> (f Fish) <span style="color:#57c7ff">SwimFunc</span>() {
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;Fish is swimming.&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Interface</span>() {
</span></span><span style="display:flex;"><span>   <span style="color:#ff5c57">var</span> ff FlyFish
</span></span><span style="display:flex;"><span>   <span style="color:#78787e">//  此处如果不实现方法会报错
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>   ff = Fish{}
</span></span><span style="display:flex;"><span>   ff.<span style="color:#57c7ff">SwimFunc</span>()
</span></span><span style="display:flex;"><span>   ff.<span style="color:#57c7ff">FlyFunc</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="通过接口实现ocp设计原则">通过接口实现OCP设计原则<a hidden class="anchor" aria-hidden="true" href="#通过接口实现ocp设计原则">#</a></h3>
<p>面向对象的可复用设计的第一块基石，便是所谓的”开-闭“原则(Open-Closed Principle,常缩写为OCP)。</p>
<p>虽然，go不是面向对象语言，但是也可以模拟实现这个原则。</p>
<h3 id="实例">实例<a hidden class="anchor" aria-hidden="true" href="#实例">#</a></h3>
<p>接口:</p>
<ul>
<li>
<p>特殊的数据类型</p>
</li>
<li>
<p>方法定义的集合</p>
</li>
<li>
<p>方法名(形参类型)返回值类型</p>
</li>
<li>
<p>提高代码的复用率</p>
</li>
</ul>
<p>接口本身不能绑定方法</p>
<p>保存的是：值+原始类型</p>
<p>5.2.2 实现</p>
<p>一个类型实现了接口的所有方法</p>
<p>即实现了该接口</p>
<p>go中无需“implements”关键字</p>
<p>5.2.3 类型选择</p>
<p>switch…case + interface.(type)</p>
<p>.(type)不能在 switch…case 外使用</p>
<p>5.2.4 类型断言</p>
<p>还原为原始类型 interface.(Type)</p>
<p>如果接口没有保存类型，则会报错</p>
<p>可返回两个值</p>
<p>value, ok :=  interface.(Type)</p>
<p>5.2.5 空接口</p>
<p>interface{}</p>
<p>空接口可保存任何类型</p>
<p>5.2.6 nil问题</p>
<p>nil 值：有类型没有值，接口本身并不是 nil，可以处理</p>
<p>nil 接口：即没有保存值，也没有保存类型，使用时会报错</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#78787e">//5.2 接口
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span><span style="color:#ff5c57">type</span> textMes <span style="color:#ff5c57">struct</span> {
</span></span><span style="display:flex;"><span>	Type <span style="color:#9aedfe">string</span>
</span></span><span style="display:flex;"><span>	Text <span style="color:#9aedfe">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> (tm <span style="color:#ff6ac1">*</span>textMes) <span style="color:#57c7ff">setText</span>() {
</span></span><span style="display:flex;"><span>	tm.Text = <span style="color:#5af78e">&#34;hello&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">type</span> imgMes <span style="color:#ff5c57">struct</span> {
</span></span><span style="display:flex;"><span>	Type <span style="color:#9aedfe">string</span>
</span></span><span style="display:flex;"><span>	Img  <span style="color:#9aedfe">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> (im <span style="color:#ff6ac1">*</span>imgMes) <span style="color:#57c7ff">setImg</span>() {
</span></span><span style="display:flex;"><span>	im.Img = <span style="color:#5af78e">&#34;清明上河图&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">type</span> Mes <span style="color:#ff5c57">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">setType</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> (tm <span style="color:#ff6ac1">*</span>textMes) <span style="color:#57c7ff">setType</span>() {
</span></span><span style="display:flex;"><span>	tm.Type = <span style="color:#5af78e">&#34;文字消息&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> (im <span style="color:#ff6ac1">*</span>imgMes) <span style="color:#57c7ff">setType</span>() {
</span></span><span style="display:flex;"><span>	im.Type = <span style="color:#5af78e">&#34;图片消息&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">SendMes</span>(m Mes) {
</span></span><span style="display:flex;"><span>	m.<span style="color:#57c7ff">setType</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">switch</span> mptr <span style="color:#ff6ac1">:=</span> m.(<span style="color:#ff5c57">type</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">case</span> <span style="color:#ff6ac1">*</span>textMes:
</span></span><span style="display:flex;"><span>		mptr.<span style="color:#57c7ff">setText</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">case</span> <span style="color:#ff6ac1">*</span>imgMes:
</span></span><span style="display:flex;"><span>		mptr.<span style="color:#57c7ff">setImg</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;m=&#34;</span>, m)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Interface</span>() {
</span></span><span style="display:flex;"><span>	tm <span style="color:#ff6ac1">:=</span> textMes{}
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">SendMes</span>(<span style="color:#ff6ac1">&amp;</span>tm)
</span></span><span style="display:flex;"><span>	im <span style="color:#ff6ac1">:=</span> imgMes{}
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">SendMes</span>(<span style="color:#ff6ac1">&amp;</span>im)
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">var</span> n1 <span style="color:#9aedfe">int</span> = <span style="color:#ff9f43">1</span>
</span></span><span style="display:flex;"><span>	n1interface <span style="color:#ff6ac1">:=</span> <span style="color:#ff5c57">interface</span>{}(n1)
</span></span><span style="display:flex;"><span>	n2, ok <span style="color:#ff6ac1">:=</span> n1interface.(<span style="color:#9aedfe">int</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> ok {
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;n2=&#34;</span>, n2)
</span></span><span style="display:flex;"><span>	} <span style="color:#ff6ac1">else</span> {
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;类型断言失败&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="继承">继承<a hidden class="anchor" aria-hidden="true" href="#继承">#</a></h2>
<p>golang本质上没有ocp的概念，也没有继承的概念，但是可以通过结构体嵌套实现这个特性。</p>
<p>golang 中的继承是通过结构体中的==匿名字段==来实现</p>
<p>例：定义一个 BaseNum 对象 (结构体)，作为父类，Add 和Sub 对象(结构体)中包含了BaseNum 匿名字段， 此时 Add 和Sub 就是BaseNum的子类</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff6ac1">type</span> <span style="color:#f3f99d">BaseNum</span> <span style="color:#ff6ac1">struct</span> {
</span></span><span style="display:flex;"><span>     num1 int
</span></span><span style="display:flex;"><span>     num2 int
</span></span><span style="display:flex;"><span>} <span style="color:#78787e">// BaseNum 即为父类型名称
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">type</span> <span style="color:#f3f99d">Add</span> <span style="color:#ff6ac1">struct</span> {
</span></span><span style="display:flex;"><span>    BaseNum
</span></span><span style="display:flex;"><span>} <span style="color:#78787e">//加法子类, 定义加法子类的主要目的, 是为了定义对应子类的方法
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">type</span> <span style="color:#f3f99d">Sub</span> <span style="color:#ff6ac1">struct</span> {
</span></span><span style="display:flex;"><span>    BaseNum
</span></span><span style="display:flex;"><span>} <span style="color:#78787e">//减法子类
</span></span></span></code></pre></div><h2 id="构造函数">构造函数<a hidden class="anchor" aria-hidden="true" href="#构造函数">#</a></h2>
<p>golang没有构造函数的概念，可以使用函数来模拟构造函数的的功能。</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> Base
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> <span style="color:#5af78e">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">type</span> Person1 <span style="color:#ff5c57">struct</span> {
</span></span><span style="display:flex;"><span>	name <span style="color:#9aedfe">string</span>
</span></span><span style="display:flex;"><span>	age  <span style="color:#9aedfe">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">NewPerson</span>(name <span style="color:#9aedfe">string</span>, age <span style="color:#9aedfe">int</span>) (<span style="color:#ff6ac1">*</span>Person1, <span style="color:#9aedfe">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> name <span style="color:#ff6ac1">==</span> <span style="color:#5af78e">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span> <span style="color:#ff6ac1">nil</span>, fmt.<span style="color:#57c7ff">Errorf</span>(<span style="color:#5af78e">&#34;name不能为空&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> age &lt; <span style="color:#ff9f43">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span> <span style="color:#ff6ac1">nil</span>, fmt.<span style="color:#57c7ff">Errorf</span>(<span style="color:#5af78e">&#34;age不能小于g&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">return</span> <span style="color:#ff6ac1">&amp;</span>Person1{name: name, age: age}, <span style="color:#ff6ac1">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Constructor</span>() {
</span></span><span style="display:flex;"><span>	person, err <span style="color:#ff6ac1">:=</span> <span style="color:#57c7ff">NewPerson</span>(<span style="color:#5af78e">&#34;tom&#34;</span>, <span style="color:#ff9f43">20</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;err:%v\n&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;person:%v\n&#34;</span>, <span style="color:#ff6ac1">*</span>person)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="包管理工具go-module">包管理工具go module<a hidden class="anchor" aria-hidden="true" href="#包管理工具go-module">#</a></h2>
<p>go modules是golang1.11新加的特性，用来管理模块中包的依赖关系。</p>
<p>go mod使用方法</p>
<ul>
<li>
<p>初始化模块	go mod init&lt;项目模块名称&gt;</p>
</li>
<li>
<p>依赖关系处理，根据go.mod文件	go mod tidy</p>
</li>
<li>
<p>将依赖包复制到项目下的vendor目录	go mod vendor</p>
<p>如果包被屏蔽（墙），可以使用这个命令，随后使用go build-mod=vendor编译</p>
</li>
<li>
<p>显示依赖关系	go list -m all</p>
</li>
<li>
<p>显示详细依赖关系	go list -m -json all</p>
</li>
<li>
<p>下载依赖	go mod download [path@version]
[path@version]是非必写的</p>
</li>
</ul>
<h2 id="并发编程-协程">并发编程-&gt;协程<a hidden class="anchor" aria-hidden="true" href="#并发编程-协程">#</a></h2>
<p>Golang中的并发是函数相互独立运行的能力。<code>Goroutines</code>是并发运行的函数。</p>
<p>Golang提供了Goroutines作为并发处理操作的一种方式。</p>
<p>创建一个协程非常简单，就是在一个任务函数前面添加一个go关键字：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">go</span> <span style="color:#57c7ff">task</span>()
</span></span></code></pre></div><h3 id="q1-select--case">Q1 select …… case<a hidden class="anchor" aria-hidden="true" href="#q1-select--case">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e">//5.3 协程
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span><span style="color:#ff5c57">var</span> (
</span></span><span style="display:flex;"><span>	c    <span style="color:#9aedfe">int</span>
</span></span><span style="display:flex;"><span>	lock sync.Mutex
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">PrimeNum</span>(n <span style="color:#9aedfe">int</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> i <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">2</span>; i &lt; n; i<span style="color:#ff6ac1">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">if</span> n<span style="color:#ff6ac1">%</span>i <span style="color:#ff6ac1">==</span> <span style="color:#ff9f43">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%v\t&#34;</span>, n)
</span></span><span style="display:flex;"><span>	lock.<span style="color:#57c7ff">Lock</span>()
</span></span><span style="display:flex;"><span>	c<span style="color:#ff6ac1">++</span>
</span></span><span style="display:flex;"><span>	lock.<span style="color:#57c7ff">Unlock</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Goroutine</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> i <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">2</span>; i &lt; <span style="color:#ff9f43">100001</span>; i<span style="color:#ff6ac1">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">go</span> <span style="color:#57c7ff">PrimeNum</span>(i)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">var</span> key <span style="color:#9aedfe">string</span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Scanln</span>(<span style="color:#ff6ac1">&amp;</span>key)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;\n共找到%v个素数\n&#34;</span>, c)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e">//5.4 channel
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">pushNum</span>(c <span style="color:#ff5c57">chan</span> <span style="color:#9aedfe">int</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> i <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">0</span>; i &lt; <span style="color:#ff9f43">100</span>; i<span style="color:#ff6ac1">++</span> {
</span></span><span style="display:flex;"><span>		c <span style="color:#ff6ac1">&lt;-</span> i
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">close</span>(c)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">pushPrimeNum</span>(n <span style="color:#9aedfe">int</span>, c <span style="color:#ff5c57">chan</span> <span style="color:#9aedfe">int</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> i <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">2</span>; i &lt; n; i<span style="color:#ff6ac1">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">if</span> n<span style="color:#ff6ac1">%</span>i <span style="color:#ff6ac1">==</span> <span style="color:#ff9f43">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	c <span style="color:#ff6ac1">&lt;-</span> n
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Channel</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">var</span> c1 <span style="color:#ff5c57">chan</span> <span style="color:#9aedfe">int</span> = <span style="color:#ff5c57">make</span>(<span style="color:#ff5c57">chan</span> <span style="color:#9aedfe">int</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">go</span> <span style="color:#57c7ff">pushNum</span>(c1)
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// for {
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#78787e">// 	v, ok := &lt;-c1
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#78787e">// 	if ok {
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#78787e">// 		fmt.Printf(&#34;%v\t&#34;, v)
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#78787e">// 	} else {
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#78787e">// 		break
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#78787e">// 	}
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#78787e">// }
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff6ac1">for</span> v <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">range</span> c1 {
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%v\t&#34;</span>, v)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">var</span> c2 <span style="color:#ff5c57">chan</span> <span style="color:#9aedfe">int</span> = <span style="color:#ff5c57">make</span>(<span style="color:#ff5c57">chan</span> <span style="color:#9aedfe">int</span>, <span style="color:#ff9f43">100</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> i <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">2</span>; i &lt; <span style="color:#ff9f43">100001</span>; i<span style="color:#ff6ac1">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">go</span> <span style="color:#57c7ff">pushPrimeNum</span>(i, c2)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>Print:
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">select</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">case</span> v <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">&lt;-</span>c2:
</span></span><span style="display:flex;"><span>			fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%v\t&#34;</span>, v)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">default</span>:
</span></span><span style="display:flex;"><span>			fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;所有素数已经找到&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">break</span> Print
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在 Go 编程语言中，<code>select</code> 语句用于在多个通道操作中进行选择。它可以在多个通道上等待数据到达或操作完成，并根据情况执行相应的操作。<code>select</code> 的结构如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">select</span> {
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">case</span> <span style="color:#ff6ac1">&lt;-</span>channel1:
</span></span><span style="display:flex;"><span>    <span style="color:#78787e">// 执行 channel1 数据到达时的操作
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span><span style="color:#ff6ac1">case</span> data <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">&lt;-</span>channel2:
</span></span><span style="display:flex;"><span>    <span style="color:#78787e">// 执行 channel2 数据到达时的操作，并将数据存储在 data 变量中
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span><span style="color:#ff6ac1">case</span> channel3 <span style="color:#ff6ac1">&lt;-</span> data:
</span></span><span style="display:flex;"><span>    <span style="color:#78787e">// 执行将 data 发送到 channel3 的操作
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span><span style="color:#ff6ac1">default</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#78787e">// 当没有任何通道操作准备就绪时执行的操作
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>}
</span></span></code></pre></div><p>在您提供的代码中，您使用了 <code>select</code> 来从通道 <code>c2</code> 中接收数据，同时还设置了一个 <code>default</code> 分支。让我对您的代码进行解释：</p>
<ol>
<li>首先，您创建了一个缓冲通道 <code>c2</code>，并启动了一系列 goroutine，每个 goroutine 负责将素数推送到 <code>c2</code> 通道。</li>
<li>然后，使用一个无限循环，不断地执行 <code>select</code> 语句。</li>
<li>在 <code>select</code> 语句中，您使用了一个 <code>case</code> 分支，该分支尝试从 <code>c2</code> 通道接收一个整数。如果 <code>c2</code> 通道中有数据，它会执行相应的操作，将接收到的整数打印出来。</li>
<li>您还使用了一个 <code>default</code> 分支，这是当没有通道操作准备就绪时执行的分支。在这种情况下，它会输出 &ldquo;所有素数已经找到&rdquo;，并通过 <code>break Print</code> 语句跳出 <code>for</code> 循环。</li>
</ol>
<p>总结来说，您的代码通过多个并发的 goroutine 计算素数并推送到通道中，然后使用 <code>select</code> 语句从通道中接收数据并进行处理。<code>select</code> 的作用在于允许您同时等待多个通道的数据到达，哪个通道有数据，就执行相应的操作。</p>
<p>那这段代码没有 select case 可以吗？</p>
<p>当您使用 <code>select</code> 时，是因为您希望能够同时监视多个通道，并在其中任何一个通道就绪时执行相应的操作。在您的代码示例中，您使用 <code>select</code> 来从通道 <code>c2</code> 接收数据，并在没有数据可接收时输出提示。</p>
<p>如果您不需要同时监视多个通道，而只是希望从单个通道中接收数据并执行相应的操作，那么是可以省略 <code>select</code> 的。您可以直接使用通道的阻塞接收操作，例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">for</span> {
</span></span><span style="display:flex;"><span>    v, ok <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">&lt;-</span>c2
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">if</span> !ok {
</span></span><span style="display:flex;"><span>        fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;所有素数已经找到&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">break</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;%v\t&#34;</span>, v)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在这个循环中，<code>v, ok := &lt;-c2</code> 将从通道 <code>c2</code> 接收数据，并将数据存储在变量 <code>v</code> 中。同时，<code>ok</code> 表示通道是否关闭，如果通道关闭了，就不再有数据可以接收了。</p>
<p>然后，您可以检查 <code>ok</code> 的值，如果为 <code>false</code>，就输出提示信息并跳出循环。否则，继续执行打印操作。</p>
<p>所以，您可以根据自己的需求，选择使用带有 <code>select</code> 的并发操作，或者直接使用通道的阻塞接收操作。</p>
<h2 id="并发编程-通道channel">并发编程-&gt;通道channel<a hidden class="anchor" aria-hidden="true" href="#并发编程-通道channel">#</a></h2>
<p>Go提供了一种称为通道的机制，用于在==goroutine之间==共享数据。</p>
<p>当您作为goroutine执行并发活动时，需要在goroutine之间共享资源或数据，通道充当goroutine之间的管道（管道）并提供一种机制来保证同步交换。需要在声明通道时指定数据类型。我们可以共享内置、命名、结构和引用类型的值和指针。数据在通道上传递：在
任何给定时间只有一个goroutine可以访问数据项：因此按照设计不会发生数据竞争。</p>
<p>根据数据交换的行为，有两种类型的通道：无缓冲通道和缓冲通道。</p>
<p>无缓冲通道用于执行goroutine之间的同步通信，而缓冲通道用于执行异步通信。</p>
<p>无缓冲通道保证在发送和接收发生的瞬间执行两个goroutine之间的交换。缓冲通道没有这样的保证。</p>
<p>无缓冲通道（Unbuffered Channel）和缓冲通道（Buffered Channel）是 Go 语言中的两种通道类型，它们在使用方式和适用场景上有一些区别。</p>
<ol>
<li>
<p><strong>无缓冲通道：</strong></p>
<p>无缓冲通道是指在发送数据到通道时，发送方会被阻塞直到接收方接收数据。同样，在接收数据时，接收方会被阻塞直到发送方发送数据。这种通道保证了数据的同步传输，发送和接收是紧密耦合的。无缓冲通道的声明方式为 <code>make(chan T)</code>。</p>
<p><strong>适用场景：</strong></p>
<ul>
<li>在并发编程中，用于协调两个 goroutine 之间的同步操作。</li>
<li>当确保发送方和接收方同步工作很重要时，可以使用无缓冲通道。</li>
</ul>
</li>
<li>
<p><strong>缓冲通道：</strong></p>
<p>缓冲通道允许在通道中存储一定数量的数据，当通道中的数据数量达到缓冲区大小时，发送方才会被阻塞。只有在通道满了时，发送方才会被阻塞。同样，当通道中没有数据时，接收方才会被阻塞。缓冲通道的声明方式为 <code>make(chan T, capacity)</code>。</p>
<p><strong>适用场景：</strong></p>
<ul>
<li>在解耦发送方和接收方的情况下，允许发送方发送数据到通道，然后继续执行其他操作，而不必等待接收方。</li>
<li>在生产者-消费者模式中，可以使用缓冲通道来平衡生产者和消费者之间的速度差异</li>
</ul>
</li>
</ol>
<p>通道由<code>make</code>函数创建，该函数指定chan关键字和通道的元素类型。</p>
<p>这是创建无缓冲和缓冲通道的代码块：</p>
<p>语法</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>Unbuffered<span style="color:#ff6ac1">:=</span><span style="color:#ff5c57">make</span>(<span style="color:#ff5c57">chan</span> <span style="color:#9aedfe">int</span>)	<span style="color:#78787e">//整型无缓冲通道
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>buffered<span style="color:#ff6ac1">:=</span><span style="color:#ff5c57">make</span>(<span style="color:#ff5c57">chan</span> <span style="color:#9aedfe">int</span>,<span style="color:#ff9f43">10</span>)	<span style="color:#78787e">//整型有缓冲通道
</span></span></span></code></pre></div><p>使用内置函数make创建无缓冲和缓冲通道。</p>
<p>make的第一个参数需要关键字chan,然后是通道允许交换的数据类型。</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> Base
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;math/rand&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">var</span> channel = <span style="color:#ff5c57">make</span>(<span style="color:#ff5c57">chan</span> <span style="color:#9aedfe">int</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">send</span>() {
</span></span><span style="display:flex;"><span>	rand.<span style="color:#57c7ff">Seed</span>(time.<span style="color:#57c7ff">Now</span>().<span style="color:#57c7ff">UnixNano</span>())
</span></span><span style="display:flex;"><span>	random <span style="color:#ff6ac1">:=</span> rand.<span style="color:#57c7ff">Intn</span>(<span style="color:#ff9f43">10</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">println</span>(<span style="color:#5af78e">&#34;随机值：&#34;</span>, random)
</span></span><span style="display:flex;"><span>	time.<span style="color:#57c7ff">Sleep</span>(<span style="color:#ff9f43">2</span> <span style="color:#ff6ac1">*</span> time.Second)
</span></span><span style="display:flex;"><span>	channel <span style="color:#ff6ac1">&lt;-</span> random
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">GoRoutine</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">defer</span> <span style="color:#ff5c57">close</span>(channel)
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">go</span> <span style="color:#57c7ff">send</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">println</span>(<span style="color:#5af78e">&#34;wait...&#34;</span>)
</span></span><span style="display:flex;"><span>	receive <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">&lt;-</span>channel
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">println</span>(<span style="color:#5af78e">&#34;接收值：&#34;</span>, receive)
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">println</span>(<span style="color:#5af78e">&#34;end...&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="channel-遍历">channel 遍历<a hidden class="anchor" aria-hidden="true" href="#channel-遍历">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> Base
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Channel</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	c <span style="color:#ff6ac1">:=</span> <span style="color:#ff5c57">make</span>(<span style="color:#ff5c57">chan</span> <span style="color:#9aedfe">int</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">go</span> <span style="color:#ff5c57">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">for</span> i <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">0</span>; i &lt; <span style="color:#ff9f43">5</span>; i<span style="color:#ff6ac1">++</span> {
</span></span><span style="display:flex;"><span>			c <span style="color:#ff6ac1">&lt;-</span> i
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ff5c57">close</span>(c)
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> v <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">range</span> c {
</span></span><span style="display:flex;"><span>		<span style="color:#ff5c57">println</span>(v)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="并发编程-waitgroup实现同步">并发编程-&gt;WaitGroup实现同步<a hidden class="anchor" aria-hidden="true" href="#并发编程-waitgroup实现同步">#</a></h2>
<p>查看添加WaitGroup和不添加WaitGroup的区别</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> Base
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">var</span> wg sync.WaitGroup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">showMsg</span>(i <span style="color:#9aedfe">int</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">defer</span> wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(i)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">GoRoutine</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> i <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">0</span>; i &lt; <span style="color:#ff9f43">10</span>; i<span style="color:#ff6ac1">++</span> {
</span></span><span style="display:flex;"><span>		wg.<span style="color:#57c7ff">Add</span>(<span style="color:#ff9f43">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">go</span> <span style="color:#57c7ff">showMsg</span>(i)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	wg.<span style="color:#57c7ff">Wait</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#78787e">// StuData 请求参数验证结构
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span><span style="color:#ff5c57">type</span> StuData <span style="color:#ff5c57">struct</span> {
</span></span><span style="display:flex;"><span>	File <span style="color:#ff6ac1">*</span>multipart.FileHeader <span style="color:#5af78e">`form:&#34;file&#34; binding:&#34;required&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">dealStuData</span>(row []<span style="color:#9aedfe">string</span>, buff <span style="color:#ff5c57">chan</span> <span style="color:#ff5c57">map</span>[<span style="color:#9aedfe">string</span>]<span style="color:#9aedfe">string</span>, wg <span style="color:#ff6ac1">*</span>sync.WaitGroup, userList <span style="color:#ff5c57">chan</span> <span style="color:#ff5c57">map</span>[<span style="color:#9aedfe">string</span>]<span style="color:#9aedfe">string</span>, errData <span style="color:#ff5c57">chan</span> []<span style="color:#9aedfe">string</span>) {
</span></span><span style="display:flex;"><span>	errMsg <span style="color:#ff6ac1">:=</span> <span style="color:#ff5c57">make</span>(<span style="color:#ff5c57">map</span>[<span style="color:#9aedfe">string</span>]<span style="color:#9aedfe">string</span>, <span style="color:#ff9f43">0</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// 不能提交空数据
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff6ac1">for</span> _, val <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">range</span> row {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">if</span> val <span style="color:#ff6ac1">==</span> <span style="color:#5af78e">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;reason&#34;</span>] = <span style="color:#5af78e">&#34;数据不能为空&#34;</span>
</span></span><span style="display:flex;"><span>			errData <span style="color:#ff6ac1">&lt;-</span> row
</span></span><span style="display:flex;"><span>			buff <span style="color:#ff6ac1">&lt;-</span> errMsg
</span></span><span style="display:flex;"><span>			wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> row[common.EStuGender] <span style="color:#ff6ac1">!=</span> <span style="color:#5af78e">&#34;男&#34;</span> <span style="color:#ff6ac1">&amp;&amp;</span> row[common.EStuGender] <span style="color:#ff6ac1">!=</span> <span style="color:#5af78e">&#34;女&#34;</span> {
</span></span><span style="display:flex;"><span>		errMsg[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>		errMsg[<span style="color:#5af78e">&#34;reason&#34;</span>] = <span style="color:#5af78e">&#34;性别格式错误&#34;</span>
</span></span><span style="display:flex;"><span>		errData <span style="color:#ff6ac1">&lt;-</span> row
</span></span><span style="display:flex;"><span>		buff <span style="color:#ff6ac1">&lt;-</span> errMsg
</span></span><span style="display:flex;"><span>		wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// 比对学院代码是否正确
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	org <span style="color:#ff6ac1">:=</span> common.Organization{}
</span></span><span style="display:flex;"><span>	err <span style="color:#ff6ac1">:=</span> org.<span style="color:#57c7ff">GetOrgByCode</span>(row[common.EStuCollegeCode])
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>		msg <span style="color:#ff6ac1">:=</span> fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;查询目标学院代码错误:%v&#34;</span>, err)
</span></span><span style="display:flex;"><span>		logger.<span style="color:#57c7ff">Error</span>(msg)
</span></span><span style="display:flex;"><span>		errMsg[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>		errMsg[<span style="color:#5af78e">&#34;reason&#34;</span>] = msg
</span></span><span style="display:flex;"><span>		errData <span style="color:#ff6ac1">&lt;-</span> row
</span></span><span style="display:flex;"><span>		buff <span style="color:#ff6ac1">&lt;-</span> errMsg
</span></span><span style="display:flex;"><span>		wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> errors.<span style="color:#57c7ff">Is</span>(err, sql.ErrNoRows) <span style="color:#ff6ac1">||</span> org.Name <span style="color:#ff6ac1">!=</span> row[common.EStuCollege] {
</span></span><span style="display:flex;"><span>		<span style="color:#ff5c57">var</span> msg <span style="color:#9aedfe">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">if</span> org.Code <span style="color:#ff6ac1">!=</span> <span style="color:#5af78e">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>			msg = fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;同一个学院出现不同的学院代码：正确：【%v,%v】，错误：【%v,%v】&#34;</span>, org.Code, org.Name, row[common.EStuCollegeCode], row[common.EStuCollege])
</span></span><span style="display:flex;"><span>		} <span style="color:#ff6ac1">else</span> {
</span></span><span style="display:flex;"><span>			msg = fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;不存在代码为：%v的学院&#34;</span>, row[common.EStuCollegeCode])
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		logger.<span style="color:#57c7ff">Error</span>(msg)
</span></span><span style="display:flex;"><span>		errMsg[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>		errMsg[<span style="color:#5af78e">&#34;reason&#34;</span>] = msg
</span></span><span style="display:flex;"><span>		errData <span style="color:#ff6ac1">&lt;-</span> row
</span></span><span style="display:flex;"><span>		buff <span style="color:#ff6ac1">&lt;-</span> errMsg
</span></span><span style="display:flex;"><span>		wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ab <span style="color:#ff6ac1">:=</span> common.AddrBook{}
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// 通过同步系统数据库查看企业微信中是否有对应的学院部门
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	collegeDep, err <span style="color:#ff6ac1">:=</span> ab.<span style="color:#57c7ff">GetDepByDbID</span>(row[common.EStuCollegeCode], row[common.EStuLevel])
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> <span style="color:#ff6ac1">&amp;&amp;</span> !errors.<span style="color:#57c7ff">Is</span>(err, sql.ErrNoRows) {
</span></span><span style="display:flex;"><span>		msg <span style="color:#ff6ac1">:=</span> fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;查询同步系统库失败:%s&#34;</span>, err.<span style="color:#57c7ff">Error</span>())
</span></span><span style="display:flex;"><span>		logger.<span style="color:#57c7ff">Error</span>(msg)
</span></span><span style="display:flex;"><span>		errMsg[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>		errMsg[<span style="color:#5af78e">&#34;reason&#34;</span>] = msg
</span></span><span style="display:flex;"><span>		errData <span style="color:#ff6ac1">&lt;-</span> row
</span></span><span style="display:flex;"><span>		buff <span style="color:#ff6ac1">&lt;-</span> errMsg
</span></span><span style="display:flex;"><span>		wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// 如果对应学院部门不存在
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff6ac1">if</span> errors.<span style="color:#57c7ff">Is</span>(err, sql.ErrNoRows) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		parentDepid, _ <span style="color:#ff6ac1">:=</span> strconv.<span style="color:#57c7ff">Atoi</span>(pid[row[common.EStuLevel]])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		depid, err <span style="color:#ff6ac1">:=</span> ab.<span style="color:#57c7ff">GetAndUpdateConf</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#78787e">// TODO 数据库异常概率小，故直接返回500
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>			logger.<span style="color:#57c7ff">Error</span>(err.<span style="color:#57c7ff">Error</span>())
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;reason&#34;</span>] = err.<span style="color:#57c7ff">Error</span>()
</span></span><span style="display:flex;"><span>			errData <span style="color:#ff6ac1">&lt;-</span> row
</span></span><span style="display:flex;"><span>			buff <span style="color:#ff6ac1">&lt;-</span> errMsg
</span></span><span style="display:flex;"><span>			wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#78787e">// TODO 在企业微信中新建学院部门
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>		err = Wxapi.<span style="color:#57c7ff">CreateDept</span>(row[common.EStuCollege], <span style="color:#ff5c57">int64</span>(parentDepid), depid, depid)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>			logger.<span style="color:#57c7ff">Error</span>(fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;新建学院部门失败: %s,错误数据为:[%s],&#34;</span>, err.<span style="color:#57c7ff">Error</span>(), strings.<span style="color:#57c7ff">Join</span>(row, <span style="color:#5af78e">&#34;,&#34;</span>)))
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;reason&#34;</span>] = err.<span style="color:#57c7ff">Error</span>()
</span></span><span style="display:flex;"><span>			errData <span style="color:#ff6ac1">&lt;-</span> row
</span></span><span style="display:flex;"><span>			buff <span style="color:#ff6ac1">&lt;-</span> errMsg
</span></span><span style="display:flex;"><span>			wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		collegeDep.WxName = row[common.EStuCollege]
</span></span><span style="display:flex;"><span>		collegeDep.WxParentID = pid[row[common.EStuLevel]]
</span></span><span style="display:flex;"><span>		collegeDep.WxCollegeID = <span style="color:#5af78e">&#34;None&#34;</span>
</span></span><span style="display:flex;"><span>		collegeDep.DbID = row[common.EStuCollegeCode]
</span></span><span style="display:flex;"><span>		collegeDep.Grade = <span style="color:#5af78e">&#34;None&#34;</span>
</span></span><span style="display:flex;"><span>		collegeDep.WxGrade = <span style="color:#5af78e">&#34;None&#34;</span>
</span></span><span style="display:flex;"><span>		collegeDep.Level = <span style="color:#ff9f43">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#78787e">// TODO 将部门信息写入数据库
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>		err = ab.<span style="color:#57c7ff">NewDep</span>(<span style="color:#ff6ac1">&amp;</span>collegeDep, row[common.EStuLevel], depid)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>			msg <span style="color:#ff6ac1">:=</span> fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;将部门信息写入数据库失败: %s,&#34;</span>, err.<span style="color:#57c7ff">Error</span>())
</span></span><span style="display:flex;"><span>			logger.<span style="color:#57c7ff">Error</span>(msg)
</span></span><span style="display:flex;"><span>			<span style="color:#78787e">// TODO 删除创建的部门
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>			err <span style="color:#ff6ac1">:=</span> Wxapi.<span style="color:#57c7ff">DelDept</span>(depid)
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>				logger.<span style="color:#57c7ff">Error</span>(fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;删除部门失败：%s&#34;</span>, err.<span style="color:#57c7ff">Error</span>()))
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;reason&#34;</span>] = msg
</span></span><span style="display:flex;"><span>			errData <span style="color:#ff6ac1">&lt;-</span> row
</span></span><span style="display:flex;"><span>			buff <span style="color:#ff6ac1">&lt;-</span> errMsg
</span></span><span style="display:flex;"><span>			wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// 通过同步系统数据库查看企业微信中是否有对应的年级部门
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	gradeDep, err <span style="color:#ff6ac1">:=</span> ab.<span style="color:#57c7ff">GetDepByParentIdAndName</span>(collegeDep.WxID, row[common.EStuGrade], row[common.EStuLevel])
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> <span style="color:#ff6ac1">&amp;&amp;</span> !errors.<span style="color:#57c7ff">Is</span>(err, sql.ErrNoRows) {
</span></span><span style="display:flex;"><span>		msg <span style="color:#ff6ac1">:=</span> fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;查询同步数据库失败: %s&#34;</span>, err.<span style="color:#57c7ff">Error</span>())
</span></span><span style="display:flex;"><span>		logger.<span style="color:#57c7ff">Error</span>(msg)
</span></span><span style="display:flex;"><span>		errMsg[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>		errMsg[<span style="color:#5af78e">&#34;reason&#34;</span>] = msg
</span></span><span style="display:flex;"><span>		errData <span style="color:#ff6ac1">&lt;-</span> row
</span></span><span style="display:flex;"><span>		buff <span style="color:#ff6ac1">&lt;-</span> errMsg
</span></span><span style="display:flex;"><span>		wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// 如果年级部门不存在
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff6ac1">if</span> errors.<span style="color:#57c7ff">Is</span>(err, sql.ErrNoRows) {
</span></span><span style="display:flex;"><span>		parentId, _ <span style="color:#ff6ac1">:=</span> strconv.<span style="color:#57c7ff">Atoi</span>(collegeDep.WxID)
</span></span><span style="display:flex;"><span>		depid, err <span style="color:#ff6ac1">:=</span> ab.<span style="color:#57c7ff">GetAndUpdateConf</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#78787e">// TODO 数据库异常概率小，故直接返回500
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>			logger.<span style="color:#57c7ff">Error</span>(fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;查询同步数据库失败:%s&#34;</span>, err.<span style="color:#57c7ff">Error</span>()))
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;reason&#34;</span>] = err.<span style="color:#57c7ff">Error</span>()
</span></span><span style="display:flex;"><span>			errData <span style="color:#ff6ac1">&lt;-</span> row
</span></span><span style="display:flex;"><span>			buff <span style="color:#ff6ac1">&lt;-</span> errMsg
</span></span><span style="display:flex;"><span>			wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#78787e">// TODO 在企业微信中新建年级部门
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>		err = Wxapi.<span style="color:#57c7ff">CreateDept</span>(row[common.EStuGrade], <span style="color:#ff5c57">int64</span>(parentId), depid, depid)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>			logger.<span style="color:#57c7ff">Error</span>(fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;新建年级部门失败: %s&#34;</span>, err.<span style="color:#57c7ff">Error</span>()))
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;reason&#34;</span>] = err.<span style="color:#57c7ff">Error</span>()
</span></span><span style="display:flex;"><span>			errData <span style="color:#ff6ac1">&lt;-</span> row
</span></span><span style="display:flex;"><span>			buff <span style="color:#ff6ac1">&lt;-</span> errMsg
</span></span><span style="display:flex;"><span>			wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		gradeDep.WxName = row[common.EStuGrade]
</span></span><span style="display:flex;"><span>		gradeDep.WxParentID = collegeDep.WxID
</span></span><span style="display:flex;"><span>		gradeDep.WxCollegeID = collegeDep.WxID
</span></span><span style="display:flex;"><span>		gradeDep.DbID = <span style="color:#5af78e">&#34;None&#34;</span>
</span></span><span style="display:flex;"><span>		gradeDep.Grade = <span style="color:#5af78e">&#34;None&#34;</span>
</span></span><span style="display:flex;"><span>		gradeDep.WxGrade = <span style="color:#5af78e">&#34;None&#34;</span>
</span></span><span style="display:flex;"><span>		gradeDep.Level = collegeDep.Level <span style="color:#ff6ac1">+</span> <span style="color:#ff9f43">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#78787e">// TODO 将部门信息写入数据库
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>		err = ab.<span style="color:#57c7ff">NewDep</span>(<span style="color:#ff6ac1">&amp;</span>gradeDep, row[common.EStuLevel], depid)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>			msg <span style="color:#ff6ac1">:=</span> fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;将部门信息写入数据库失败: %s,&#34;</span>, err.<span style="color:#57c7ff">Error</span>())
</span></span><span style="display:flex;"><span>			logger.<span style="color:#57c7ff">Error</span>(msg)
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;reason&#34;</span>] = msg
</span></span><span style="display:flex;"><span>			errData <span style="color:#ff6ac1">&lt;-</span> row
</span></span><span style="display:flex;"><span>			buff <span style="color:#ff6ac1">&lt;-</span> errMsg
</span></span><span style="display:flex;"><span>			wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// 先查询是否有该新生数据
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	bts <span style="color:#ff6ac1">:=</span> common.TStudent{}
</span></span><span style="display:flex;"><span>	err1 <span style="color:#ff6ac1">:=</span> bts.<span style="color:#57c7ff">QueryStudentByIdCard</span>(row[common.EStuIdCard])
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> err1 <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> <span style="color:#ff6ac1">&amp;&amp;</span> !errors.<span style="color:#57c7ff">Is</span>(err1, gorm.ErrRecordNotFound) {
</span></span><span style="display:flex;"><span>		msg <span style="color:#ff6ac1">:=</span> fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;查询学生信息错误:%s&#34;</span>, err)
</span></span><span style="display:flex;"><span>		logger.<span style="color:#57c7ff">Error</span>(msg)
</span></span><span style="display:flex;"><span>		errMsg[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>		errMsg[<span style="color:#5af78e">&#34;reason&#34;</span>] = msg
</span></span><span style="display:flex;"><span>		errData <span style="color:#ff6ac1">&lt;-</span> row
</span></span><span style="display:flex;"><span>		buff <span style="color:#ff6ac1">&lt;-</span> errMsg
</span></span><span style="display:flex;"><span>		wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// 录入新生数据
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	ts <span style="color:#ff6ac1">:=</span> common.TStudent{
</span></span><span style="display:flex;"><span>		Name:        row[common.EStuName],
</span></span><span style="display:flex;"><span>		IdCard:      row[common.EStuIdCard],
</span></span><span style="display:flex;"><span>		StuId:       row[common.EStuStuId],
</span></span><span style="display:flex;"><span>		Gender:      WxGender[row[common.EStuGender]],
</span></span><span style="display:flex;"><span>		Birthday:    row[common.EStuBirth],
</span></span><span style="display:flex;"><span>		College:     row[common.EStuCollege],
</span></span><span style="display:flex;"><span>		CollegeCode: row[common.EStuCollegeCode],
</span></span><span style="display:flex;"><span>		Grade:       row[common.EStuGrade],
</span></span><span style="display:flex;"><span>		Level:       row[common.EStuLevel],
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	curUser <span style="color:#ff6ac1">:=</span> <span style="color:#ff5c57">make</span>(<span style="color:#ff5c57">map</span>[<span style="color:#9aedfe">string</span>]<span style="color:#9aedfe">string</span>, <span style="color:#ff9f43">0</span>)
</span></span><span style="display:flex;"><span>	curUser[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>	curUser[<span style="color:#5af78e">&#34;idcard&#34;</span>] = row[common.EStuIdCard]
</span></span><span style="display:flex;"><span>	curUser[<span style="color:#5af78e">&#34;stu_id&#34;</span>] = row[common.EStuStuId]
</span></span><span style="display:flex;"><span>	curUser[<span style="color:#5af78e">&#34;gender&#34;</span>] = WxGender[row[common.EStuGender]]
</span></span><span style="display:flex;"><span>	curUser[<span style="color:#5af78e">&#34;birth&#34;</span>] = row[common.EStuBirth]
</span></span><span style="display:flex;"><span>	curUser[<span style="color:#5af78e">&#34;college&#34;</span>] = row[common.EStuCollege]
</span></span><span style="display:flex;"><span>	curUser[<span style="color:#5af78e">&#34;college_code&#34;</span>] = row[common.EStuCollegeCode]
</span></span><span style="display:flex;"><span>	curUser[<span style="color:#5af78e">&#34;grade&#34;</span>] = row[common.EStuGrade]
</span></span><span style="display:flex;"><span>	curUser[<span style="color:#5af78e">&#34;level&#34;</span>] = row[common.EStuLevel]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	exist <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// 如果已有信息
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff6ac1">if</span> err1 <span style="color:#ff6ac1">==</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">if</span> bts.Status <span style="color:#ff6ac1">==</span> <span style="color:#5af78e">&#34;已核验&#34;</span> {
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;reason&#34;</span>] = <span style="color:#5af78e">&#34;success&#34;</span>
</span></span><span style="display:flex;"><span>			buff <span style="color:#ff6ac1">&lt;-</span> errMsg
</span></span><span style="display:flex;"><span>			wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		err <span style="color:#ff6ac1">:=</span> ts.<span style="color:#57c7ff">UpdateStudentByIdCard</span>(ts.IdCard)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>			msg <span style="color:#ff6ac1">:=</span> fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;修改学生信息失败:%s,错误数据:[%s]&#34;</span>, err, strings.<span style="color:#57c7ff">Join</span>(row, <span style="color:#5af78e">&#34;,&#34;</span>))
</span></span><span style="display:flex;"><span>			logger.<span style="color:#57c7ff">Error</span>(msg)
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;reason&#34;</span>] = msg
</span></span><span style="display:flex;"><span>			errData <span style="color:#ff6ac1">&lt;-</span> row
</span></span><span style="display:flex;"><span>			buff <span style="color:#ff6ac1">&lt;-</span> errMsg
</span></span><span style="display:flex;"><span>			wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		exist = <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//TODO 判断中间库中是否有该研究生的信息（要从中间库中本科生，研究生，教职工表中查询）
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff6ac1">if</span> row[common.EStuLevel] <span style="color:#ff6ac1">!=</span> <span style="color:#5af78e">&#34;本科生&#34;</span> {
</span></span><span style="display:flex;"><span>		pgStu <span style="color:#ff6ac1">:=</span> common.PGStudent{}
</span></span><span style="display:flex;"><span>		originPosition, err2 <span style="color:#ff6ac1">:=</span> pgStu.<span style="color:#57c7ff">GetStudentByIdCard</span>(row[common.EStuIdCard])
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">if</span> err2 <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> <span style="color:#ff6ac1">&amp;&amp;</span> !errors.<span style="color:#57c7ff">Is</span>(err2, sql.ErrNoRows) {
</span></span><span style="display:flex;"><span>			logger.<span style="color:#57c7ff">Error</span>(fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;中间库操作错误：%s&#34;</span>, err2))
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;reason&#34;</span>] = err2.<span style="color:#57c7ff">Error</span>()
</span></span><span style="display:flex;"><span>			errData <span style="color:#ff6ac1">&lt;-</span> row
</span></span><span style="display:flex;"><span>			buff <span style="color:#ff6ac1">&lt;-</span> errMsg
</span></span><span style="display:flex;"><span>			wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#78787e">// TODO 如果该研究生信息在中间库中存在
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>		<span style="color:#ff6ac1">if</span> err2 <span style="color:#ff6ac1">==</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>			user, err3 <span style="color:#ff6ac1">:=</span> Wxapi.<span style="color:#57c7ff">GetUser</span>(pgStu.StuID)
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">if</span> err3 <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>				msg <span style="color:#ff6ac1">:=</span> fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;在企业微信中获取研究生:%s 的信息失败,ERROR:%s&#34;</span>, pgStu.Name, err3.<span style="color:#57c7ff">Error</span>())
</span></span><span style="display:flex;"><span>				logger.<span style="color:#57c7ff">Error</span>(msg)
</span></span><span style="display:flex;"><span>				errMsg[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>				errMsg[<span style="color:#5af78e">&#34;reason&#34;</span>] = msg
</span></span><span style="display:flex;"><span>				errData <span style="color:#ff6ac1">&lt;-</span> row
</span></span><span style="display:flex;"><span>				buff <span style="color:#ff6ac1">&lt;-</span> errMsg
</span></span><span style="display:flex;"><span>				wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>				<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#ff5c57">var</span> depid []<span style="color:#9aedfe">int64</span>
</span></span><span style="display:flex;"><span>			d, _ <span style="color:#ff6ac1">:=</span> strconv.<span style="color:#57c7ff">Atoi</span>(gradeDep.WxID)
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">for</span> _, val <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">range</span> user.Departments {
</span></span><span style="display:flex;"><span>				<span style="color:#ff6ac1">if</span> val.DeptID <span style="color:#ff6ac1">!=</span> <span style="color:#ff5c57">int64</span>(d) {
</span></span><span style="display:flex;"><span>					depid = <span style="color:#ff5c57">append</span>(depid, val.DeptID)
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#78787e">// TODO 给企业微信中存在数据的研究生添加新部门
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>			depid = <span style="color:#ff5c57">append</span>(depid, <span style="color:#ff5c57">int64</span>(d))
</span></span><span style="display:flex;"><span>			extattr <span style="color:#ff6ac1">:=</span> user.Extattr
</span></span><span style="display:flex;"><span>			err4 <span style="color:#ff6ac1">:=</span> Wxapi.<span style="color:#57c7ff">UpdateUser</span>(pgStu.StuID, pgStu.Name, depid, WxGender[row[common.EStuGender]], extattr)
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">if</span> err4 <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>				msg <span style="color:#ff6ac1">:=</span> fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;更新已有研究生部门失败:%s&#34;</span>, err4.<span style="color:#57c7ff">Error</span>())
</span></span><span style="display:flex;"><span>				logger.<span style="color:#57c7ff">Error</span>(msg)
</span></span><span style="display:flex;"><span>				errMsg[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>				errMsg[<span style="color:#5af78e">&#34;reason&#34;</span>] = msg
</span></span><span style="display:flex;"><span>				errData <span style="color:#ff6ac1">&lt;-</span> row
</span></span><span style="display:flex;"><span>				buff <span style="color:#ff6ac1">&lt;-</span> errMsg
</span></span><span style="display:flex;"><span>				wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>				<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			ts.Status = <span style="color:#5af78e">&#34;已核验&#34;</span>
</span></span><span style="display:flex;"><span>			ts.InMidDb = <span style="color:#5af78e">&#34;y&#34;</span> <span style="color:#78787e">//记录该成员信息在中间库中存在
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>			ts.OriginalPosition = originPosition
</span></span><span style="display:flex;"><span>			curUser[<span style="color:#5af78e">&#34;status&#34;</span>] = <span style="color:#5af78e">&#34;已核验&#34;</span>
</span></span><span style="display:flex;"><span>			curUser[<span style="color:#5af78e">&#34;in_middb&#34;</span>] = <span style="color:#5af78e">&#34;y&#34;</span>
</span></span><span style="display:flex;"><span>			curUser[<span style="color:#5af78e">&#34;originPosition&#34;</span>] = originPosition
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// 获取标签列表
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	taglist, err <span style="color:#ff6ac1">:=</span> Wxapi.<span style="color:#57c7ff">GetTagList</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#57c7ff">Error</span>(fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;获取企业微信标签列表失败:%s&#34;</span>, err.<span style="color:#57c7ff">Error</span>()))
</span></span><span style="display:flex;"><span>		errMsg[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>		errMsg[<span style="color:#5af78e">&#34;reason&#34;</span>] = err.<span style="color:#57c7ff">Error</span>()
</span></span><span style="display:flex;"><span>		errData <span style="color:#ff6ac1">&lt;-</span> row
</span></span><span style="display:flex;"><span>		buff <span style="color:#ff6ac1">&lt;-</span> errMsg
</span></span><span style="display:flex;"><span>		wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	flag <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">false</span> <span style="color:#78787e">// 判断标签是否存在
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	tmp <span style="color:#ff6ac1">:=</span> strings.<span style="color:#57c7ff">Replace</span>(row[common.EStuGrade], <span style="color:#5af78e">&#34;级&#34;</span>, <span style="color:#5af78e">&#34;&#34;</span>, <span style="color:#ff6ac1">-</span><span style="color:#ff9f43">1</span>)
</span></span><span style="display:flex;"><span>	tmp = fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;%s/所有学院%s级部门&#34;</span>, row[common.EStuLevel], tmp)
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> _, values <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">range</span> taglist.TagList {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">if</span> values.TagName <span style="color:#ff6ac1">==</span> tmp {
</span></span><span style="display:flex;"><span>			flag = <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">break</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	tagId <span style="color:#ff6ac1">:=</span> <span style="color:#ff5c57">int64</span>(<span style="color:#ff6ac1">-</span><span style="color:#ff9f43">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// 标签不存在
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff6ac1">if</span> !flag {
</span></span><span style="display:flex;"><span>		<span style="color:#ff5c57">var</span> err <span style="color:#9aedfe">error</span>
</span></span><span style="display:flex;"><span>		tagId, err = Wxapi.<span style="color:#57c7ff">CreateTag</span>(tmp)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>			msg <span style="color:#ff6ac1">:=</span> fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;创建标签失败：%s,ERR: %s&#34;</span>, tmp, err.<span style="color:#57c7ff">Error</span>())
</span></span><span style="display:flex;"><span>			logger.<span style="color:#57c7ff">Error</span>(msg)
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;reason&#34;</span>] = msg
</span></span><span style="display:flex;"><span>			errData <span style="color:#ff6ac1">&lt;-</span> row
</span></span><span style="display:flex;"><span>			buff <span style="color:#ff6ac1">&lt;-</span> errMsg
</span></span><span style="display:flex;"><span>			wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// 将对应年级部门加入到标签
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff6ac1">if</span> tagId <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">-</span><span style="color:#ff9f43">1</span> {
</span></span><span style="display:flex;"><span>		curDepid, _ <span style="color:#ff6ac1">:=</span> strconv.<span style="color:#57c7ff">Atoi</span>(gradeDep.WxID)
</span></span><span style="display:flex;"><span>		err <span style="color:#ff6ac1">:=</span> Wxapi.<span style="color:#57c7ff">AddTagUserOrDep</span>(tagId, []<span style="color:#9aedfe">string</span>{}, []<span style="color:#9aedfe">int64</span>{<span style="color:#ff5c57">int64</span>(curDepid)})
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>			msg <span style="color:#ff6ac1">:=</span> fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;为部门%v添加标签：[%v]失败，ERR: %s&#34;</span>, gradeDep.WxID, tmp, err.<span style="color:#57c7ff">Error</span>())
</span></span><span style="display:flex;"><span>			logger.<span style="color:#57c7ff">Error</span>(msg)
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>			errMsg[<span style="color:#5af78e">&#34;reason&#34;</span>] = msg
</span></span><span style="display:flex;"><span>			errData <span style="color:#ff6ac1">&lt;-</span> row
</span></span><span style="display:flex;"><span>			buff <span style="color:#ff6ac1">&lt;-</span> errMsg
</span></span><span style="display:flex;"><span>			wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	errMsg[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>	errMsg[<span style="color:#5af78e">&#34;reason&#34;</span>] = <span style="color:#5af78e">&#34;success&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> !exist {
</span></span><span style="display:flex;"><span>		userList <span style="color:#ff6ac1">&lt;-</span> curUser
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	buff <span style="color:#ff6ac1">&lt;-</span> errMsg
</span></span><span style="display:flex;"><span>	wg.<span style="color:#57c7ff">Done</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">func</span> (st <span style="color:#ff6ac1">*</span>StuHandle) <span style="color:#57c7ff">ImportStuData</span>(context <span style="color:#ff6ac1">*</span>gin.Context) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">var</span> resp = gin.H{
</span></span><span style="display:flex;"><span>		<span style="color:#5af78e">&#34;status&#34;</span>:       <span style="color:#ff9f43">200</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#5af78e">&#34;msg&#34;</span>:          <span style="color:#5af78e">&#34;操作成功&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#5af78e">&#34;err_data_url&#34;</span>: <span style="color:#5af78e">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">var</span> form StuData
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">:=</span> context.<span style="color:#57c7ff">ShouldBind</span>(<span style="color:#ff6ac1">&amp;</span>form); err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#57c7ff">Error</span>(err.<span style="color:#57c7ff">Error</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#57c7ff">Response</span>(context, http.StatusBadRequest, <span style="color:#5af78e">&#34;请求不合法&#34;</span>, resp)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	tmpFile <span style="color:#ff6ac1">:=</span> <span style="color:#5af78e">`./fileTmp/test.xlsx`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> _, err <span style="color:#ff6ac1">:=</span> os.<span style="color:#57c7ff">Stat</span>(tmpFile); os.<span style="color:#57c7ff">IsNotExist</span>(err) {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#57c7ff">Info</span>(<span style="color:#5af78e">&#34;文件不存在&#34;</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#ff6ac1">else</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#57c7ff">Info</span>(<span style="color:#5af78e">&#34;文件存在&#34;</span>)
</span></span><span style="display:flex;"><span>		err <span style="color:#ff6ac1">:=</span> os.<span style="color:#57c7ff">Remove</span>(tmpFile)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>			msg <span style="color:#ff6ac1">:=</span> fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;删除文件失败: %s&#34;</span>, err)
</span></span><span style="display:flex;"><span>			logger.<span style="color:#57c7ff">Error</span>(msg)
</span></span><span style="display:flex;"><span>			<span style="color:#57c7ff">Response</span>(context, http.StatusInternalServerError, <span style="color:#5af78e">&#34;操作失败，请稍后再试&#34;</span>, resp)
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// 接收并处理上传的excel表格
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	err <span style="color:#ff6ac1">:=</span> context.<span style="color:#57c7ff">SaveUploadedFile</span>(form.File, tmpFile)
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>		msg <span style="color:#ff6ac1">:=</span> fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;保存上传文件失败: %s&#34;</span>, err)
</span></span><span style="display:flex;"><span>		logger.<span style="color:#57c7ff">Error</span>(msg)
</span></span><span style="display:flex;"><span>		<span style="color:#57c7ff">Response</span>(context, http.StatusInternalServerError, <span style="color:#5af78e">&#34;操作失败，请稍后再试&#34;</span>, resp)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	f, err <span style="color:#ff6ac1">:=</span> excelize.<span style="color:#57c7ff">OpenFile</span>(tmpFile)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>		msg <span style="color:#ff6ac1">:=</span> fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;打开文件失败:%s&#34;</span>, err)
</span></span><span style="display:flex;"><span>		logger.<span style="color:#57c7ff">Error</span>(msg)
</span></span><span style="display:flex;"><span>		<span style="color:#57c7ff">Response</span>(context, http.StatusInternalServerError, <span style="color:#5af78e">&#34;操作失败，请稍后再试&#34;</span>, resp)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// 关闭文件
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff6ac1">defer</span> <span style="color:#ff5c57">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">:=</span> f.<span style="color:#57c7ff">Close</span>(); err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>			msg <span style="color:#ff6ac1">:=</span> fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;关闭文件失败:%s&#34;</span>, err)
</span></span><span style="display:flex;"><span>			logger.<span style="color:#57c7ff">Error</span>(msg)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	rows, err <span style="color:#ff6ac1">:=</span> f.<span style="color:#57c7ff">GetRows</span>(<span style="color:#5af78e">&#34;Sheet1&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>		msg <span style="color:#ff6ac1">:=</span> fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;读取Excel文件失败: %s&#34;</span>, err.<span style="color:#57c7ff">Error</span>())
</span></span><span style="display:flex;"><span>		logger.<span style="color:#57c7ff">Error</span>(msg)
</span></span><span style="display:flex;"><span>		<span style="color:#57c7ff">Response</span>(context, http.StatusAccepted, <span style="color:#5af78e">&#34;解析Excel数据错误，请确保提交正确的Excel数据&#34;</span>, resp)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> <span style="color:#ff5c57">len</span>(rows) <span style="color:#ff6ac1">==</span> <span style="color:#ff9f43">0</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#57c7ff">Error</span>(<span style="color:#5af78e">&#34;不能提交空文件&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#57c7ff">Response</span>(context, http.StatusAccepted, <span style="color:#5af78e">&#34;不能提交空文件&#34;</span>, resp)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	row <span style="color:#ff6ac1">:=</span> rows[<span style="color:#ff9f43">0</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> <span style="color:#ff5c57">len</span>(row) <span style="color:#ff6ac1">!=</span> <span style="color:#ff9f43">9</span> <span style="color:#ff6ac1">||</span> row[common.EStuName] <span style="color:#ff6ac1">!=</span> <span style="color:#5af78e">&#34;姓名&#34;</span> <span style="color:#ff6ac1">||</span> row[common.EStuIdCard] <span style="color:#ff6ac1">!=</span> <span style="color:#5af78e">&#34;身份证号&#34;</span> <span style="color:#ff6ac1">||</span> row[common.EStuStuId] <span style="color:#ff6ac1">!=</span>
</span></span><span style="display:flex;"><span>		<span style="color:#5af78e">&#34;学号&#34;</span> <span style="color:#ff6ac1">||</span> row[common.EStuGender] <span style="color:#ff6ac1">!=</span> <span style="color:#5af78e">&#34;性别&#34;</span> <span style="color:#ff6ac1">||</span> row[common.EStuBirth] <span style="color:#ff6ac1">!=</span> <span style="color:#5af78e">&#34;出生日期&#34;</span> <span style="color:#ff6ac1">||</span> row[common.EStuCollege] <span style="color:#ff6ac1">!=</span> <span style="color:#5af78e">&#34;学院名称&#34;</span> <span style="color:#ff6ac1">||</span> row[common.EStuCollegeCode] <span style="color:#ff6ac1">!=</span> <span style="color:#5af78e">&#34;学院代码&#34;</span> <span style="color:#ff6ac1">||</span>
</span></span><span style="display:flex;"><span>		row[common.EStuGrade] <span style="color:#ff6ac1">!=</span> <span style="color:#5af78e">&#34;年级&#34;</span> <span style="color:#ff6ac1">||</span> row[common.EStuLevel] <span style="color:#ff6ac1">!=</span> <span style="color:#5af78e">&#34;层次&#34;</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#57c7ff">Error</span>(<span style="color:#5af78e">&#34;Excel格式不符合模板要求&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#57c7ff">Response</span>(context, http.StatusBadRequest, <span style="color:#5af78e">&#34;Excel格式不符合模板要求&#34;</span>, resp)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">var</span> wg sync.WaitGroup
</span></span><span style="display:flex;"><span>	wg.<span style="color:#57c7ff">Add</span>(<span style="color:#ff5c57">len</span>(rows) <span style="color:#ff6ac1">-</span> <span style="color:#ff9f43">1</span>)
</span></span><span style="display:flex;"><span>	buff <span style="color:#ff6ac1">:=</span> <span style="color:#ff5c57">make</span>(<span style="color:#ff5c57">chan</span> <span style="color:#ff5c57">map</span>[<span style="color:#9aedfe">string</span>]<span style="color:#9aedfe">string</span>, <span style="color:#ff5c57">len</span>(rows)<span style="color:#ff6ac1">-</span><span style="color:#ff9f43">1</span>) <span style="color:#78787e">//建立缓冲区，记录不能导入的数据对应的姓名
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	_failInfo <span style="color:#ff6ac1">:=</span> <span style="color:#ff5c57">make</span>([]<span style="color:#ff5c57">map</span>[<span style="color:#9aedfe">string</span>]<span style="color:#9aedfe">string</span>, <span style="color:#ff9f43">0</span>)
</span></span><span style="display:flex;"><span>	userBuff <span style="color:#ff6ac1">:=</span> <span style="color:#ff5c57">make</span>(<span style="color:#ff5c57">chan</span> <span style="color:#ff5c57">map</span>[<span style="color:#9aedfe">string</span>]<span style="color:#9aedfe">string</span>, <span style="color:#ff5c57">len</span>(rows)<span style="color:#ff6ac1">-</span><span style="color:#ff9f43">1</span>)
</span></span><span style="display:flex;"><span>	errBuff <span style="color:#ff6ac1">:=</span> <span style="color:#ff5c57">make</span>(<span style="color:#ff5c57">chan</span> []<span style="color:#9aedfe">string</span>, <span style="color:#ff5c57">len</span>(rows)<span style="color:#ff6ac1">-</span><span style="color:#ff9f43">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// 多进程处理，为每条数据分配一个goroutine
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff6ac1">for</span> _, data <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">range</span> rows[<span style="color:#ff9f43">1</span>:] {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">if</span> <span style="color:#ff5c57">len</span>(data) <span style="color:#ff6ac1">!=</span> <span style="color:#ff9f43">9</span> {
</span></span><span style="display:flex;"><span>			msg <span style="color:#ff6ac1">:=</span> fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;数据不符合要求：【%v】&#34;</span>, data)
</span></span><span style="display:flex;"><span>			logger.<span style="color:#57c7ff">Error</span>(msg)
</span></span><span style="display:flex;"><span>			tmp <span style="color:#ff6ac1">:=</span> <span style="color:#ff5c57">make</span>(<span style="color:#ff5c57">map</span>[<span style="color:#9aedfe">string</span>]<span style="color:#9aedfe">string</span>, <span style="color:#ff9f43">0</span>)
</span></span><span style="display:flex;"><span>			tmp[<span style="color:#5af78e">&#34;name&#34;</span>] = row[common.EStuName]
</span></span><span style="display:flex;"><span>			tmp[<span style="color:#5af78e">&#34;reason&#34;</span>] = msg
</span></span><span style="display:flex;"><span>			errBuff <span style="color:#ff6ac1">&lt;-</span> data
</span></span><span style="display:flex;"><span>			buff <span style="color:#ff6ac1">&lt;-</span> tmp
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#78787e">// 多线程处理，为每条数据开一个线程
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>		<span style="color:#ff6ac1">go</span> <span style="color:#57c7ff">dealStuData</span>(data, buff, <span style="color:#ff6ac1">&amp;</span>wg, userBuff, errBuff)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	wg.<span style="color:#57c7ff">Wait</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">close</span>(buff)
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">close</span>(userBuff)
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">close</span>(errBuff)
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> val <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">range</span> buff {
</span></span><span style="display:flex;"><span>		_failInfo = <span style="color:#ff5c57">append</span>(_failInfo, val)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	ts <span style="color:#ff6ac1">:=</span> common.TStudent{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	userList <span style="color:#ff6ac1">:=</span> <span style="color:#ff5c57">make</span>([]common.TStudent, <span style="color:#ff9f43">0</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> val <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">range</span> userBuff {
</span></span><span style="display:flex;"><span>		t <span style="color:#ff6ac1">:=</span> common.TStudent{
</span></span><span style="display:flex;"><span>			Name:        val[<span style="color:#5af78e">&#34;name&#34;</span>],
</span></span><span style="display:flex;"><span>			IdCard:      val[<span style="color:#5af78e">&#34;idcard&#34;</span>],
</span></span><span style="display:flex;"><span>			StuId:       val[<span style="color:#5af78e">&#34;stu_id&#34;</span>],
</span></span><span style="display:flex;"><span>			Gender:      val[<span style="color:#5af78e">&#34;gender&#34;</span>],
</span></span><span style="display:flex;"><span>			Birthday:    val[<span style="color:#5af78e">&#34;birth&#34;</span>],
</span></span><span style="display:flex;"><span>			College:     val[<span style="color:#5af78e">&#34;college&#34;</span>],
</span></span><span style="display:flex;"><span>			CollegeCode: val[<span style="color:#5af78e">&#34;college_code&#34;</span>],
</span></span><span style="display:flex;"><span>			Grade:       val[<span style="color:#5af78e">&#34;grade&#34;</span>],
</span></span><span style="display:flex;"><span>			Level:       val[<span style="color:#5af78e">&#34;level&#34;</span>],
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		t.Status = val[<span style="color:#5af78e">&#34;status&#34;</span>]
</span></span><span style="display:flex;"><span>		t.InMidDb = val[<span style="color:#5af78e">&#34;in_middb&#34;</span>]
</span></span><span style="display:flex;"><span>		t.OriginalPosition = val[<span style="color:#5af78e">&#34;originPosition&#34;</span>]
</span></span><span style="display:flex;"><span>		userList = <span style="color:#ff5c57">append</span>(userList, t)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	failData <span style="color:#ff6ac1">:=</span> <span style="color:#ff5c57">make</span>([][]<span style="color:#9aedfe">string</span>, <span style="color:#ff9f43">0</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> val <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">range</span> errBuff {
</span></span><span style="display:flex;"><span>		failData = <span style="color:#ff5c57">append</span>(failData, val)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	err = ts.<span style="color:#57c7ff">CreateStudent</span>(userList)
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#57c7ff">Error</span>(err.<span style="color:#57c7ff">Error</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#57c7ff">Response</span>(context, http.StatusInternalServerError, err.<span style="color:#57c7ff">Error</span>(), resp)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	success <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">0</span>
</span></span><span style="display:flex;"><span>	fail <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">var</span> failInfo []<span style="color:#9aedfe">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> _, val <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">range</span> _failInfo {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">if</span> val[<span style="color:#5af78e">&#34;reason&#34;</span>] <span style="color:#ff6ac1">!=</span> <span style="color:#5af78e">&#34;success&#34;</span> {
</span></span><span style="display:flex;"><span>			fail<span style="color:#ff6ac1">++</span>
</span></span><span style="display:flex;"><span>			failInfo = <span style="color:#ff5c57">append</span>(failInfo, val[<span style="color:#5af78e">&#34;reason&#34;</span>])
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		success<span style="color:#ff6ac1">++</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> <span style="color:#ff5c57">len</span>(failData) <span style="color:#ff6ac1">==</span> <span style="color:#ff9f43">0</span> {
</span></span><span style="display:flex;"><span>		resp[<span style="color:#5af78e">&#34;err_data_url&#34;</span>] = <span style="color:#5af78e">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#ff6ac1">else</span> {
</span></span><span style="display:flex;"><span>		fileName, _ <span style="color:#ff6ac1">:=</span> golib.<span style="color:#57c7ff">NewErrDataFile</span>(failData, failInfo)
</span></span><span style="display:flex;"><span>		fileName = strings.<span style="color:#57c7ff">Replace</span>(fileName, <span style="color:#5af78e">&#34;.xlsx&#34;</span>, <span style="color:#5af78e">&#34;&#34;</span>, <span style="color:#ff6ac1">-</span><span style="color:#ff9f43">1</span>)
</span></span><span style="display:flex;"><span>		resp[<span style="color:#5af78e">&#34;err_data_url&#34;</span>] = fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;%v/student/err?name=%v&#34;</span>, config.HostName, fileName)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	msg <span style="color:#ff6ac1">:=</span> fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;成功导入条数:%d 导入失败条数:%d 总计条数:%d&#34;</span>, success, <span style="color:#ff5c57">len</span>(failData), <span style="color:#ff5c57">len</span>(rows)<span style="color:#ff6ac1">-</span><span style="color:#ff9f43">1</span>)
</span></span><span style="display:flex;"><span>	status <span style="color:#ff6ac1">:=</span> http.StatusOK
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> fail <span style="color:#ff6ac1">!=</span> <span style="color:#ff9f43">0</span> {
</span></span><span style="display:flex;"><span>		status = http.StatusAccepted
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#57c7ff">Response</span>(context, status, msg, resp)
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e">// 下载不能导入的信息
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span><span style="color:#ff5c57">type</span> reqErrFile <span style="color:#ff5c57">struct</span> {
</span></span><span style="display:flex;"><span>	FileName <span style="color:#9aedfe">int</span> <span style="color:#5af78e">`form:&#34;name&#34; binding:&#34;required&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> (st <span style="color:#ff6ac1">*</span>StuHandle) <span style="color:#57c7ff">StuErrFile</span>(ctx <span style="color:#ff6ac1">*</span>gin.Context) {
</span></span><span style="display:flex;"><span>	resp <span style="color:#ff6ac1">:=</span> gin.H{
</span></span><span style="display:flex;"><span>		<span style="color:#5af78e">&#34;status&#34;</span>: <span style="color:#ff9f43">200</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#5af78e">&#34;msg&#34;</span>:    <span style="color:#5af78e">&#34;操作成功&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	err <span style="color:#ff6ac1">:=</span> golib.<span style="color:#57c7ff">DelOldFile</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#57c7ff">Error</span>(fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;删除旧文件失败：%v&#34;</span>, err))
</span></span><span style="display:flex;"><span>		<span style="color:#57c7ff">Response</span>(ctx, http.StatusInternalServerError, <span style="color:#5af78e">&#34;操作失败&#34;</span>, resp)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">var</span> form reqErrFile
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">:=</span> ctx.<span style="color:#57c7ff">ShouldBind</span>(<span style="color:#ff6ac1">&amp;</span>form); err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#57c7ff">Error</span>(fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;参数错误：%v&#34;</span>, err))
</span></span><span style="display:flex;"><span>		<span style="color:#57c7ff">Response</span>(ctx, http.StatusBadRequest, <span style="color:#5af78e">&#34;操作不合法&#34;</span>, resp)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	file, err <span style="color:#ff6ac1">:=</span> ioutil.<span style="color:#57c7ff">ReadFile</span>(fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;./fileTmp/%v.xlsx&#34;</span>, form.FileName))
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> err <span style="color:#ff6ac1">!=</span> <span style="color:#ff6ac1">nil</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#57c7ff">Error</span>(fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;读取文件失败:%v&#34;</span>, err))
</span></span><span style="display:flex;"><span>		<span style="color:#57c7ff">Response</span>(ctx, http.StatusNotFound, <span style="color:#5af78e">&#34;找不到资源&#34;</span>, resp)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	ctx.<span style="color:#57c7ff">Header</span>(<span style="color:#5af78e">&#34;content-disposition&#34;</span>, <span style="color:#5af78e">`attachment; filename=`</span><span style="color:#ff6ac1">+</span>fmt.<span style="color:#57c7ff">Sprintf</span>(<span style="color:#5af78e">&#34;%v.xlsx&#34;</span>, form.FileName))
</span></span><span style="display:flex;"><span>	ctx.<span style="color:#57c7ff">Data</span>(<span style="color:#ff9f43">200</span>, <span style="color:#5af78e">&#34;application/octet-stream&#34;</span>, file)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>	d := make(map[string]int,6)
</span></span><span style="display:flex;"><span>	d[&#34;name&#34;] = 0
</span></span><span style="display:flex;"><span>	d[&#34;content&#34;] = 1
</span></span><span style="display:flex;"><span>	d[&#34;org&#34;] = 2
</span></span><span style="display:flex;"><span>	d[&#34;year&#34;] = 3
</span></span><span style="display:flex;"><span>	d[&#34;user_id&#34;] = 4
</span></span><span style="display:flex;"><span>	d[&#34;username&#34;] = 5
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>data
</span></span></code></pre></div><p><img loading="lazy" src="D:%5cTypore%5cTypora%5ca_Plan%5cgolang%e4%b8%93%e9%a2%98%5cbase.assets%5cimage-20221031095233892.png" alt="image-20221031095233892"  />
</p>
<h2 id="并发编程-runtime">并发编程-&gt;runtime<a hidden class="anchor" aria-hidden="true" href="#并发编程-runtime">#</a></h2>
<p>runtime包里面定义了一些协程管理相关的api</p>
<h3 id="runtimegosched">runtime.Gosched()<a hidden class="anchor" aria-hidden="true" href="#runtimegosched">#</a></h3>
<p>让出CPU时间片，重新等待安排任务</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">showMsg1</span>(s <span style="color:#9aedfe">string</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> i <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">0</span>; i &lt; <span style="color:#ff9f43">2</span>; i<span style="color:#ff6ac1">++</span> {
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#57c7ff">Println</span>(s)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">RunTime</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">go</span> <span style="color:#57c7ff">showMsg1</span>(<span style="color:#5af78e">&#34;java&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> i <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">0</span>; i &lt; <span style="color:#ff9f43">2</span>; i<span style="color:#ff6ac1">++</span> {
</span></span><span style="display:flex;"><span>		runtime.<span style="color:#57c7ff">Gosched</span>()
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;golang&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;end...&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>java
</span></span><span style="display:flex;"><span>java
</span></span><span style="display:flex;"><span>golang
</span></span><span style="display:flex;"><span>golang
</span></span><span style="display:flex;"><span>end<span style="color:#ff6ac1">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>如果没有第11行<span style="color:#ff5c57">，</span>可能main协程直接结束啦
</span></span><span style="display:flex;"><span>golang
</span></span><span style="display:flex;"><span>golang
</span></span><span style="display:flex;"><span>end<span style="color:#ff6ac1">...</span>
</span></span></code></pre></div><h3 id="runtimegoexit">runtime.Goexit()<a hidden class="anchor" aria-hidden="true" href="#runtimegoexit">#</a></h3>
<p>退出协程</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>runtime.Goexit()
</span></span></code></pre></div><h3 id="runtimegomaxprocs">runtime.GOMAXPROCS()<a hidden class="anchor" aria-hidden="true" href="#runtimegomaxprocs">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">showA</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> i <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">0</span>; i &lt; <span style="color:#ff9f43">15</span>; i<span style="color:#ff6ac1">++</span> {
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;A:%v\n&#34;</span>, i)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">showB</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> i <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">0</span>; i &lt; <span style="color:#ff9f43">15</span>; i<span style="color:#ff6ac1">++</span> {
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;B:%v\n&#34;</span>, i)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">RunTime</span>() {
</span></span><span style="display:flex;"><span>	cpuNum <span style="color:#ff6ac1">:=</span> runtime.<span style="color:#57c7ff">NumCPU</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//  我这是 8 核
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#ff5c57">println</span>(cpuNum)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	runtime.<span style="color:#57c7ff">GOMAXPROCS</span>(<span style="color:#ff9f43">1</span>) <span style="color:#78787e">// 如果设置为 1 ，则不会交替执行。除非有睡眠在。
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">go</span> <span style="color:#57c7ff">showA</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">go</span> <span style="color:#57c7ff">showB</span>()
</span></span><span style="display:flex;"><span>	time.<span style="color:#57c7ff">Sleep</span>(time.Second)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="并发编程-mutex互斥锁实现同步">并发编程-&gt;Mutex互斥锁实现同步<a hidden class="anchor" aria-hidden="true" href="#并发编程-mutex互斥锁实现同步">#</a></h2>
<p>除了使用 channel 实现同步之外，还可以使用Mutex互斥锁的方式实现同步。</p>
<p>Go语言提供了<code>sync</code>包和<code>channel</code>机制来解决并发机制中不同<code>goroutine</code>之间的同步和通信</p>
<h3 id="没加锁">没加锁<a hidden class="anchor" aria-hidden="true" href="#没加锁">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> Base
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">addOne</span>(i <span style="color:#9aedfe">int</span>) {
</span></span><span style="display:flex;"><span>	i<span style="color:#ff6ac1">++</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">subOne</span>(i <span style="color:#9aedfe">int</span>) {
</span></span><span style="display:flex;"><span>	i<span style="color:#ff6ac1">--</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Mutex</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">var</span> i = <span style="color:#ff9f43">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> ; i <span style="color:#ff6ac1">&lt;=</span> <span style="color:#ff9f43">1000</span>; i<span style="color:#ff6ac1">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">go</span> <span style="color:#57c7ff">addOne</span>(i)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">go</span> <span style="color:#57c7ff">subOne</span>(i)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	time.<span style="color:#57c7ff">Sleep</span>(time.Second <span style="color:#ff6ac1">*</span> <span style="color:#ff9f43">1</span>)
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;Sum:&#34;</span>, i)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Sum: <span style="color:#ff9f43">1001</span>
</span></span></code></pre></div><h3 id="加了锁">加了锁<a hidden class="anchor" aria-hidden="true" href="#加了锁">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> Base
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">var</span> mutex sync.Mutex
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">addOne</span>(i <span style="color:#9aedfe">int</span>) {
</span></span><span style="display:flex;"><span>	mutex.<span style="color:#57c7ff">Lock</span>()
</span></span><span style="display:flex;"><span>	i<span style="color:#ff6ac1">++</span>
</span></span><span style="display:flex;"><span>	mutex.<span style="color:#57c7ff">Unlock</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">subOne</span>(i <span style="color:#9aedfe">int</span>) {
</span></span><span style="display:flex;"><span>	mutex.<span style="color:#57c7ff">Lock</span>()
</span></span><span style="display:flex;"><span>	i<span style="color:#ff6ac1">--</span>
</span></span><span style="display:flex;"><span>	mutex.<span style="color:#57c7ff">Unlock</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Mutex</span>() {
</span></span><span style="display:flex;"><span>	i <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> ; i &lt; <span style="color:#ff9f43">1000</span>; i<span style="color:#ff6ac1">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">go</span> <span style="color:#57c7ff">addOne</span>(i)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">go</span> <span style="color:#57c7ff">subOne</span>(i)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	time.<span style="color:#57c7ff">Sleep</span>(time.Second <span style="color:#ff6ac1">*</span> <span style="color:#ff9f43">1</span>)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;Sum:&#34;</span>, i)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Sum: <span style="color:#ff9f43">1000</span>
</span></span></code></pre></div><h3 id="锁-locker">锁 <code>Locker</code><a hidden class="anchor" aria-hidden="true" href="#锁-locker">#</a></h3>
<p>Go语言使用<code>go</code>语句开启新的<code>goroutine</code>，由于<code>goroutine</code>非常轻量除了对其分配栈空间外，所占的空间也是微乎其微的。但当多个<code>goroutine</code>同时处理时会遇到比如同时抢占一个资源，某个<code>goroutine</code>会等待等一个<code>goroutine</code>处理完毕某才能继续执行的问题。对于这种情况，官方并不希望依靠共享内存的方式来实现进程的协同操作，而是希望通过<code>channel</code>信道的方式来处理。但在某些特殊情况下，依然需要使用到锁，为此<code>sync</code>包提供了锁。</p>
<p>当在并发情况下，多个<code>goroutine</code>同时修改某一个变量时，就会出现资源抢占，因此会导致数据不一致的问题。</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">var</span> num = <span style="color:#ff9f43">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">for</span> i <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">0</span>; i &lt; <span style="color:#ff9f43">100000</span>; i<span style="color:#ff6ac1">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">go</span> <span style="color:#ff5c57">func</span>(i <span style="color:#9aedfe">int</span>) {
</span></span><span style="display:flex;"><span>            num<span style="color:#ff6ac1">++</span>
</span></span><span style="display:flex;"><span>            fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;goroutine %d: num = %d\n&#34;</span>, i, num)
</span></span><span style="display:flex;"><span>        }(i)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    time.<span style="color:#57c7ff">Sleep</span>(time.Second)<span style="color:#78787e">//主goroutine等待1秒以确保所有工作goroutine执行完毕
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>goroutine <span style="color:#ff9f43">10018</span><span style="color:#ff6ac1">:</span> <span style="color:#9aedfe">num</span> <span style="color:#ff6ac1">=</span> <span style="color:#ff9f43">98635</span>
</span></span><span style="display:flex;"><span>goroutine <span style="color:#ff9f43">12646</span><span style="color:#ff6ac1">:</span> <span style="color:#9aedfe">num</span> <span style="color:#ff6ac1">=</span> <span style="color:#ff9f43">98635</span>
</span></span><span style="display:flex;"><span>goroutine <span style="color:#ff9f43">12844</span><span style="color:#ff6ac1">:</span> <span style="color:#9aedfe">num</span> <span style="color:#ff6ac1">=</span> <span style="color:#ff9f43">98635</span>
</span></span><span style="display:flex;"><span>goroutine <span style="color:#ff9f43">12950</span><span style="color:#ff6ac1">:</span> <span style="color:#9aedfe">num</span> <span style="color:#ff6ac1">=</span> <span style="color:#ff9f43">98635</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>上例中<code>goroutine</code>一依次从寄存器中读取<code>num</code>的值后做加法运算，然后将其结果回写到寄存器中。运行中会发现存在一个<code>goroutine</code>取出<code>num</code>的值时做加法运算时，另一个<code>goroutine</code>也取出了<code>num</code>的值。因为上一个<code>goroutine</code>运行结果还没有回写到寄存器，最终导致多个<code>goroutine</code>产生的相同的结果。</p>
<p>并发编程中同步原语-锁，为了保证多个线程或<code>goroutine</code>在访问同一块内存时不出现混乱，Go语言的<code>sync</code>包提供了常见的并发编程同步原语的控制锁。</p>
<p><code>sync</code>包围绕着<code>Locker</code>锁接口展开，<code>Locker</code>接口中提供了两个方法<code>Lock()</code>和<code>Unlock()</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">type</span> Locker <span style="color:#ff5c57">interface</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#57c7ff">Lock</span>()
</span></span><span style="display:flex;"><span>  <span style="color:#57c7ff">Unlock</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Go语言标准库<code>sync</code>中提供了两种锁分别是互斥锁<code>sync.Mutex</code>和读写互斥锁<code>sync.RWMutex</code></p>
<h3 id="互斥锁syncmutex">互斥锁<code>sync.Mutex</code><a hidden class="anchor" aria-hidden="true" href="#互斥锁syncmutex">#</a></h3>
<blockquote>
<p>sync.Mutex是一个互斥锁，可以由不同的goroutine加锁和解锁。</p>
</blockquote>
<p><code>sync.Mutex</code>是Golang标准库提供的一个互斥锁，当一个<code>goroutine</code>获得互斥锁权限后，其他请求锁的<code>goroutine</code>会阻塞在<code>Lock()</code>方法的调用上，直到调用<code>Unlock()</code>方法被释放。</p>
<p>例如：10个并发的<code>goroutine</code>打印同一个数字100，为避免重复打印，实现<code>printOnce(num int)</code>函数，使用集合<code>set</code>记录已打印过的数字。若数字已经打印过，则不再打印。</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim mutex_test.go
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> test
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">var</span> set = <span style="color:#ff5c57">make</span>(<span style="color:#ff5c57">map</span>[<span style="color:#9aedfe">int</span>]<span style="color:#9aedfe">bool</span>, <span style="color:#ff9f43">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">printOnce</span>(index <span style="color:#9aedfe">int</span>, num <span style="color:#9aedfe">int</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">if</span> _, ok <span style="color:#ff6ac1">:=</span> set[num]; !ok {
</span></span><span style="display:flex;"><span>        fmt.<span style="color:#57c7ff">Println</span>(index, num)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    set[num] = <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">TestPrint</span>(t <span style="color:#ff6ac1">*</span>testing.T) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">for</span> i <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">0</span>; i &lt; <span style="color:#ff9f43">10</span>; i<span style="color:#ff6ac1">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">go</span> <span style="color:#57c7ff">printOnce</span>(i, <span style="color:#ff9f43">100</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    time.<span style="color:#57c7ff">Sleep</span>(time.Second)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ go <span style="color:#ff5c57">test</span> -v mutex_test.go
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">===</span> RUN   TestPrint
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">9</span> <span style="color:#ff9f43">100</span>
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">3</span> <span style="color:#ff9f43">100</span>
</span></span><span style="display:flex;"><span>--- PASS: TestPrint <span style="color:#ff6ac1">(</span>1.00s<span style="color:#ff6ac1">)</span>
</span></span><span style="display:flex;"><span>PASS
</span></span><span style="display:flex;"><span>ok      command-line-arguments  1.304s
</span></span></code></pre></div><p>程序多次运行后会发现打印次数多次，因为对同一个数据结构<code>set</code>的访问发生了冲突。</p>
<p>并发访问中比如多个<code>goroutine</code>并发更新同一个资源，比如计时器、账户余额、秒杀系统、向同一个缓存中并发写入数据等等。如果没有互斥控制，很容易会出现异常，比如计时器计数不准确、用户账户可能出现透支、秒杀系统出现超卖、缓存出现数据缓存等等，后果会很严重。</p>
<p>互斥锁是并发控制的一种基本手段，是为了避免竞争而建立的一种并发控制机制。学习前首先需要弄清楚一个概念-临界区。在并发编程中，如果程序中的一部分会被并发访问或修改，为了避免并发访问导致的意想不到的结果，这部分程序需要被保护起来，这部分被保护起来的程序就叫做临界区。</p>
<p>临界区是一个被共享的资源，或者说是一个整体的共享资源，比如对数据库的访问，对某个共享数据结构的操作。对一个I/O设备的使用，对一个连接池中的连接的调用等等。</p>
<p>如果很多线程同步访问临界区就会造成访问或操作错误，这并不是我们希望看到的结果。所以，使用互斥锁，限定临界区只能同时由一个线程持有。当临界区由一个线程持有的时候，其他线程如果想进入临界区就会返回失败，或者是等待。直到持有的线程退出临界区，这些等待线程中的某一个才有机会接着持有这个临界区。</p>
<p><img loading="lazy" src="https:////upload-images.jianshu.io/upload_images/4933701-df569b90327e0eb1.png?imageMogr2/auto-orient/strip%7cimageView2/2/w/720/format/webp" alt="img"  />
</p>
<p>互斥锁</p>
<p>互斥锁可以很好的解决资源竞争的问题，因此也有人称之为排它锁。Golang标准库中使用Mutex来实现互斥锁。根据2019年分析Go并发Bug的论文Understanding Real-World Concurrency Bugs in Go中，Mutex是使用最为广泛的同步原语（Synchronization primitives， 并发原语或同步原语）。关于同步原语并没有一个严格的定义，可将其看作是解决并发问题的一个基础的数据结构。</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">type</span> Mutex <span style="color:#ff5c57">struct</span> {
</span></span><span style="display:flex;"><span>  state <span style="color:#9aedfe">int32</span> <span style="color:#78787e">//状态标识
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>  sema <span style="color:#9aedfe">uint32</span> <span style="color:#78787e">//信号量
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>}
</span></span></code></pre></div><p>Go标准库提供了<code>sync.Mutex</code>互斥锁类型以及两个方法分别是<code>Lock</code>加锁和<code>Unlock</code>释放锁。可以通过在代码前调用<code>Lock</code>方法，在代码后调用<code>Unlock</code>方法来保证一段代码的互斥执行，也可以使用<code>defer</code>语句来保证互斥锁一定会被解锁。当一个<code>goroutine</code>调用<code>Lock</code>方法获得锁后，其它请求的<code>goroutine</code>都会阻塞在<code>Lock</code>方法直到锁被释放。</p>
<p>一个互斥锁只能同时被一个<code>goroutine</code>锁定，其它<code>goroutine</code>将阻塞直到互斥锁被解锁，也就是重新争抢对互斥锁的锁定。需要注意的是，对一个未锁定的互斥锁解锁时将会产生运行时错误。</p>
<p><code>sync.Mutex</code>不区分读写锁，只有<code>Lock()</code>和<code>Lock()</code>之间才会导致阻塞的情况。若在一个地方<code>Lock()</code>，在另一个地方不<code>Lock()</code>而是直接修改或访问共享数据，对于<code>sync.Mutext</code>类型是允许的，因为<code>mutex</code>不会和<code>goroutine</code>进行关联。若要区分读锁和写锁，可使用<code>sync.RWMutex</code>类型。</p>
<p>在<code>Lock()</code>和<code>Unlock()</code>之间的代码段成为资源临界区（critical section），在这一区间内的代码是严格被<code>Lock()</code>保护的，是线程安全的，任何一个时间点都只能有一个<code>goroutine</code>执行这段区间的代码。</p>
<p>例如：使用互斥锁的<code>Lock()</code>和<code>Unlock()</code>方法将冲突包裹</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> test
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">var</span> m sync.Mutex
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">var</span> set = <span style="color:#ff5c57">make</span>(<span style="color:#ff5c57">map</span>[<span style="color:#9aedfe">int</span>]<span style="color:#9aedfe">bool</span>, <span style="color:#ff9f43">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">printOnce</span>(index <span style="color:#9aedfe">int</span>, num <span style="color:#9aedfe">int</span>) {
</span></span><span style="display:flex;"><span>    m.<span style="color:#57c7ff">Lock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">defer</span> m.<span style="color:#57c7ff">Unlock</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">if</span> _, ok <span style="color:#ff6ac1">:=</span> set[num]; !ok {
</span></span><span style="display:flex;"><span>        fmt.<span style="color:#57c7ff">Println</span>(index, num)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    set[num] = <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">TestPrint</span>(t <span style="color:#ff6ac1">*</span>testing.T) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">for</span> i <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">0</span>; i &lt; <span style="color:#ff9f43">10</span>; i<span style="color:#ff6ac1">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">go</span> <span style="color:#57c7ff">printOnce</span>(i, <span style="color:#ff9f43">100</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    time.<span style="color:#57c7ff">Sleep</span>(time.Second)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>相同的数字只会比打印一次，当一个<code>goroutine</code>调用了<code>Lock()</code>方法时，其他<code>goroutine</code>被阻塞了，直到<code>Unlock()</code>调用将锁释放。因此被包裹部分的代码就能避免冲突，实现互斥。</p>
<p>互斥即不能同时运行，使用互斥锁的两个代码片段相互排斥，只有其中一个代码片段执行完毕后，另一个才能执行。</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">var</span> num = <span style="color:#ff9f43">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">var</span> locker sync.Mutex
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">for</span> i <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">0</span>; i &lt; <span style="color:#ff9f43">100000</span>; i<span style="color:#ff6ac1">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">go</span> <span style="color:#ff5c57">func</span>(i <span style="color:#9aedfe">int</span>) {
</span></span><span style="display:flex;"><span>            locker.<span style="color:#57c7ff">Lock</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">defer</span> locker.<span style="color:#57c7ff">Unlock</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            num<span style="color:#ff6ac1">++</span>
</span></span><span style="display:flex;"><span>            fmt.<span style="color:#57c7ff">Printf</span>(<span style="color:#5af78e">&#34;goroutine %d: num = %d\n&#34;</span>, i, num)
</span></span><span style="display:flex;"><span>        }(i)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    time.<span style="color:#57c7ff">Sleep</span>(time.Second)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>从上例中可以发现，添加互斥锁后，不仅没有出现抢占资源导致的重复输出，而且输出结果顺序递增。</p>
<p>Go语言中的Mutex类型的互斥锁<code>Lock()</code>锁定与其它语言不同的是，<code>Lock()</code>锁定的是互斥锁而非一段代码。其他语言比如Java中使用同步锁锁定的是一段代码，以确保多线程并发誓只有一个线程可以控制运行此代码块直到释放同步锁。Go语言是在<code>goroutine</code>中锁定互斥锁，其它<code>goroutine</code>执行到有锁的位置时，由于获取不到互斥锁的锁定，因此会发生阻塞而等待，从而达到控制同步的目的。</p>
<h3 id="race-detector">race detector<a hidden class="anchor" aria-hidden="true" href="#race-detector">#</a></h3>
<p>Golang提供了一个检测并发访问共享资源是否存在问题的工具 - race detector，它可以帮助自动发现城中有没有data race的问题。</p>
<p>Golang的race detector是基于Google的C/C++ sanitizers技术实现的，编译器通过探测所有的内存访问，加入代码能监视对这些内存地址的访问（读或是写）。代码运行时race detector能监控对共享变量的非同步访问，出现race时就会打印出警告信息。</p>
<p><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fblog.golang.org%2Frace-detector">https://blog.golang.org/race-detector</a></p>
<h3 id="读写锁syncrwmutex">读写锁<code>sync.RWMutex</code><a hidden class="anchor" aria-hidden="true" href="#读写锁syncrwmutex">#</a></h3>
<p>在银行存取钱时，对账户余额的修改是需要加锁的，因此此时可能有人汇款到你的账户，如果对金额的修改不加锁，很可能导致最后的金额发生错误。读取账户余额也需要等待修改操作结束，才能读取到正确的余额。大部分情况下，读取余额的操作会更加频繁，如果能保证读取余额的操作能并发执行，程序的效率会很大地提升。</p>
<p>保证读操作的安全，只需要保证并发读时没有写操作在进行就行。在这种场景下就需要一种特殊类型的锁，即允许多个只读操作并行执行，但写操作会完全互斥。这种锁称之为多读单写锁（multiple readers, single writer lock），简称读写锁。读写锁分为读锁和写锁，读锁允许同时执行，但写锁是互斥的。</p>
<p><code>sync.RWMutex</code>读写锁是基于<code>sync.Mutex</code>实现的，读写锁的特点是针对读写操作的互斥锁，读写锁与互斥锁最大不同之处在于分别对读、写进行了锁定。一般用在大量读操作少量写操作中。</p>
<ul>
<li>同时只能具有一个<code>goroutine</code>能够获得写锁定</li>
<li>同时可以具有任意多个<code>goroutine</code>获得读锁定</li>
<li>同时只能存在写锁定或读锁定，即读和写互斥。</li>
</ul>
<p>换句话说</p>
<ul>
<li>当只有一个<code>goroutine</code>获得写锁定时，其它无论是读锁定还是写锁定都将会阻塞直到写解锁。</li>
<li>当只有一个<code>goroutine</code>获得读锁定时，其它读锁定仍然可以继续执行。</li>
<li>当有一个或多个读锁定时，写锁定将等待所有读锁定解锁之后才能进行写锁定。</li>
</ul>
<p>这里所谓的读锁定（RLock）目的是为了告诉写锁定（Lock），此时有很多人正在读取数据，写锁定需要排队等待。</p>
<p>一般来说，读写锁会分为几种情况：</p>
<ul>
<li>读锁之间不互斥，在没有写锁的情况下，读锁是无堵塞的，多个<code>goroutine</code>可以同时获得读锁。</li>
<li>写锁之间是互斥的，当存在写锁时，其它写锁会阻塞。</li>
<li>写锁与读锁互斥，若存在读锁则写锁阻塞，若存在写锁则读锁阻塞。</li>
</ul>
<p>Go标准库<code>sync.RWMutex</code>读写互斥锁提供了四个方法</p>
<table>
<thead>
<tr>
<th>读写互斥锁</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Lock</td>
<td>添加写锁</td>
</tr>
<tr>
<td>Unlock</td>
<td>释放写锁</td>
</tr>
<tr>
<td>RLock</td>
<td>添加读锁</td>
</tr>
<tr>
<td>RUnlock</td>
<td>释放读锁</td>
</tr>
</tbody>
</table>
<h2 id="并发编程-select-switch">并发编程-&gt;select switch<a hidden class="anchor" aria-hidden="true" href="#并发编程-select-switch">#</a></h2>
<p>1.select是Go中的一个控制结构，类似于switch语句，用于处理异步IO操作。select会监听case语句中channel的读写操作，当case中channel读写操作为非阻塞状态（即能读写）时，将会触发相应的动作。</p>
<blockquote>
<p>select中的case语句必须是一个channel操作.
select中的default子句总是可运行的。</p>
</blockquote>
<p>2.如果有多个case都可以运行，select会随机公平地选出一个执行，其他不会执行。</p>
<p>3.如果没有可运行的case语句，且有default语句，那么就会执行default的动作。</p>
<p>4.如果没有可运行的case语句，且没有default语句，select将阻塞，直到某个case通信可以运行.</p>
<p>实例</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> Base
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> <span style="color:#5af78e">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">var</span> chanInt = <span style="color:#ff5c57">make</span>(<span style="color:#ff5c57">chan</span> <span style="color:#9aedfe">int</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">var</span> chanStr = <span style="color:#ff5c57">make</span>(<span style="color:#ff5c57">chan</span> <span style="color:#9aedfe">string</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Channel</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">go</span> <span style="color:#ff5c57">func</span>() {
</span></span><span style="display:flex;"><span>		chanInt <span style="color:#ff6ac1">&lt;-</span> <span style="color:#ff9f43">100</span>
</span></span><span style="display:flex;"><span>		chanStr <span style="color:#ff6ac1">&lt;-</span> <span style="color:#5af78e">&#34;Hello&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">defer</span> <span style="color:#ff5c57">close</span>(chanInt)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">defer</span> <span style="color:#ff5c57">close</span>(chanStr)
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">select</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">case</span> r <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">&lt;-</span>chanInt:
</span></span><span style="display:flex;"><span>			<span style="color:#ff5c57">println</span>(<span style="color:#5af78e">&#34;chanInt&#34;</span>, r)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">case</span> r <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">&lt;-</span>chanStr:
</span></span><span style="display:flex;"><span>			<span style="color:#ff5c57">println</span>(<span style="color:#5af78e">&#34;chanStr&#34;</span>, r)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">default</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#ff5c57">println</span>(<span style="color:#5af78e">&#34;default&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		time.<span style="color:#57c7ff">Sleep</span>(time.Second)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>default
chanInt 100
chanStr Hello
chanStr
chanStr
chanInt 0
chanInt 0
&hellip;&hellip;</p>
<h2 id="并发编程-timer">并发编程-&gt;Timer<a hidden class="anchor" aria-hidden="true" href="#并发编程-timer">#</a></h2>
<p>Timer顾名思义，就是定时器的意思，可以实现一些定时操作，内部也是通过channel来实现的。</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> Base
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Timer</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">// 第一种创建方式
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	timer <span style="color:#ff6ac1">:=</span> time.<span style="color:#57c7ff">NewTimer</span>(time.Second <span style="color:#ff6ac1">*</span> <span style="color:#ff9f43">2</span>)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(time.<span style="color:#57c7ff">Now</span>())
</span></span><span style="display:flex;"><span>	c <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">&lt;-</span>timer.C
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(c)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#78787e">//  相差两秒
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#78787e">//2022-09-13 11:28:25.6609052 +0800 +08 m=+0.004536701
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>	<span style="color:#78787e">//2022-09-13 11:28:27.6616643 +0800 +08 m=+2.005295801
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="并发编程-ticker">并发编程-&gt;Ticker<a hidden class="anchor" aria-hidden="true" href="#并发编程-ticker">#</a></h2>
<p>Timer只执行一次，TickerT可以周期的执行。</p>
<p>实例</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Ticker</span>() {
</span></span><span style="display:flex;"><span>	ticker <span style="color:#ff6ac1">:=</span> time.<span style="color:#57c7ff">NewTicker</span>(time.Second)
</span></span><span style="display:flex;"><span>	count <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> <span style="color:#ff6ac1">range</span> ticker.C {
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;ticker...&#34;</span>)
</span></span><span style="display:flex;"><span>		count<span style="color:#ff6ac1">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">if</span> count <span style="color:#ff6ac1">&gt;=</span> <span style="color:#ff9f43">5</span> {
</span></span><span style="display:flex;"><span>			ticker.<span style="color:#57c7ff">Stop</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">break</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="并发编程-原子变量">并发编程-&gt;原子变量<a hidden class="anchor" aria-hidden="true" href="#并发编程-原子变量">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> Base
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;sync/atomic&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">var</span> num <span style="color:#9aedfe">int64</span> = <span style="color:#ff9f43">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Add</span>(i <span style="color:#9aedfe">int64</span>) {
</span></span><span style="display:flex;"><span>	atomic.<span style="color:#57c7ff">AddInt64</span>(<span style="color:#ff6ac1">&amp;</span>i, <span style="color:#ff9f43">1</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Sub</span>(i <span style="color:#9aedfe">int64</span>) {
</span></span><span style="display:flex;"><span>	atomic.<span style="color:#57c7ff">AddInt64</span>(<span style="color:#ff6ac1">&amp;</span>i, <span style="color:#ff6ac1">-</span><span style="color:#ff9f43">1</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Atomic</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> ; num &lt; <span style="color:#ff9f43">1000</span>; num<span style="color:#ff6ac1">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">go</span> <span style="color:#57c7ff">Add</span>(num)
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">go</span> <span style="color:#57c7ff">Sub</span>(num)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	time.<span style="color:#57c7ff">Sleep</span>(time.Second <span style="color:#ff6ac1">*</span> <span style="color:#ff9f43">1</span>)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;Sum:&#34;</span>, num)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="advanced-level">Advanced level<a hidden class="anchor" aria-hidden="true" href="#advanced-level">#</a></h1>
<h2 id="fmt">fmt<a hidden class="anchor" aria-hidden="true" href="#fmt">#</a></h2>
<p><a href="https://www.bilibili.com/read/cv14519061/?from=readlist">https://www.bilibili.com/read/cv14519061/?from=readlist</a></p>
<h2 id="文件常见操作读写-os-io-bufio包">文件常见操作/读写 (os, io, bufio包)<a hidden class="anchor" aria-hidden="true" href="#文件常见操作读写-os-io-bufio包">#</a></h2>
<p><a href="https://www.bilibili.com/read/cv14586068/?from=readlist">https://www.bilibili.com/read/cv14586068/?from=readlist</a></p>
<h2 id="错误日志单元测试">错误/日志/单元测试<a hidden class="anchor" aria-hidden="true" href="#错误日志单元测试">#</a></h2>
<p>错误处理</p>
<p><img loading="lazy" src="base.assets/712443b1669e81a8d28523569312af3e12dbe8e1.png@1256w_256h_!web-article-pic.avif" alt="img"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">Errors</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">defer</span> <span style="color:#ff5c57">func</span>() {
</span></span><span style="display:flex;"><span>		err <span style="color:#ff6ac1">:=</span> <span style="color:#ff5c57">recover</span>()
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;捕捉到了错误:&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>	err1 <span style="color:#ff6ac1">:=</span> errors.<span style="color:#57c7ff">New</span>(<span style="color:#5af78e">&#34;可爱的错误&#34;</span>)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;err1=&#34;</span>, err1)
</span></span><span style="display:flex;"><span>	err2 <span style="color:#ff6ac1">:=</span> fmt.<span style="color:#57c7ff">Errorf</span>(<span style="color:#5af78e">&#34;%s的错误&#34;</span>, <span style="color:#5af78e">&#34;温柔&#34;</span>)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#57c7ff">Println</span>(<span style="color:#5af78e">&#34;err2=&#34;</span>, err2)
</span></span><span style="display:flex;"><span>	<span style="color:#ff5c57">panic</span>(err1)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="单元测试-1">单元测试<a hidden class="anchor" aria-hidden="true" href="#单元测试-1">#</a></h3>
<p>6.10.1 命名规范</p>
<p>文件名: xxx_test.go (通常xxx为被测试文件名)</p>
<p>6.10.2 测试函数</p>
<p>测试函数: func TestXxx(*testing.T) (通常Xxx为被测试函数名)</p>
<p>性能测试函数: func BenchmarkXxx(*testing.B) (通常Xxx为被测试函数名)</p>
<p>6.10.3 testing.T与testing.B</p>
<p>testing.T与testing.B是testing包定义的结构体，下面简称t与b</p>
<p><img loading="lazy" src="base.assets/b8950c14a871cc5bed9198ad1fe126786f372a8d.png@1256w_784h_!web-article-pic.avif" alt="img"  />
</p>
<p>6.10.4 测试命令(go mod下)</p>
<p>项目名可以简写为&rdquo;.&quot;，下面同一为&quot;.&quot;</p>
<p>测试指定包: go test ./文件夹路径</p>
<p>将自动调用所有_test.go文件中的所有TestXxx函数</p>
<p>测试指定文件: go test ./文件夹路径/xxx_test.go ./go/文件夹路径/xxx.go</p>
<p>将自动调用xxx_test.go中的所有TestXxx函数</p>
<p>flag</p>
<p>flag可以写在 ./&hellip; 前也可以写在 ./&hellip; 之后</p>
<p>也运行BenchmarkXxx函数: go test -bench ./…</p>
<p>详细输出(verbose): go test -v ./…</p>
<p>即使运行成功也输出日志</p>
<p>规定测试时间: go test -benchtime XhXmXs ./…</p>
<p>规定测试次数: go test -benchtime  Nx ./…</p>
<p>指定测试cpu数量: go test -cpu N ./…</p>
<p>指定测试函数: go test -run  TestXxx ./…</p>
<p>只测试TestXxx函数</p>
<p>超时限制: go test -timeout XhXmXs ./…</p>
<p>默认限制为10min</p>
<p>打印测试的内存使用统计: go test -benchmem ./…</p>
<p>作者：FangChannel <a href="https://www.bilibili.com/read/cv14614760/?from=readlist">https://www.bilibili.com/read/cv14614760/?from=readlist</a> 出处：bilibili</p>
<h2 id="for-range-1">for range<a hidden class="anchor" aria-hidden="true" href="#for-range-1">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff6ac1">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#5af78e">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#5af78e">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">type</span>  Detail <span style="color:#ff5c57">struct</span>{
</span></span><span style="display:flex;"><span>  Rid <span style="color:#9aedfe">int</span>
</span></span><span style="display:flex;"><span>  TeamName <span style="color:#9aedfe">string</span>
</span></span><span style="display:flex;"><span>  Member <span style="color:#9aedfe">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">type</span> TeamMember <span style="color:#ff5c57">struct</span>{
</span></span><span style="display:flex;"><span>  Rid <span style="color:#9aedfe">int</span>
</span></span><span style="display:flex;"><span>  Member <span style="color:#9aedfe">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">func</span> <span style="color:#57c7ff">main</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  d1<span style="color:#ff6ac1">:=</span>Detail{
</span></span><span style="display:flex;"><span>    Rid: <span style="color:#ff9f43">10</span>,
</span></span><span style="display:flex;"><span>    TeamName: <span style="color:#5af78e">&#34;ddd10&#34;</span>,
</span></span><span style="display:flex;"><span>    Member: <span style="color:#5af78e">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  d2<span style="color:#ff6ac1">:=</span>Detail{
</span></span><span style="display:flex;"><span>    Rid: <span style="color:#ff9f43">11</span>,
</span></span><span style="display:flex;"><span>    TeamName: <span style="color:#5af78e">&#34;ddd11&#34;</span>,
</span></span><span style="display:flex;"><span>    Member: <span style="color:#5af78e">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  d3<span style="color:#ff6ac1">:=</span>Detail{
</span></span><span style="display:flex;"><span>    Rid: <span style="color:#ff9f43">12</span>,
</span></span><span style="display:flex;"><span>    TeamName: <span style="color:#5af78e">&#34;ddd12&#34;</span>,
</span></span><span style="display:flex;"><span>    Member: <span style="color:#5af78e">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  t1<span style="color:#ff6ac1">:=</span>TeamMember{
</span></span><span style="display:flex;"><span>    Rid: <span style="color:#ff9f43">10</span>,
</span></span><span style="display:flex;"><span>    Member: <span style="color:#5af78e">&#34;10的Member&#34;</span>,
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#ff5c57">var</span> ds []Detail
</span></span><span style="display:flex;"><span>  ds = <span style="color:#ff5c57">append</span>(ds,d1,d2,d3)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff5c57">var</span> ts []TeamMember
</span></span><span style="display:flex;"><span>  ts = <span style="color:#ff5c57">append</span>(ts, t1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  fmt.<span style="color:#57c7ff">Println</span>(ts)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  fmt.<span style="color:#57c7ff">Println</span>(ds)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">for</span> i <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">0</span>; i &lt; <span style="color:#ff5c57">len</span>(ds); i<span style="color:#ff6ac1">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">for</span> j <span style="color:#ff6ac1">:=</span> <span style="color:#ff9f43">0</span>; j &lt; <span style="color:#ff5c57">len</span>(ts); j<span style="color:#ff6ac1">++</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">if</span> ds[i].Rid <span style="color:#ff6ac1">==</span> ts[j].Rid {
</span></span><span style="display:flex;"><span>				ds[i].Member = ts[j].Member
</span></span><span style="display:flex;"><span>				<span style="color:#ff6ac1">break</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#78787e">// ==== ?? ====
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">for</span> _, v <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">range</span> ds {
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">for</span> _, v2 <span style="color:#ff6ac1">:=</span> <span style="color:#ff6ac1">range</span> ts {
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">if</span> v.Rid <span style="color:#ff6ac1">==</span> v2.Rid {
</span></span><span style="display:flex;"><span>                v.member = v2.menber
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  fmt.<span style="color:#57c7ff">Println</span>(ts)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  fmt.<span style="color:#57c7ff">Println</span>(ds)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>

        </div>
        <div class="post-reward">
            <div style="padding: 0 0 0 0; margin: 0 0 0 0; width: 100%; font-size:16px; text-align: center;">
                <div id="QR" style="opacity: 0;">
                    <div id="wechat" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="wechat_qr" src="https://Bin-lin-rgb.github.io/img/wechat_pay.png" alt="wechat_pay"></a>
                        <p>微信</p>
                    </div>
                    <div id="alipay" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="alipay_qr" src="https://Bin-lin-rgb.github.io/img/alipay.png" alt="alipay"></a>
                        <p>支付宝</p>
                    </div>
                </div>
                <button id="rewardButton"
                        onclick="
                    var qr = document.getElementById('QR');
                    if (qr.style.opacity === '0') {
                        qr.style.opacity='1';
                    } else {
                        qr.style.opacity='0'
                    }"
                >
                    <span>🧧 鼓励</span>
                </button>
            </div>
        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="next" href="https://Bin-lin-rgb.github.io/posts/basics/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80%E7%AF%87/">
    <span class="title">下一页 »</span>
    <br>
    <span>计算机网络之基础篇</span>
  </a>
</nav>

        </footer>
    </div>

<style>
    .comments_details summary::marker {
        font-size: 20px;
        content: '👉展开评论';
        color: var(--content);
    }
    .comments_details[open] summary::marker{
        font-size: 20px;
        content: '👇关闭评论';
        color: var(--content);
    }
</style>


<div>
    <details class="comments_details">
        <summary style="cursor: pointer; margin: 50px 0 20px 0;width: 130px;">
            <span style="font-size: 20px;color: var(--content);">...</span>
        </summary>
        <div id="tcomment"></div>
    </details>
    <script src="https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js">
    </script>
    <script>
        twikoo.init({
            envId: 'https://twikoo-api-nine-silk.vercel.app/',
            el: "#tcomment",
            lang: 'zh-CN',
            region: 'ap-guangzhou',
            path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
        })
    
    
    
    
    
    
    
    </script>
</div>
</article>
</main>

<footer class="footer">
    <span>
        Copyright
        &copy;
        2021-2023
        <a href="https://Bin-lin-rgb.github.io/" style="color:#939393;">Blaine&#39;s Blog</a>
        All Rights Reserved
    </span>
    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;">备案号</a>&nbsp;
    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"
           style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="%e5%85%ac%e5%ae%89%e5%9b%be%e6%a0%87%e9%93%be%e6%8e%a5" style="float:left;margin: 0px 5px 0px 0px;"/>
            公网安备
        </a>
    </span>
    <span id="busuanzi_container">
        <span class="fa fa-user"></span> <span id="busuanzi_value_site_uv"></span>
        <span class="fa fa-eye"></span> <span id="busuanzi_value_site_pv"></span>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
</script>
<script>
    let mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        (function() {
            document.cookie = "change-themes" + "="+ escape ("false");
        })()

        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    });
</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"Blaine's Blog"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"Blaine's Blog"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;
        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = '复制';

        function copyingDone() {
            copybutton.innerText = '已复制！';
            setTimeout(() => {
                copybutton.innerText = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\n————————————————\r\n' +
                    '版权声明：本文为「'+"Blaine's Blog"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {}
            selection.removeRange(range);
        });

        let language = codeblock.className.replaceAll("language-", "")
        let macTool = document.createElement("div")
        let macTool1 = document.createElement("div")
        let macTool2 = document.createElement("div")
        let macTool3 = document.createElement("div")
        let languageType = document.createElement("div")
        languageType.innerText = language
        macTool.setAttribute('class', 'mac-tool')
        macTool1.setAttribute('class', 'mac bb1')
        macTool2.setAttribute('class', 'mac bb2')
        macTool3.setAttribute('class', 'mac bb3')
        languageType.setAttribute('class', 'language-type')
        macTool.appendChild(macTool1)
        macTool.appendChild(macTool2)
        macTool.appendChild(macTool3)
        macTool.appendChild(languageType)

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
            container.appendChild(macTool)
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        }
    });
</script>
</body>

</html>
